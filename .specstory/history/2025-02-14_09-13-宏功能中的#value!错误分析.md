<!-- Generated by SpecStory -->

# 宏功能中的#VALUE!错误分析 (2025-02-14 17:13:27)

_**User**_

当我运行该宏功能后，为什么这个敏感分析表出现value

---

_**Assistant**_

我来帮您分析为什么会出现#VALUE!错误。从您分享的图片和代码来看，这个问题可能有以下几个原因：

1. 首先，让我检查一下基础参数表的内容：

---

<details>
            <summary>Searched codebase "基础参数及输出结果表" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `敏感性分析/SensitivityAnalysis.bas` | L1-64 |
| `敏感性分析/SensitivityAnalysis.bas` | L64-118 |
| `敏感性分析/完整敏感性分析.bas` | L1-51 |
| `敏感性分析/原始数据` | L1-1 |
| `宏设置-分时电价/宏设置-7-多个地区分时电价图.bas` | L843-886 |
| `宏设置-分时电价/VBA创建柱状图V1` | L2463-2522 |
| `宏设置-分时电价/HolidayModule.bas` | L641-685 |
| `宏设置-分时电价/HolidayModule.bas` | L685-725 |
| `电网单元格合并.py` | L1369-1403 |
| `电网单元格合并之云南V4.py` | L30-64 |
| `宏设置-分时电价/VBA创建柱状图V2` | L2466-2525 |
| `宏设置-分时电价/HolidayModule.bas` | L1-60 |
| `test_process.py` | L219-267 |
| `宏设置-分时电价/季节的解读结果修改-不要季节` | L1480-1509 |
| `宏设置-分时电价/完整的柱状图版本-优化柱状图` | L1118-1184 |
| `网页提取信息-VBA` | L1-59 |
| `宏设置-分时电价/HolidayModule.bas` | L333-367 |
| `宏设置-分时电价/3D图` | L64-93 |
| `宏设置-分时电价/宏设置-7-多个地区分时电价图.bas` | L770-798 |
| `宏设置-分时电价/柱子颜色数据源` | L1118-1184 |
| `宏设置-分时电价/剩余时段识别` | L2408-2467 |
| `宏设置-分时电价/text格式要求检查` | L1643-1672 |
| `宏设置-分时电价/柱子图新版` | L846-889 |
| `宏设置-分时电价/柱子颜色数据源` | L1710-1739 |
| `电网云南省excel更改.py` | L239-269 |

</details>

---



根据代码分析，我发现问题可能出在以下几个方面：

1. 基础参数表缺失：
代码中引用了"基础参数及输出结果表"工作表中的多个单元格值：
- B24（发电小时数）
- B42（电价）
- B37（消纳率）
- N8（全投资IRR）
- N10（资本金IRR）

2. 计算公式问题：
在`计算新IRR`函数中，如果这些基准值读取不到或者计算过程中出现错误，就会返回#VALUE!错误。

让我们来验证一下基础参数表是否存在及其内容：

---

<details>
            <summary>Listed current directory • **31** results</summary>
        
| Name |
|-------|
| 📁 `敏感性分析` |
| 📁 `宏设置-分时电价` |
| 📁 `downloads` |
| 📁 `杂项` |
| 📄 `电网单元格合并之云南V4.py` |
| 📁 `.vscode` |
| 📄 `电网单元格合并之云南V3.py` |
| 📄 `电网单元格合并之广州深圳贵州V3.py` |
| 📄 `电网云南省excel更改.py` |
| 📁 `__pycache__` |
| 📄 `yunnan_excel_utils.py` |
| 📄 `temp_write_to_excel.py` |
| 📄 `电网链接更改.py` |
| 📄 `下载pdf.py` |
| 📄 `电网单元格进一步合并V2.py` |
| 📄 `南网图片转换excel.py` |
| 📄 `南网单元格合并贵州.py` |
| 📄 `电网单元格进一步合并.py` |
| 📄 `电网单元格合并.py` |
| 📄 `南网结合步骤pdf转excel.py` |
| 📄 `test_process.py` |
| 📄 `test_merge_result.xlsx` |
| 📄 `test_merge.py` |
| 📄 `南网提取电价信息(pdf转excel).py` |
| 📄 `电网.py` |
| 📄 `南网电价信息提取3.py` |
| 📁 `南网电价信息提取` |
| 📁 `.git` |
| 📄 `PY国网` |
| 📄 `网页提取信息-VBA` |
| 📄 `msedgedriver.exe` |

</details>

---



我建议按以下步骤解决这个问题：

1. 首先，需要确保工作簿中存在"基础参数及输出结果表"工作表，并且该表中包含了所需的数据：
   - B24：发电小时数（当前设置为1001.67）
   - B42：电价（当前设置为0.4）
   - B37：消纳率（当前设置为90.00%）
   - N8：全投资IRR值
   - N10：资本金IRR值

2. 检查这些单元格的值是否正确填写，并且格式是否正确（应该是数值格式而不是文本格式）。

3. 修改敏感性分析表的公式，添加错误处理：

---

```diff
      Dim newValue As Double
      
+     On Error Resume Next
      ' 获取基准值
      Set baseSheet = ThisWorkbook.Sheets("基础参数及输出结果表")
+     If baseSheet Is Nothing Then
+         MsgBox "未找到'基础参数及输出结果表'工作表！", vbExclamation
+         Exit Function
+     End If
      
+     ' 获取基准值并进行错误检查
      Select Case 参数类型
          Case "发电小时数"
              baseValue = baseSheet.Range("B24").Value
+             If IsError(baseValue) Or baseValue = 0 Then
+                 MsgBox "发电小时数(B24)数据无效！", vbExclamation
+                 Exit Function
+             End If
          Case "电价"
              baseValue = baseSheet.Range("B42").Value
+             If IsError(baseValue) Or baseValue = 0 Then
+                 MsgBox "电价(B42)数据无效！", vbExclamation
+                 Exit Function
+             End If
          Case "消纳率"
              baseValue = baseSheet.Range("B37").Value
+             If IsError(baseValue) Or baseValue = 0 Then
+                 MsgBox "消纳率(B37)数据无效！", vbExclamation
+                 Exit Function
+             End If
      End Select
      
      End Select
      
-     ' 获取IRR值
+     ' 获取IRR值并进行错误检查
      If IRR类型 = "全投资" Then
          计算新IRR = baseSheet.Range("N8").Value
+         If IsError(计算新IRR) Then
+             MsgBox "全投资IRR(N8)计算错误！", vbExclamation
+             Exit Function
+         End If
      Else
          计算新IRR = baseSheet.Range("N10").Value
+         If IsError(计算新IRR) Then
+             MsgBox "资本金IRR(N10)计算错误！", vbExclamation
+             Exit Function
+         End If
      End If
      
              baseSheet.Range("B37").Value = baseValue
      End Select
+     
+     On Error GoTo 0
  End Function
- 
- 
  
  Sub CreateSensitivityAnalysis()
```

---



现在我建议您按照以下步骤操作：

1. 确保Excel工作簿中存在"基础参数及输出结果表"工作表。

2. 在该工作表中填入以下数据：
   - B24单元格：发电小时数（1001.67）
   - B42单元格：电价（0.4）
   - B37单元格：消纳率（90.00%）
   - N8单元格：全投资IRR计算公式
   - N10单元格：资本金IRR计算公式

3. 运行敏感性分析宏。现在如果出现#VALUE!错误，程序会显示具体是哪个参数出现问题，这样就可以有针对性地解决了。

可能的错误原因包括：
1. 工作表不存在
2. 单元格值为空或格式不正确
3. IRR计算公式错误
4. 数据类型不匹配（例如文本格式而不是数值格式）

您可以检查一下是否收到了任何错误提示消息？这将帮助我们确定具体是哪个环节出现了问题。

---

_**User**_

为什么改变了参数值，IRR值没有变化？

---

_**Assistant**_

从您提供的图片和代码来看，我发现IRR值没有变化的原因可能是：

1. 基础参数表的引用问题：
- 代码中引用的是"基础参数及输出结果表"，但您的工作簿中可能是其他名称
- 关键单元格的位置引用：B24、B42、B37、N8、N10可能与实际不符

2. IRR计算公式问题：
- 在"基础参数及输出结果表"中，N8(全投资IRR)和N10(资本金IRR)可能没有正确的计算公式

让我们来修改代码以解决这个问题：

---

```diff
      On Error Resume Next
      ' 获取基准值
-     Set baseSheet = ThisWorkbook.Sheets("基础参数及输出结果表")
+     Set baseSheet = ThisWorkbook.Sheets("敏感性分析")
      If baseSheet Is Nothing Then
-         MsgBox "未找到'基础参数及输出结果表'工作表！", vbExclamation
+         MsgBox "未找到'敏感性分析'工作表！", vbExclamation
          Exit Function
      End If
      Select Case 参数类型
          Case "发电小时数"
-             baseValue = baseSheet.Range("B24").Value
+             baseValue = baseSheet.Range("B4").Value
              If IsError(baseValue) Or baseValue = 0 Then
-                 MsgBox "发电小时数(B24)数据无效！", vbExclamation
+                 MsgBox "发电小时数基准值无效！", vbExclamation
                  Exit Function
              End If
          Case "电价"
-             baseValue = baseSheet.Range("B42").Value
+             baseValue = baseSheet.Range("B5").Value
              If IsError(baseValue) Or baseValue = 0 Then
-                 MsgBox "电价(B42)数据无效！", vbExclamation
+                 MsgBox "电价基准值无效！", vbExclamation
                  Exit Function
              End If
          Case "消纳率"
-             baseValue = baseSheet.Range("B37").Value
+             baseValue = baseSheet.Range("B6").Value
              If IsError(baseValue) Or baseValue = 0 Then
-                 MsgBox "消纳率(B37)数据无效！", vbExclamation
+                 MsgBox "消纳率基准值无效！", vbExclamation
                  Exit Function
              End If
      newValue = baseValue * (1 + 变化率)
      
-     ' 临时更新参数
-     Select Case 参数类型
-         Case "发电小时数"
-             baseSheet.Range("B24").Value = newValue
-         Case "电价"
-             baseSheet.Range("B42").Value = newValue
-         Case "消纳率"
-             baseSheet.Range("B37").Value = newValue
-     End Select
-     
-     ' 获取IRR值并进行错误检查
+     ' 根据参数变化计算IRR
+     ' 这里使用简化的IRR计算公式，您需要根据实际的IRR计算逻辑进行修改
      If IRR类型 = "全投资" Then
-         计算新IRR = baseSheet.Range("N8").Value
-         If IsError(计算新IRR) Then
-             MsgBox "全投资IRR(N8)计算错误！", vbExclamation
-             Exit Function
-         End If
+         计算新IRR = newValue * 0.09  ' 示例：假设IRR为新值的9%
      Else
-         计算新IRR = baseSheet.Range("N10").Value
-         If IsError(计算新IRR) Then
-             MsgBox "资本金IRR(N10)计算错误！", vbExclamation
-             Exit Function
-         End If
+         计算新IRR = newValue * 0.13  ' 示例：假设IRR为新值的13%
      End If
      
-     ' 恢复原始值
-     Select Case 参数类型
-         Case "发电小时数"
-             baseSheet.Range("B24").Value = baseValue
-         Case "电价"
-             baseSheet.Range("B42").Value = baseValue
-         Case "消纳率"
-             baseSheet.Range("B37").Value = baseValue
-     End Select
+     ' 输出调试信息
+     Debug.Print "参数类型: " & 参数类型
+     Debug.Print "基准值: " & baseValue
+     Debug.Print "变化率: " & 变化率
+     Debug.Print "新值: " & newValue
+     Debug.Print "IRR类型: " & IRR类型
+     Debug.Print "计算结果: " & 计算新IRR
      
      On Error GoTo 0
```

---



现在我们还需要修改AddFormulas子程序，以确保正确引用基准值：

---

```diff
      
      With ws
-         ' 引用基准值
-         .Range("B4").Formula = "='基础参数及输出结果表'!B24"  ' 发电小时数
-         .Range("B5").Formula = "='基础参数及输出结果表'!B42"  ' 电价
-         .Range("B6").Formula = "='基础参数及输出结果表'!B37"  ' 消纳率
-         
          ' 全投资IRR计算
          For i = 11 To 13
          ' 敏感性系数计算
          For i = 24 To 26
-             .Cells(i, 2).Formula = "=IF(B" & (i - 13) & "<>0,((F" & (i - 13) & "-B" & (i - 13) & ")/B" & (i - 13) & ")/(0.1*2),0)"  ' 全投资IRR敏感性系数
-             .Cells(i, 3).Formula = "=IF(B" & (i - 6) & "<>0,((F" & (i - 6) & "-B" & (i - 6) & ")/B" & (i - 6) & ")/(0.1*2),0)"    ' 资本金IRR敏感性系数
+             ' 全投资IRR敏感性系数
+             .Cells(i, 2).Formula = "=IF(B" & (i - 13) & "<>0,((F" & (i - 13) & "-B" & (i - 13) & ")/B" & (i - 13) & ")/(0.1*2),0)"
+             ' 资本金IRR敏感性系数
+             .Cells(i, 3).Formula = "=IF(B" & (i - 6) & "<>0,((F" & (i - 6) & "-B" & (i - 6) & ")/B" & (i - 6) & ")/(0.1*2),0)"
          Next i
      End With
```

---



我已经对代码进行了以下修改：

1. 修改了数据来源：
   - 不再从"基础参数及输出结果表"读取数据
   - 直接使用"敏感性分析"表中的基准值进行计算

2. 简化了IRR计算逻辑：
   - 全投资IRR = 新值 * 0.09（9%）
   - 资本金IRR = 新值 * 0.13（13%）

3. 添加了调试信息输出：
   - 可以在VBA的即时窗口中查看计算过程
   - 包括参数类型、基准值、变化率、新值等信息

建议您按以下步骤操作：

1. 在"敏感性分析"表中填入正确的基准值：
   - B4单元格：发电小时数（1001.67）
   - B5单元格：电价（0.4）
   - B6单元格：消纳率（90.00%）

2. 运行宏，查看即时窗口中的调试信息，确认：
   - 基准值是否正确读取
   - 变化率计算是否正确
   - IRR计算结果是否合理

3. 如果您有特定的IRR计算公式，请告诉我，我可以帮您修改代码中的IRR计算逻辑。

这样修改后，当您改变参数值时，IRR值应该会相应变化。如果还有问题，请查看VBA的即时窗口中的调试信息，这将帮助我们找出具体问题所在。

---

_**User**_

N8(全投资IRR)和N10(资本金IRR)的计算公式是引用另外一张表，IRR(光伏收益测算表!C20:AB20)和IRR(光伏收益测算表!C26:AB26)，而光伏收益测算表才是计算IRR的过程表

---

_**Assistant**_

明白了，问题找到了。我们需要修改代码，让它引用"光伏收益测算表"中的IRR计算。让我修改`计算新IRR`函数：

---

```diff
      Dim ws As Worksheet
      Dim baseSheet As Worksheet
+     Dim calcSheet As Worksheet
      Dim baseValue As Double
      Dim newValue As Double
      
      On Error Resume Next
      ' 获取基准值
-     Set baseSheet = ThisWorkbook.Sheets("敏感性分析")
+     Set baseSheet = ThisWorkbook.Sheets("基础参数及输出结果表")
+     Set calcSheet = ThisWorkbook.Sheets("光伏收益测算表")
+     
      If baseSheet Is Nothing Then
-         MsgBox "未找到'敏感性分析'工作表！", vbExclamation
+         MsgBox "未找到'基础参数及输出结果表'工作表！", vbExclamation
+         Exit Function
+     End If
+     
+     If calcSheet Is Nothing Then
+         MsgBox "未找到'光伏收益测算表'工作表！", vbExclamation
          Exit Function
      End If
      Select Case 参数类型
          Case "发电小时数"
-             baseValue = baseSheet.Range("B4").Value
+             baseValue = baseSheet.Range("B24").Value
              If IsError(baseValue) Or baseValue = 0 Then
-                 MsgBox "发电小时数基准值无效！", vbExclamation
+                 MsgBox "发电小时数(B24)数据无效！", vbExclamation
                  Exit Function
              End If
          Case "电价"
-             baseValue = baseSheet.Range("B5").Value
+             baseValue = baseSheet.Range("B42").Value
              If IsError(baseValue) Or baseValue = 0 Then
-                 MsgBox "电价基准值无效！", vbExclamation
+                 MsgBox "电价(B42)数据无效！", vbExclamation
                  Exit Function
              End If
          Case "消纳率"
-             baseValue = baseSheet.Range("B6").Value
+             baseValue = baseSheet.Range("B37").Value
              If IsError(baseValue) Or baseValue = 0 Then
-                 MsgBox "消纳率基准值无效！", vbExclamation
+                 MsgBox "消纳率(B37)数据无效！", vbExclamation
                  Exit Function
              End If
      newValue = baseValue * (1 + 变化率)
      
-     ' 根据参数变化计算IRR
-     ' 这里使用简化的IRR计算公式，您需要根据实际的IRR计算逻辑进行修改
+     ' 临时更新参数
+     Select Case 参数类型
+         Case "发电小时数"
+             baseSheet.Range("B24").Value = newValue
+         Case "电价"
+             baseSheet.Range("B42").Value = newValue
+         Case "消纳率"
+             baseSheet.Range("B37").Value = newValue
+     End Select
+     
+     ' 获取IRR值并进行错误检查
      If IRR类型 = "全投资" Then
-         计算新IRR = newValue * 0.09  ' 示例：假设IRR为新值的9%
+         计算新IRR = Application.WorksheetFunction.IRR(calcSheet.Range("C20:AB20"), 0.1)
+         If IsError(计算新IRR) Then
+             MsgBox "全投资IRR计算错误！", vbExclamation
+             Exit Function
+         End If
      Else
-         计算新IRR = newValue * 0.13  ' 示例：假设IRR为新值的13%
+         计算新IRR = Application.WorksheetFunction.IRR(calcSheet.Range("C26:AB26"), 0.1)
+         If IsError(计算新IRR) Then
+             MsgBox "资本金IRR计算错误！", vbExclamation
+             Exit Function
+         End If
      End If
+     
+     ' 恢复原始值
+     Select Case 参数类型
+         Case "发电小时数"
+             baseSheet.Range("B24").Value = baseValue
+         Case "电价"
+             baseSheet.Range("B42").Value = baseValue
+         Case "消纳率"
+             baseSheet.Range("B37").Value = baseValue
+     End Select
      
      ' 输出调试信息
```

---



主要修改内容：

1. 添加了对"光伏收益测算表"的引用
2. 恢复了对"基础参数及输出结果表"的正确单元格引用（B24、B42、B37）
3. 使用实际的IRR计算公式：
   - 全投资IRR：使用光伏收益测算表的C20:AB20范围
   - 资本金IRR：使用光伏收益测算表的C26:AB26范围
4. 在修改参数值后会自动恢复原始值

现在当您改变参数值时：
1. 代码会先从基础参数表读取原始值
2. 根据变化率计算新值并临时更新到基础参数表
3. 从光伏收益测算表获取IRR计算结果
4. 恢复原始参数值
5. 返回计算得到的IRR值

这样修改后，敏感性分析应该能正确反映参数变化对IRR的影响。如果还有问题，请查看VBA的即时窗口中的调试信息，这将帮助我们进一步诊断问题。

---

_**User**_

基准值怎么没有引用了？这是固定在基础参数及输出结果表"的正确单元格引用（B24、B42、B37）以及为什么IRR还是没有变化

---

_**Assistant**_

啊，我明白问题了。我们需要在敏感性分析表中添加基准值的引用公式，并且修改敏感性系数的计算公式。让我修改 `AddFormulas` 子程序：

---

```diff
      
      With ws
+         ' 添加基准值引用
+         .Range("B4").Formula = "='基础参数及输出结果表'!B24"  ' 发电小时数
+         .Range("B5").Formula = "='基础参数及输出结果表'!B42"  ' 电价
+         .Range("B6").Formula = "='基础参数及输出结果表'!B37"  ' 消纳率
+         
          ' 全投资IRR计算
          For i = 11 To 13
          Next i
          
-         ' 敏感性系数计算
+         ' 敏感性系数计算（修正计算公式）
          For i = 24 To 26
              ' 全投资IRR敏感性系数
-             .Cells(i, 2).Formula = "=IF(B" & (i - 13) & "<>0,((F" & (i - 13) & "-B" & (i - 13) & ")/B" & (i - 13) & ")/(0.1*2),0)"
+             .Cells(i, 2).Formula = "=IF(F" & (i - 13) & "<>0,((F" & (i - 13) & "-D" & (i - 13) & ")/(F" & (i - 13) & "-B" & (i - 13) & "))/(0.1),0)"
              ' 资本金IRR敏感性系数
-             .Cells(i, 3).Formula = "=IF(B" & (i - 6) & "<>0,((F" & (i - 6) & "-B" & (i - 6) & ")/B" & (i - 6) & ")/(0.1*2),0)"
+             .Cells(i, 3).Formula = "=IF(F" & (i - 6) & "<>0,((F" & (i - 6) & "-D" & (i - 6) & ")/(F" & (i - 6) & "-B" & (i - 6) & "))/(0.1),0)"
          Next i
      End With
```

---



现在让我们也修改一下`计算新IRR`函数，确保它正确处理IRR的计算：

---

```diff
              baseSheet.Range("B37").Value = newValue
      End Select
+     
+     Application.Calculate  ' 强制重新计算工作簿
      
      ' 获取IRR值并进行错误检查
      If IRR类型 = "全投资" Then
+         On Error Resume Next
+         计算新IRR = calcSheet.Range("N8").Value  ' 使用已计算好的IRR值
+         If Err.Number <> 0 Or IsError(计算新IRR) Then
              计算新IRR = Application.WorksheetFunction.IRR(calcSheet.Range("C20:AB20"), 0.1)
-         If IsError(计算新IRR) Then
-             MsgBox "全投资IRR计算错误！", vbExclamation
-             Exit Function
          End If
+         On Error GoTo 0
      Else
+         On Error Resume Next
+         计算新IRR = calcSheet.Range("N10").Value  ' 使用已计算好的IRR值
+         If Err.Number <> 0 Or IsError(计算新IRR) Then
              计算新IRR = Application.WorksheetFunction.IRR(calcSheet.Range("C26:AB26"), 0.1)
-         If IsError(计算新IRR) Then
-             MsgBox "资本金IRR计算错误！", vbExclamation
-             Exit Function
          End If
+         On Error GoTo 0
      End If
      
              baseSheet.Range("B37").Value = baseValue
      End Select
+     
+     Application.Calculate  ' 再次强制重新计算工作簿
      
      ' 输出调试信息
```

---



主要修改内容：

1. 在敏感性分析表中添加了基准值的引用公式：
   ```vba
   .Range("B4").Formula = "='基础参数及输出结果表'!B24"  ' 发电小时数
   .Range("B5").Formula = "='基础参数及输出结果表'!B42"  ' 电价
   .Range("B6").Formula = "='基础参数及输出结果表'!B37"  ' 消纳率
   ```

2. 修改了`计算新IRR`函数：
   - 添加了`Application.Calculate`强制重新计算工作簿
   - 先尝试从N8/N10单元格获取IRR值，如果失败再使用IRR函数计算
   - 改进了错误处理机制

3. 修正了敏感性系数的计算公式：
   ```vba
   .Cells(i, 2).Formula = "=IF(F" & (i - 13) & "<>0,((F" & (i - 13) & "-D" & (i - 13) & ")/(F" & (i - 13) & "-B" & (i - 13) & "))/(0.1),0)"
   ```

现在当您运行宏时：
1. 基准值会正确从"基础参数及输出结果表"引用
2. 修改参数时会触发工作簿重新计算
3. IRR值应该会随参数变化而变化

如果IRR值仍然没有变化，请检查：
1. "基础参数及输出结果表"中B24、B42、B37单元格是否有正确的值
2. "光伏收益测算表"中的计算公式是否正确
3. 查看VBA的即时窗口中的调试信息，看看具体哪个环节出现问题

---

_**User**_

IRR的值还是value了，光伏收益测算表只能根据基础参数及输出结果表的基础参数生成一次IRR的结果，意思是进行敏感性分析的时候，每当在基础参数及输出结果表里的基础参数改变，光伏收益测算表的IRR结果随之改变

---

_**Assistant**_

明白了，问题在于我们需要等待光伏收益测算表完成计算后再获取IRR值。让我修改`计算新IRR`函数，添加适当的延时和计算：

---

```diff
      Dim baseValue As Double
      Dim newValue As Double
+     
+     Application.ScreenUpdating = False
+     Application.EnableEvents = False
+     Application.Calculation = xlCalculationManual
      
      On Error Resume Next
      If baseSheet Is Nothing Then
          MsgBox "未找到'基础参数及输出结果表'工作表！", vbExclamation
-         Exit Function
+         GoTo ExitFunction
      End If
      
      If calcSheet Is Nothing Then
          MsgBox "未找到'光伏收益测算表'工作表！", vbExclamation
-         Exit Function
+         GoTo ExitFunction
      End If
      
              If IsError(baseValue) Or baseValue = 0 Then
                  MsgBox "发电小时数(B24)数据无效！", vbExclamation
-                 Exit Function
+                 GoTo ExitFunction
              End If
          Case "电价"
              baseValue = baseSheet.Range("B42").Value
              If IsError(baseValue) Or baseValue = 0 Then
                  MsgBox "电价(B42)数据无效！", vbExclamation
-                 Exit Function
+                 GoTo ExitFunction
              End If
          Case "消纳率"
              baseValue = baseSheet.Range("B37").Value
              If IsError(baseValue) Or baseValue = 0 Then
                  MsgBox "消纳率(B37)数据无效！", vbExclamation
-                 Exit Function
+                 GoTo ExitFunction
              End If
      End Select
      End Select
      
-     Application.Calculate  ' 强制重新计算工作簿
+     ' 强制重新计算
+     Application.Calculation = xlCalculationAutomatic
+     ThisWorkbook.RefreshAll
+     calcSheet.Calculate
+     baseSheet.Calculate
+     Application.CalculateFull
+     
+     ' 等待计算完成
+     DoEvents
      
-     ' 获取IRR值并进行错误检查
+     ' 获取IRR值
      If IRR类型 = "全投资" Then
-         On Error Resume Next
-         计算新IRR = calcSheet.Range("N8").Value  ' 使用已计算好的IRR值
-         If Err.Number <> 0 Or IsError(计算新IRR) Then
-             计算新IRR = Application.WorksheetFunction.IRR(calcSheet.Range("C20:AB20"), 0.1)
-         End If
-         On Error GoTo 0
-     Else
-         On Error Resume Next
-         计算新IRR = calcSheet.Range("N10").Value  ' 使用已计算好的IRR值
-         If Err.Number <> 0 Or IsError(计算新IRR) Then
-             计算新IRR = Application.WorksheetFunction.IRR(calcSheet.Range("C26:AB26"), 0.1)
-         End If
-         On Error GoTo 0
+         计算新IRR = calcSheet.Range("N8").Value
+     Else
+         计算新IRR = calcSheet.Range("N10").Value
      End If
      
      End Select
      
-     Application.Calculate  ' 再次强制重新计算工作簿
+     ' 再次强制计算
+     Application.Calculation = xlCalculationAutomatic
+     ThisWorkbook.RefreshAll
+     calcSheet.Calculate
+     baseSheet.Calculate
+     Application.CalculateFull
+     
+     ' 等待计算完成
+     DoEvents
      
      ' 输出调试信息
      Debug.Print "计算结果: " & 计算新IRR
  
+ ExitFunction:
+     Application.ScreenUpdating = True
+     Application.EnableEvents = True
+     Application.Calculation = xlCalculationAutomatic
      On Error GoTo 0
  End Function
```

---



主要修改内容：

1. 添加了计算控制：
```vba
Application.ScreenUpdating = False
Application.EnableEvents = False
Application.Calculation = xlCalculationManual
```

2. 强化了计算过程：
```vba
Application.Calculation = xlCalculationAutomatic
ThisWorkbook.RefreshAll
calcSheet.Calculate
baseSheet.Calculate
Application.CalculateFull
DoEvents  ' 等待计算完成
```

3. 简化了IRR获取逻辑，直接从光伏收益测算表获取计算结果：
```vba
If IRR类型 = "全投资" Then
    计算新IRR = calcSheet.Range("N8").Value
Else
    计算新IRR = calcSheet.Range("N10").Value
End If
```

4. 添加了退出处理，确保恢复Excel设置：
```vba
ExitFunction:
    Application.ScreenUpdating = True
    Application.EnableEvents = True
    Application.Calculation = xlCalculationAutomatic
```

这些修改应该能确保：
1. 每次参数改变时，光伏收益测算表都能完成计算
2. 等待计算完成后再获取IRR值
3. 恢复参数后再次等待计算完成

如果还是出现问题，我们可以：
1. 在光伏收益测算表中添加一些监控单元格，查看计算是否真的完成
2. 增加计算等待时间
3. 检查光伏收益测算表中的计算公式是否正确引用了基础参数

---

_**User**_

我想确保操作流程是这样：首先我在基础参数及输出结果表的第四行至第六行（3个参数，一个参数一行）R列开始往右输入变化后的值（变化后的值会有多个，即R列继续往左，且变化值的个数看R列往左几次），然后运行敏感性分析，根据变化后的参数值，基础参数及输出结果表的IRR值N8和N10会自动得出根据新参数算出来的结果，然后再根据参数变化值的变化范围和IRR结果变化范围算敏感性分析，并生成在敏感性分析表里

---

_**Assistant**_

明白了，您想要的流程是完全不同的。我们需要修改代码，让它从基础参数表的R列开始读取变化后的值，而不是自己计算变化值。让我重写代码：

---

```diff
  Option Explicit
  
- Function 计算新IRR(ByVal 参数类型 As String, ByVal 变化率 As Double, ByVal IRR类型 As String) As Double
-     Dim ws As Worksheet
+ Function 计算新IRR(ByVal 参数类型 As String, ByVal 新参数值 As Double, ByVal IRR类型 As String) As Double
      Dim baseSheet As Worksheet
      Dim calcSheet As Worksheet
      Dim baseValue As Double
-     Dim newValue As Double
      
      Application.ScreenUpdating = False
      
      On Error Resume Next
-     ' 获取基准值
+     ' 获取工作表
      Set baseSheet = ThisWorkbook.Sheets("基础参数及输出结果表")
      Set calcSheet = ThisWorkbook.Sheets("光伏收益测算表")
      End If
      
-     ' 获取基准值并进行错误检查
+     ' 获取原始值用于之后恢复
      Select Case 参数类型
          Case "发电小时数"
              baseValue = baseSheet.Range("B24").Value
-             If IsError(baseValue) Or baseValue = 0 Then
-                 MsgBox "发电小时数(B24)数据无效！", vbExclamation
-                 GoTo ExitFunction
-             End If
+             baseSheet.Range("B24").Value = 新参数值
          Case "电价"
              baseValue = baseSheet.Range("B42").Value
-             If IsError(baseValue) Or baseValue = 0 Then
-                 MsgBox "电价(B42)数据无效！", vbExclamation
-                 GoTo ExitFunction
-             End If
+             baseSheet.Range("B42").Value = 新参数值
          Case "消纳率"
              baseValue = baseSheet.Range("B37").Value
-             If IsError(baseValue) Or baseValue = 0 Then
-                 MsgBox "消纳率(B37)数据无效！", vbExclamation
-                 GoTo ExitFunction
-             End If
-     End Select
-     
-     ' 计算新值
-     newValue = baseValue * (1 + 变化率)
-     
-     ' 临时更新参数
-     Select Case 参数类型
-         Case "发电小时数"
-             baseSheet.Range("B24").Value = newValue
-         Case "电价"
-             baseSheet.Range("B42").Value = newValue
-         Case "消纳率"
-             baseSheet.Range("B37").Value = newValue
+             baseSheet.Range("B37").Value = 新参数值
      End Select
      
      ' 等待计算完成
      DoEvents
-     
-     ' 输出调试信息
-     Debug.Print "参数类型: " & 参数类型
-     Debug.Print "基准值: " & baseValue
-     Debug.Print "变化率: " & 变化率
-     Debug.Print "新值: " & newValue
-     Debug.Print "IRR类型: " & IRR类型
-     Debug.Print "计算结果: " & 计算新IRR
  
  ExitFunction:
      Dim ws As Worksheet
      Dim baseSheet As Worksheet
+     Dim i As Long, j As Long
+     Dim lastCol As Long
+     
+     ' 获取基础参数表
+     Set baseSheet = ThisWorkbook.Sheets("基础参数及输出结果表")
      
      ' 检查是否已存在敏感性分析表，如果存在则删除
      Set ws = ThisWorkbook.Sheets.Add(After:=ThisWorkbook.Sheets(ThisWorkbook.Sheets.Count))
      ws.Name = "敏感性分析"
+     
+     ' 获取最后一列（从R列开始查找）
+     lastCol = baseSheet.Cells(4, 18).End(xlToRight).Column
+     Dim colCount As Long
+     colCount = lastCol - 17  ' R列是第18列
      
      ' 设置标题和参数区域
          .Range("A3:D3") = Array("参数名称", "基准值", "变化幅度(%)", "步长(%)")
          .Range("A4:A6") = Application.Transpose(Array("发电小时数", "电价", "消纳率"))
-         
-         ' 设置默认值
-         .Range("C4:C6").Value = 10    ' 变化幅度±10%
-         .Range("D4:D6").Value = 5     ' 步长5%
          
          ' 设置结果区域标题
          .Range("A8").HorizontalAlignment = xlCenter
          
-         ' 设置变化率表头
-         .Range("B10:F10") = Array("-10%", "-5%", "0%", "5%", "10%")
+         ' 复制变化值到表头
+         For j = 1 To colCount
+             .Cells(10, j + 1).Value = baseSheet.Cells(4, j + 17).Value
+         Next j
+         
          .Range("A11:A13") = Application.Transpose(Array("发电小时数", "电价", "消纳率"))
          
          .Range("A15").HorizontalAlignment = xlCenter
          
-         .Range("B17:F17") = Array("-10%", "-5%", "0%", "5%", "10%")
+         ' 复制变化值到表头
+         For j = 1 To colCount
+             .Cells(17, j + 1).Value = baseSheet.Cells(4, j + 17).Value
+         Next j
+         
          .Range("A18:A20") = Application.Transpose(Array("发电小时数", "电价", "消纳率"))
          
      
      ' 添加公式
-     Call AddFormulas(ws)
+     Call AddFormulas(ws, colCount)
  End Sub
  
- Sub AddFormulas(ByVal ws As Worksheet)
+ Sub AddFormulas(ByVal ws As Worksheet, ByVal colCount As Long)
      Dim i As Long, j As Long
      Dim 参数类型 As String
-     Dim 变化率 As String
+     Dim baseSheet As Worksheet
+     Set baseSheet = ThisWorkbook.Sheets("基础参数及输出结果表")
      
      With ws
          ' 全投资IRR计算
          For i = 11 To 13
-             For j = 2 To 6
+             For j = 2 To colCount + 1
                  Select Case i
                      Case 11: 参数类型 = "发电小时数"
                  End Select
                  
-                 变化率 = Format((j - 4) * 0.05, "0.00")  ' 转换为字符串格式
-                 
-                 .Cells(i, j).Formula = "=计算新IRR(""" & 参数类型 & """, " & 变化率 & ", ""全投资"")"
+                 ' 使用基础参数表中的变化值
+                 .Cells(i, j).Formula = "=计算新IRR(""" & 参数类型 & """, '基础参数及输出结果表'!" & _
+                     baseSheet.Cells(i - 7, j + 16).Address & ", ""全投资"")"
              Next j
          Next i
          
          ' 资本金IRR计算
          For i = 18 To 20
-             For j = 2 To 6
+             For j = 2 To colCount + 1
                  Select Case i
                      Case 18: 参数类型 = "发电小时数"
                  End Select
                  
-                 变化率 = Format((j - 4) * 0.05, "0.00")  ' 转换为字符串格式
-                 
-                 .Cells(i, j).Formula = "=计算新IRR(""" & 参数类型 & """, " & 变化率 & ", ""资本金"")"
+                 ' 使用基础参数表中的变化值
+                 .Cells(i, j).Formula = "=计算新IRR(""" & 参数类型 & """, '基础参数及输出结果表'!" & _
+                     baseSheet.Cells(i - 14, j + 16).Address & ", ""资本金"")"
              Next j
          Next i
          
-         ' 敏感性系数计算（修正计算公式）
+         ' 敏感性系数计算
          For i = 24 To 26
              ' 全投资IRR敏感性系数
```

---



主要修改内容：

1. 修改了`计算新IRR`函数，现在直接接受新参数值而不是变化率：
```vba
Function 计算新IRR(ByVal 参数类型 As String, ByVal 新参数值 As Double, ByVal IRR类型 As String)
```

2. 在`CreateSensitivityAnalysis`中添加了从基础参数表读取变化值的逻辑：
```vba
' 获取最后一列（从R列开始查找）
lastCol = baseSheet.Cells(4, 18).End(xlToRight).Column
colCount = lastCol - 17  ' R列是第18列
```

3. 修改了表头设置，现在直接从基础参数表复制变化值：
```vba
' 复制变化值到表头
For j = 1 To colCount
    .Cells(10, j + 1).Value = baseSheet.Cells(4, j + 17).Value
Next j
```

4. 修改了`AddFormulas`子程序，使用基础参数表中的实际变化值：
```vba
.Cells(i, j).Formula = "=计算新IRR(""" & 参数类型 & """, '基础参数及输出结果表'!" & _
    baseSheet.Cells(i - 7, j + 16).Address & ", ""全投资"")"
```

使用方法：
1. 在基础参数表的第4-6行，从R列开始输入变化后的参数值
2. 运行敏感性分析宏
3. 宏会：
   - 读取基础参数表中的变化值
   - 对每个变化值计算相应的IRR
   - 生成敏感性分析结果

这样修改后，敏感性分析将完全基于您在基础参数表中输入的实际变化值，而不是自动计算变化值。

---



---

