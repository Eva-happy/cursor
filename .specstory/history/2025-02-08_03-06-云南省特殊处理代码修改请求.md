<!-- Generated by SpecStory -->

# 云南省特殊处理代码修改请求 (2025-02-08 11:06:16)

_**User**_




---

_**Assistant**_

我将帮你修改`电网单元格合并之云南V3.py`文件，添加云南省的特殊处理逻辑。我会从`电网云南省excel更改.py`中提取相关的云南省特殊处理代码并嵌入。

让我们首先修改`check_and_process_content`函数，添加云南省的特殊处理：

---

```diff
- 
  import os
  import time
          wait = WebDriverWait(driver, 2)
          try:
+             # 检查是否是云南省的特殊处理
+             if "云南" in project_name:
+                 print("等待页面完全加载...")
+                 time.sleep(3)  # 给页面更多加载时间
+                 
+                 # 直接使用PDF下载链接
+                 pdf_url = "https://95598.csg.cn/ucs/ma/wt/business/downloadFiles?documentId=bmZkd195eF90eWZ3L3Nkay9vc3NGaWxlL2RlYmM0MTZkZDVjMzRmYzFiYjMxOGZkMDlkYTNhY2ZlL1BERg==&documentType=pdf&documentName=downloadFile"
+                 print("使用PDF下载链接:", pdf_url)
+                 
+                 # 使用下载方法
+                 pdf_file = download_pdf(pdf_url, project_name)
+                 if pdf_file:
+                     print("PDF下载成功，开始处理内容...")
+                     all_pages_data = extract_table_from_pdf(pdf_file)
+                     if all_pages_data:
+                         print("成功提取PDF数据，开始生成Excel文件...")
+                         excel_file = write_to_excel(all_pages_data, project_name)
+                         if excel_file:
+                             print("\n开始处理图片复制粘贴...")
+                             # 直接从网页复制图片到Excel
+                             copy_image_from_pdf_to_excel(driver, excel_file, [1, 2, 3])
+                         return excel_file
+                     else:
+                         print("PDF数据提取失败")
+                         return None
+                 else:
+                     print("PDF下载失败")
+                     return None
+             
+             # 非云南省的原有处理逻辑
              # 首先尝试查找普通的PDF iframe
              try:
```

---



现在让我们添加`get_yunnan_price_items`函数：

---

```diff
          print(f"合并单元格时出错: {str(e)}")
          # 发生错误时不影响程序继续运行
+ def get_yunnan_price_items(driver):
+     """获取云南省电价及收费标准项目列表"""
+     try:
+         print("等待项目列表加载...")
+         time.sleep(2)  # 给页面充分加载时间
+         items = []
+         
+         # 根据实际的HTML结构定位元素
+         item_elements = WebDriverWait(driver, 5).until(
+             EC.presence_of_all_elements_located((By.XPATH, "//div[@data-v-4ae2a228 and @class='list-item']"))
+         )
+         
+         for element in item_elements:
+             try:
+                 # 获取标题和时间
+                 title = element.find_element(By.XPATH, ".//div[@class='esp']").text.strip()
+                 time_element = element.find_element(By.XPATH, ".//div[@class='timeLine']")
+                 publish_time = time_element.text.strip()
+                 
+                 if title:
+                     # 使用link元素作为可点击元素
+                     link_element = element.find_element(By.XPATH, ".//div[@class='link']")
+                     items.append({
+                         "text": f"{title} ({publish_time})",
+                         "element": link_element
+                     })
+                     print(f"找到项目: {title}")
+             except Exception as e:
+                 print(f"处理项目元素失败: {str(e)}")
+                 continue
+         
+         if not items:
+             print("未找到任何项目")
+         else:
+             print(f"共找到 {len(items)} 个项目")
+         
+         return items
+     except Exception as e:
+         print(f"获取项目列表失败: {str(e)}")
+         return []
  def main():
      """主函数"""
```

---



现在让我们添加`copy_image_from_pdf_to_excel`函数：

---

```diff
  import urllib3
  import openpyxl
+ import win32com.client
+ import pyautogui
  # 禁用SSL警告
  urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
          print(f"获取项目列表失败: {str(e)}")
          return []
+ def copy_image_from_pdf_to_excel(driver, excel_path, page_numbers):
+     """
+     使用自动化方式将网页中的图片复制到Excel
+     Args:
+         driver: WebDriver对象
+         excel_path: Excel文件路径
+         page_numbers: 需要处理的页码列表
+     """
+     try:
+         # 转换为绝对路径
+         excel_abs_path = os.path.abspath(excel_path)
+         
+         print(f"Excel路径: {excel_abs_path}")
+         
+         # 检查文件是否存在
+         if not os.path.exists(excel_abs_path):
+             print(f"Excel文件不存在: {excel_abs_path}")
+             return
+             
+         # 打开Excel文件
+         excel = None
+         try:
+             print("打开Excel...")
+             excel = win32com.client.Dispatch("Excel.Application")
+             excel.Visible = True
+             excel.DisplayAlerts = False  # 禁用警告弹窗
+             workbook = excel.Workbooks.Open(excel_abs_path)
+             
+             # 设置pyautogui安全设置
+             pyautogui.FAILSAFE = True
+             pyautogui.PAUSE = 1.5  # 增加操作间隔时间
+             
+             for page_num in page_numbers:
+                 try:
+                     print(f"\n处理第 {page_num} 页...")
+                     
+                     # 询问是否需要重新获取坐标
+                     response = input(f"\n是否需要重新获取第 {page_num} 页的图片坐标？(y/n): ")
+                     if response.lower() == 'y':
+                         print("\n请获取图片左上角坐标:")
+                         start_x, start_y = get_mouse_position()
+                         print(f"\n左上角坐标: X: {start_x} Y: {start_y}")
+                         
+                         print("\n请获取图片右下角坐标:")
+                         end_x, end_y = get_mouse_position()
+                         print(f"\n右下角坐标: X: {end_x} Y: {end_y}")
+                     else:
+                         # 使用上一次的坐标
+                         if 'start_x' not in locals():
+                             print("没有保存的坐标，请至少获取一次坐标")
+                             continue
+                     
+                     print("\n请切换到PDF网页，3秒后将自动截图...")
+                     time.sleep(3)  # 给足时间切换窗口
+                     
+                     # 计算区域大小
+                     width = end_x - start_x
+                     height = end_y - start_y
+                     
+                     print(f"截图区域: 起点({start_x}, {start_y}), 终点({end_x}, {end_y}), 大小({width}x{height})")
+                     
+                     # 创建临时文件夹（如果不存在）
+                     temp_dir = os.path.join('downloads', 'temp')
+                     if not os.path.exists(temp_dir):
+                         os.makedirs(temp_dir)
+                         print(f"创建临时目录: {temp_dir}")
+                     
+                     # 保存截图到临时文件
+                     temp_image = os.path.join(temp_dir, f'temp_image_{page_num}.png')
+                     print(f"临时文件路径: {temp_image}")
+                     
+                     # 截取指定区域的图片
+                     try:
+                         print("开始截图...")
+                         screenshot = pyautogui.screenshot(region=(start_x, start_y, width, height))
+                         print("截图完成，准备保存...")
+                         screenshot.save(temp_image)
+                         print(f"截图已保存到: {temp_image}")
+                         
+                         # 验证截图文件
+                         if os.path.exists(temp_image):
+                             file_size = os.path.getsize(temp_image)
+                             print(f"截图文件大小: {file_size} 字节")
+                             if file_size == 0:
+                                 print("警告：截图文件大小为0")
+                                 continue
+                         else:
+                             print("错误：截图文件不存在")
+                             continue
+                         
+                     except Exception as e:
+                         print(f"截图过程出错: {str(e)}")
+                         continue
+                     
+                     # 找到要粘贴的位置（固定在第6行）
+                     paste_row = 6
+                     print(f"准备插入图片到第 {paste_row} 行...")
+                     
+                     try:
+                         # 激活对应的工作表
+                         worksheet = workbook.Worksheets(f'第{page_num}页')
+                         worksheet.Activate()
+                         
+                         # 选择B列第6行的单元格
+                         cell = worksheet.Cells(paste_row, 2)  # B列
+                         cell.Select()
+                         
+                         # 获取绝对路径
+                         temp_image_abs = os.path.abspath(temp_image)
+                         print(f"图片绝对路径: {temp_image_abs}")
+                         
+                         # 验证文件
+                         if not os.path.exists(temp_image_abs):
+                             print(f"错误：图片文件不存在: {temp_image_abs}")
+                             continue
+                                 
+                         file_size = os.path.getsize(temp_image_abs)
+                         print(f"图片文件大小: {file_size} 字节")
+                         
+                         if file_size == 0:
+                             print("错误：图片文件大小为0")
+                             continue
+                         
+                         # 插入图片
+                         print(f"准备插入图片到第 {paste_row} 行...")
+                         
+                         # 计算插入位置（使用Points单位）
+                         left = cell.Left
+                         top = cell.Top
+                         print(f"插入位置: Left={left}, Top={top}")
+                         
+                         shape = worksheet.Shapes.AddPicture(
+                             temp_image_abs,  # 使用绝对路径
+                             LinkToFile=False,
+                             SaveWithDocument=True,
+                             Left=left,
+                             Top=top,
+                             Width=600,
+                             Height=400
+                         )
+                         print(f"第 {page_num} 页图片插入成功")
+                         
+                         # 调整行高以适应图片
+                         worksheet.Rows(paste_row).RowHeight = 400
+                         
+                     except Exception as e:
+                         print(f"插入图片失败: {str(e)}")
+                         print(f"检查文件路径是否正确: {temp_image_abs}")
+                         print(f"检查文件是否存在: {os.path.exists(temp_image_abs)}")
+                         print(f"检查文件大小: {os.path.getsize(temp_image_abs) if os.path.exists(temp_image_abs) else '文件不存在'}")
+                         continue
+                     
+                 except Exception as e:
+                     print(f"处理第 {page_num} 页时出错: {str(e)}")
+                     continue
+             
+             # 完成所有操作后询问是否关闭Excel
+             response = input("\n所有图片处理完成，是否关闭Excel？(y/n): ")
+             if response.lower() == 'y':
+                 print("关闭Excel...")
+                 workbook.Close()
+             else:
+                 print("Excel保持打开状态")
+             
+             # 清理临时目录
+             try:
+                 if os.path.exists(temp_dir):
+                     import shutil
+                     shutil.rmtree(temp_dir)
+                     print("临时目录已清理")
+             except Exception as e:
+                 print(f"清理临时目录失败: {str(e)}")
+             
+         except Exception as e:
+             print(f"Excel操作出错: {str(e)}")
+             if excel:
+                 try:
+                     excel.Quit()
+                 except:
+                     pass
+             
+     except Exception as e:
+         print(f"复制图片过程出错: {str(e)}")
+         import traceback
+         traceback.print_exc()
+     finally:
+         if 'response' in locals() and response.lower() == 'y':
+             try:
+                 if 'excel' in locals() and excel:
+                     excel.Quit()
+             except:
+                 pass
+ 
+ def get_mouse_position():
+     """
+     获取鼠标位置的辅助函数
+     使用方法：运行此函数，然后将鼠标移动到目标位置，按Ctrl+C结束
+     """
+     try:
+         print("请将鼠标移动到目标位置...")
+         print("按Ctrl+C停止并显示坐标")
+         while True:
+             x, y = pyautogui.position()
+             position_str = f'当前鼠标位置: X: {x} Y: {y}'
+             print(position_str, end='\r')
+             time.sleep(0.1)
+     except KeyboardInterrupt:
+         print("\n已记录最后位置")
+         return x, y
+ 
  def main():
      """主函数"""
```

---



现在让我们修改`main`函数中的云南省特殊处理部分：

---

```diff
                  continue
              
-             # 获取总页数
+             # 云南省特殊处理
+             if selected_province['text'] == '云南省':
+                 try:
+                     print("\n检测到云南省，执行特殊处理流程...")
+                     
+                     # 点击营商环境
+                     print("等待营商环境按钮加载...")
+                     business_env = WebDriverWait(driver, 5).until(
+                         EC.element_to_be_clickable((By.XPATH, "//li[@role='menuitem']//span[text()='营商环境']"))
+                     )
+                     
+                     if not wait_and_click_element(driver, business_env):
+                         print("点击营商环境失败")
+                         continue
+                     
+                     # 点击信息公开
+                     print("等待信息公开按钮加载...")
+                     info_disclosure = WebDriverWait(driver, 5).until(
+                         EC.element_to_be_clickable((By.XPATH, "//div[contains(@class, 'container')]//span[contains(text(), '信息公开')]"))
+                     )
+                     
+                     if not wait_and_click_element(driver, info_disclosure):
+                         print("点击信息公开失败")
+                         continue
+                     
+                     # 点击电价及收费标准
+                     print("等待电价及收费标准按钮加载...")
+                     price_standard = WebDriverWait(driver, 5).until(
+                         EC.element_to_be_clickable((By.XPATH, "//div[contains(@class, 'list-item')]//div[contains(text(), '电价及收费标准')]"))
+                     )
+                     
+                     if not wait_and_click_element(driver, price_standard):
+                         print("点击电价及收费标准失败")
+                         continue
+                     
+                     time.sleep(2)  # 等待页面加载
+                     
+                     # 获取电价项目列表
+                     price_items = get_yunnan_price_items(driver)
+                     if not price_items:
+                         print("未找到电价项目列表")
+                         continue
+                     
+                     # 选择项目
+                     selected_item = display_menu(price_items, "请选择电价项目：")
+                     if selected_item is None:
+                         continue
+                     
+                     print(f"\n正在处理: {selected_item['text']}")
+                     if not wait_and_click_element(driver, selected_item['element']):
+                         print("点击项目失败")
+                         continue
+                     
+                     time.sleep(2)  # 等待页面加载
+                     
+                     # 检查是否有PDF并处理
+                     excel_file = check_and_process_content(driver, selected_item['text'])
+                     if excel_file:
+                         print(f"\n处理完成，数据已保存到: {excel_file}")
+                     else:
+                         print("\n处理失败")
+                 
+                 except Exception as e:
+                     print(f"云南省特殊处理失败: {str(e)}")
+                     continue
+             else:
+                 # 其他省份的原有处理逻辑
                  total_pages = get_page_info(driver)
                  if total_pages == 0:
                      except ValueError:
                          print("请输入有效的页码")
+             
+             # 操作选择循环
+             while True:
+                 print("\n请选择操作：")
+                 print("1. 继续浏览")
+                 print("2. 返回上一步")
+                 print("3. 退出程序")
+                 
+                 try:
+                     choice = int(input("\n请输入编号(1-3): "))
+                     if choice == 1:
+                         break
+                     elif choice == 2:
+                         break
+                     elif choice == 3:
+                         return
+                     else:
+                         print("无效的选择，请输入1-3之间的数字")
+                 except ValueError:
+                     print("请输入有效的数字")
          
      except Exception as e:
```

---



我已经完成了所有必要的修改，让我总结一下所做的更改：

1. 添加了云南省特殊处理所需的依赖：
   - `win32com.client` - 用于Excel操作
   - `pyautogui` - 用于截图功能

2. 添加了新的函数：
   - `copy_image_from_pdf_to_excel` - 处理图片复制粘贴到Excel的功能
   - `get_mouse_position` - 获取鼠标位置的辅助函数
   - `get_yunnan_price_items` - 获取云南省电价及收费标准项目列表

3. 修改了现有函数：
   - `check_and_process_content` - 添加了云南省特殊处理逻辑
   - `main` - 添加了云南省特殊处理流程

4. 主要的云南省特殊处理流程包括：
   - 点击"营商环境"
   - 点击"信息公开"
   - 点击"电价及收费标准"
   - 获取并选择电价项目
   - 处理PDF内容并生成Excel
   - 复制图片到Excel的特定位置

5. 保持了其他省份的原有处理逻辑不变

现在这个程序可以：
1. 对云南省使用特殊的处理流程和Excel模板
2. 为云南省的Excel文件添加图片复制粘贴功能
3. 对其他省份保持原有的处理流程和Excel格式不变

是否需要我对任何部分进行进一步的修改或解释？

---



---

