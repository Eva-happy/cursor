<!-- Generated by SpecStory -->

# 分时电价补充功能开发 (2025-04-13 10:49:10)

_**User**_

在创建单个地区时段表sheet后，在这个sheet增加多一个功能，叫做分时电价补充，当我选择完地区，自动填充好尖峰平谷时段颜色后，我运行分时电价补充的宏，创建一个新sheet,叫做单个地区最近一年的分时电价，该表格的格式是，A1单元格为我选择地区的名称，A2-A13分别是月份，1月，2月。。。。至12月，B1至F1单元格，分别是：尖峰时段电价、高峰时段电价、平时段电价、低谷时段电价、深谷时段的电价，当我输入完这些电价后，再运行宏，在该sheet的第15行，按照单个时段表里时段图生成表，把里面数字尖峰平谷分别对应替换为每个月对应的尖峰平谷和深度的电价。CreateSingleRegionTemplate函数只能添加新功能，不要删除原有的功能，包括生成柱状图数据源（高度值）表，生成包含电价的时段表请在单个地区最近一年的分时电价sheet里生成

---

_**Assistant**_

我来帮你实现这个新功能。首先我需要了解当前的代码结构，然后添加分时电价补充功能。

---

<details>
            <summary>Searched codebase "CreateSingleRegionTemplate" • **0** results</summary>
        
No results found
</details>

---

<details>
            <summary>Searched codebase "CreateSingleRegionTemplate 函数代码" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `宏设置-分时电价/2222` | L1-52 |
| `宏设置-分时电价/单个地区含分时电价时段图.bas` | L2397-2450 |
| `宏设置-分时电价/单个地区含分时电价时段图.bas` | L1053-1130 |
| `宏设置-分时电价/新增充放电计划.bas` | L1053-1130 |
| `宏设置-分时电价/单个地区含分时电价时段图.bas` | L1781-1853 |
| `宏设置-分时电价/柱子颜色` | L1471-1536 |
| `宏设置-分时电价/宏设置-8-多个地区分时电价图` | L1458-1508 |
| `宏设置-分时电价/柱子颜色数据源` | L1471-1536 |
| `宏设置-分时电价/宏设置-7-多个地区分时电价图.bas` | L1351-1407 |
| `宏设置-分时电价/删掉季节` | L1404-1469 |
| `宏设置-分时电价/text格式要求检查` | L1404-1469 |
| `宏设置-分时电价/柱子图新版` | L1471-1536 |
| `宏设置-分时电价/必用Final全国分时电价类型图标记文字.bas` | L1050-1120 |
| `宏设置-分时电价/季节的解读结果修改-不要季节` | L1241-1306 |
| `宏设置-分时电价/宏设置10` | L1488-1539 |
| `宏设置-分时电价/新增充放电计划.bas` | L2431-2484 |
| `宏设置-分时电价/宏设置9` | L1471-1522 |
| `宏设置-分时电价/宏设置-8-多个地区分时电价图` | L1144-1175 |
| `宏设置-分时电价/VBA创建柱状图V1` | L989-1057 |
| `宏设置-分时电价/宏设置-7-多个地区分时电价图.bas` | L1089-1152 |
| `宏设置-分时电价/VBA创建柱状图V2` | L991-1059 |
| `宏设置-分时电价/宏设置-7-多个地区分时电价图` | L1147-1198 |
| `宏设置-分时电价/宏设置10` | L1135-1201 |
| `宏设置-分时电价/VBA创建柱状图V1` | L1057-1097 |
| `宏设置-分时电价/宏设置-7-多个地区分时电价图.bas` | L1498-1553 |

</details>

---

Read file: 宏设置-分时电价/单个地区含分时电价时段图.bas

---

现在我需要查看更多代码以了解创建单个地区时段表的功能，然后添加分时电价补充功能。

---

```diff
      Next i
      
-         ' 添加颜色图例说明
+     ' 添加颜色图例说明
      ws.Cells(2, 28).value = "图例说明："
      ws.Cells(3, 28).value = "尖峰时段"
  
      
-         ' 设置标题行格式
+     ' 设置标题行格式
      With ws.Range("A1:Y1")
          .Font.Bold = True
          End With
      End If
+     
+     ' 添加分时电价补充按钮
+     Dim btnPriceSupp As Button
+     Set btnPriceSupp = ws.Buttons.Add(ws.Range("AA12").Left, ws.Range("AA12").Top + 105, 120, 25)
+     With btnPriceSupp
+         .OnAction = "CreatePriceSupplementSheet"
+         .Caption = "分时电价补充"
+     End With
+     
      On Error GoTo 0
  End Sub
```

---

看起来第一部分添加了按钮，但其他新增的函数没有成功添加。我将再次尝试添加这些函数。

---

```diff
      CalculateMonthDays = totalDays
  End Function
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ ' 添加分时电价补充功能函数
+ Sub CreatePriceSupplementSheet()
+     Dim wsSingle As Worksheet
+     Dim wsPrice As Worksheet
+     Dim regionName As String
+     
+     ' 获取单个地区时段表
+     On Error Resume Next
+     Set wsSingle = ThisWorkbook.Worksheets("单个地区时段表")
+     If wsSingle Is Nothing Then
+         MsgBox "未找到单个地区时段表！请先创建单个地区时段表。", vbExclamation
+         Exit Sub
+     End If
+     
+     ' 获取选中的地区名称
+     regionName = wsSingle.Range("A1").value
+     If regionName = "" Then
+         MsgBox "请先选择地区！", vbExclamation
+         Exit Sub
+     End If
+     
+     ' 创建或清除分时电价补充工作表
+     Set wsPrice = ThisWorkbook.Worksheets("单个地区最近一年的分时电价")
+     If wsPrice Is Nothing Then
+         Set wsPrice = ThisWorkbook.Worksheets.Add
+         wsPrice.Name = "单个地区最近一年的分时电价"
+     Else
+         ' 清除工作表内容
+         wsPrice.Cells.Clear
+     End If
+     wsPrice.Tab.ColorIndex = 50 ' 设置为青绿色
+     
+     ' 设置地区名称
+     wsPrice.Range("A1").value = regionName
+     wsPrice.Range("A1").Font.Bold = True
+     
+     ' 设置月份
+     Dim i As Integer
+     For i = 1 To 12
+         wsPrice.Cells(i + 1, 1).value = i & "月"
+     Next i
+     
+     ' 设置电价类型标题
+     wsPrice.Cells(1, 2).value = "尖峰时段电价"
+     wsPrice.Cells(1, 3).value = "高峰时段电价"
+     wsPrice.Cells(1, 4).value = "平时段电价"
+     wsPrice.Cells(1, 5).value = "低谷时段电价"
+     wsPrice.Cells(1, 6).value = "深谷时段电价"
+     
+     ' 设置标题行格式
+     With wsPrice.Range("A1:F1")
+         .Font.Bold = True
+         .HorizontalAlignment = xlCenter
+         .VerticalAlignment = xlCenter
+         .Interior.color = RGB(217, 217, 217)  ' 浅灰色背景
+     End With
+     
+     ' 设置表格边框
+     With wsPrice.Range("A1:F13")
+         .Borders.LineStyle = xlContinuous
+         .Borders(xlEdgeLeft).LineStyle = xlContinuous
+         .Borders(xlEdgeTop).LineStyle = xlContinuous
+         .Borders(xlEdgeBottom).LineStyle = xlContinuous
+         .Borders(xlEdgeRight).LineStyle = xlContinuous
+         .Borders(xlInsideVertical).LineStyle = xlContinuous
+         .Borders(xlInsideHorizontal).LineStyle = xlContinuous
+     End With
+     
+     ' 设置列宽
+     wsPrice.Columns("A").ColumnWidth = 6
+     wsPrice.Columns("B:F").ColumnWidth = 15
+     
+     ' 添加生成分时电价时段表按钮
+     Dim btnGenerate As Button
+     Set btnGenerate = wsPrice.Buttons.Add(wsPrice.Range("H5").Left, wsPrice.Range("H5").Top, 120, 25)
+     With btnGenerate
+         .OnAction = "GenerateTimePriceTable"
+         .Caption = "生成分时电价时段表"
+     End With
+     
+     MsgBox "分时电价补充表创建成功！" & vbCrLf & _
+            "请在表格中输入各月份的分时电价，然后点击'生成分时电价时段表'按钮。", vbInformation
+ End Sub
+ 
+ ' 生成分时电价时段表函数
+ Sub GenerateTimePriceTable()
+     Dim wsSingle As Worksheet
+     Dim wsPrice As Worksheet
+     Dim regionName As String
+     Dim i As Integer, j As Integer
+     
+     ' 获取工作表
+     On Error Resume Next
+     Set wsSingle = ThisWorkbook.Worksheets("单个地区时段表")
+     Set wsPrice = ThisWorkbook.Worksheets("单个地区最近一年的分时电价")
+     
+     If wsSingle Is Nothing Or wsPrice Is Nothing Then
+         MsgBox "未找到所需工作表！", vbExclamation
+         Exit Sub
+     End If
+     
+     ' 获取地区名称
+     regionName = wsPrice.Range("A1").value
+     If regionName = "" Then
+         MsgBox "请先设置地区名称！", vbExclamation
+         Exit Sub
+     End If
+     
+     ' 检查是否已输入电价数据
+     Dim hasPriceData As Boolean
+     hasPriceData = False
+     
+     For i = 2 To 13
+         For j = 2 To 6
+             If Not IsEmpty(wsPrice.Cells(i, j).value) Then
+                 hasPriceData = True
+                 Exit For
+             End If
+         Next j
+         If hasPriceData Then Exit For
+     Next i
+     
+     If Not hasPriceData Then
+         MsgBox "请先输入电价数据！", vbExclamation
+         Exit Sub
+     End If
+     
+     ' 清除之前的时段表数据，保留第15行之前的内容
+     If wsPrice.Cells(wsPrice.Rows.Count, "A").End(xlUp).row >= 15 Then
+         wsPrice.Range("A15:Y" & wsPrice.Rows.Count).Clear
+     End If
+     
+     ' 根据单个地区时段表数据创建分时电价时段表
+     ' 设置时段表标题行（从第15行开始）
+     wsPrice.Cells(15, 1).value = "分时电价时段表："
+     wsPrice.Cells(15, 1).Font.Bold = True
+     
+     ' 设置列标题（小时）
+     For j = 0 To 23
+         wsPrice.Cells(16, j + 2).value = "'" & j & "-" & (j + 1)
+         wsPrice.Cells(16, j + 2).HorizontalAlignment = xlCenter
+         ' 设置小时列的宽度
+         wsPrice.Columns(j + 2).ColumnWidth = 5
+     Next j
+     
+     ' 设置月份
+     For i = 1 To 12
+         wsPrice.Cells(i + 16, 1).value = i & "月"
+     Next i
+     
+     ' 设置表格格式
+     With wsPrice.Range(wsPrice.Cells(16, 1), wsPrice.Cells(28, 25))
+         .Borders.LineStyle = xlContinuous
+         .Borders(xlEdgeLeft).LineStyle = xlContinuous
+         .Borders(xlEdgeTop).LineStyle = xlContinuous
+         .Borders(xlEdgeBottom).LineStyle = xlContinuous
+         .Borders(xlEdgeRight).LineStyle = xlContinuous
+         .Borders(xlInsideVertical).LineStyle = xlContinuous
+         .Borders(xlInsideHorizontal).LineStyle = xlContinuous
+     End With
+     
+     ' 设置标题行格式
+     With wsPrice.Range("A16:Y16")
+         .Font.Bold = True
+         .HorizontalAlignment = xlCenter
+         .VerticalAlignment = xlCenter
+         .Interior.color = RGB(217, 217, 217)  ' 浅灰色背景
+     End With
+     
+     ' 填充分时电价时段表数据
+     For i = 1 To 12  ' 12个月
+         For j = 0 To 23  ' 24小时
+             ' 获取时段类型（从时段状态配置中）
+             If Not IsEmpty(wsSingle.Cells(i + 16, j + 2).value) Then
+                 Select Case wsSingle.Cells(i + 16, j + 2).value
+                     Case PEAK ' 尖峰
+                         wsPrice.Cells(i + 16, j + 2).Interior.color = RGB(255, 192, 0)  ' 橙色
+                         If Not IsEmpty(wsPrice.Cells(i + 1, 2).value) Then
+                             wsPrice.Cells(i + 16, j + 2).value = wsPrice.Cells(i + 1, 2).value
+                         End If
+                     Case HIGH ' 高峰
+                         wsPrice.Cells(i + 16, j + 2).Interior.color = RGB(255, 192, 203)  ' 粉红色
+                         If Not IsEmpty(wsPrice.Cells(i + 1, 3).value) Then
+                             wsPrice.Cells(i + 16, j + 2).value = wsPrice.Cells(i + 1, 3).value
+                         End If
+                     Case NORMAL ' 平段
+                         wsPrice.Cells(i + 16, j + 2).Interior.color = RGB(189, 215, 238) ' 浅蓝色
+                         If Not IsEmpty(wsPrice.Cells(i + 1, 4).value) Then
+                             wsPrice.Cells(i + 16, j + 2).value = wsPrice.Cells(i + 1, 4).value
+                         End If
+                     Case LOW ' 低谷
+                         wsPrice.Cells(i + 16, j + 2).Interior.color = RGB(198, 239, 206) ' 浅绿色
+                         If Not IsEmpty(wsPrice.Cells(i + 1, 5).value) Then
+                             wsPrice.Cells(i + 16, j + 2).value = wsPrice.Cells(i + 1, 5).value
+                         End If
+                     Case DEEP_LOW ' 深谷
+                         wsPrice.Cells(i + 16, j + 2).Interior.color = RGB(0, 112, 192)   ' 深蓝色
+                         If Not IsEmpty(wsPrice.Cells(i + 1, 6).value) Then
+                             wsPrice.Cells(i + 16, j + 2).value = wsPrice.Cells(i + 1, 6).value
+                         End If
+                 End Select
+             End If
+         Next j
+     Next i
+     
+     ' 添加颜色图例说明
+     wsPrice.Cells(17, 28).value = "图例说明："
+     wsPrice.Cells(18, 28).value = "尖峰时段"
+     wsPrice.Cells(19, 28).value = "高峰时段"
+     wsPrice.Cells(20, 28).value = "平时段"
+     wsPrice.Cells(21, 28).value = "低谷时段"
+     wsPrice.Cells(22, 28).value = "深谷时段"
+     
+     ' 设置图例颜色
+     wsPrice.Cells(18, 29).Interior.color = RGB(255, 192, 0)   ' 橙色 - 尖峰
+     wsPrice.Cells(19, 29).Interior.color = RGB(255, 192, 203) ' 粉红色 - 高峰
+     wsPrice.Cells(20, 29).Interior.color = RGB(189, 215, 238) ' 浅蓝色 - 平段
+     wsPrice.Cells(21, 29).Interior.color = RGB(198, 239, 206) ' 浅绿色 - 低谷
+     wsPrice.Cells(22, 29).Interior.color = RGB(0, 112, 192)   ' 深蓝色 - 深谷
+     
+     ' 激活分时电价工作表并显示成功消息
+     wsPrice.Activate
+     wsPrice.Range("A15").Select
+     
+     MsgBox "分时电价时段表生成成功！", vbInformation
+ End Sub
  
  
```

---

完美！我们成功添加了分时电价补充功能，实现了需求。让我检查一下代码是否有任何潜在问题。

---

Cancelled

---



---

_**User**_

在这个代码基础上，在单个地区最近一年的分时电价sheet里，增加一个求电价平均值的功能：1.全年尖峰平均值【注意分母是出现了尖峰的次数】，全年高峰平均值【注意分母是出现了高峰的次数】】，全年平时段平均值【注意分母是出现了平时段次数】，全年低谷时段平均值【注意分母是出现了低谷次数】，全年深谷时段平均值【注意分母是出现了深谷的次数】；2.每月份固定时间段平均值，由我输入时段，比如6点-18点，对应求6-7至17-18，这个区间的平均值。如果我不输入时段，则默认是求6点-18点平均值。求完每个月固定时间段的平均值后再除以12求一个年均平均值

---

_**Assistant**_

我来为您实现这两个电价平均值计算功能。我会在单个地区最近一年的分时电价表中增加这些功能。

---

```diff
          .Caption = "生成分时电价时段表"
      End With
+     
+     ' 添加计算全年各时段平均电价按钮
+     Dim btnAvgPrice As Button
+     Set btnAvgPrice = wsPrice.Buttons.Add(wsPrice.Range("H7").Left, wsPrice.Range("H7").Top, 120, 25)
+     With btnAvgPrice
+         .OnAction = "CalculateYearlyAveragePrices"
+         .Caption = "计算全年各时段平均电价"
+     End With
+     
+     ' 添加计算固定时间段平均电价按钮
+     Dim btnTimeAvgPrice As Button
+     Set btnTimeAvgPrice = wsPrice.Buttons.Add(wsPrice.Range("H9").Left, wsPrice.Range("H9").Top, 120, 25)
+     With btnTimeAvgPrice
+         .OnAction = "CalculateFixedTimeAveragePrices"
+         .Caption = "计算固定时间段平均电价"
+     End With
      
      MsgBox "分时电价补充表创建成功！" & vbCrLf & _
-            "请在表格中输入各月份的分时电价，然后点击'生成分时电价时段表'按钮。", vbInformation
+            "请在表格中输入各月份的分时电价，然后点击相应按钮。", vbInformation
  End Sub
  
  End Sub
  
- 
- 
- 
- 
- 
- 
- 
- 
- 
- 
- 
- 
- 
- 
- 
- 
- 
+ ' 计算全年各时段平均电价函数
+ Sub CalculateYearlyAveragePrices()
+     Dim wsPrice As Worksheet
+     Dim wsSingle As Worksheet
+     Dim i As Integer, j As Integer
+     Dim peakCount As Integer, highCount As Integer, normalCount As Integer, lowCount As Integer, deepLowCount As Integer
+     Dim peakSum As Double, highSum As Double, normalSum As Double, lowSum As Double, deepLowSum As Double
+     
+     ' 获取工作表
+     On Error Resume Next
+     Set wsPrice = ThisWorkbook.Worksheets("单个地区最近一年的分时电价")
+     Set wsSingle = ThisWorkbook.Worksheets("单个地区时段表")
+     
+     If wsPrice Is Nothing Or wsSingle Is Nothing Then
+         MsgBox "未找到所需工作表！", vbExclamation
+         Exit Sub
+     End If
+     
+     ' 检查是否已输入电价数据
+     Dim hasPriceData As Boolean
+     hasPriceData = False
+     
+     For i = 2 To 13
+         For j = 2 To 6
+             If Not IsEmpty(wsPrice.Cells(i, j).value) Then
+                 hasPriceData = True
+                 Exit For
+             End If
+         Next j
+         If hasPriceData Then Exit For
+     Next i
+     
+     If Not hasPriceData Then
+         MsgBox "请先输入电价数据！", vbExclamation
+         Exit Sub
+     End If
+     
+     ' 初始化计数器和求和变量
+     peakCount = 0
+     highCount = 0
+     normalCount = 0
+     lowCount = 0
+     deepLowCount = 0
+     peakSum = 0
+     highSum = 0
+     normalSum = 0
+     lowSum = 0
+     deepLowSum = 0
+     
+     ' 计算各时段总和和数量
+     For i = 1 To 12
+         ' 检查是否有该时段类型的电价
+         If Not IsEmpty(wsPrice.Cells(i + 1, 2).value) Then  ' 尖峰
+             ' 检查该月是否有尖峰时段
+             Dim hasType As Boolean
+             hasType = False
+             
+             For j = 0 To 23
+                 If Not IsEmpty(wsSingle.Cells(i + 16, j + 2).value) Then
+                     If wsSingle.Cells(i + 16, j + 2).value = PEAK Then
+                         hasType = True
+                         Exit For
+                     End If
+                 End If
+             Next j
+             
+             If hasType Then
+                 peakSum = peakSum + CDbl(wsPrice.Cells(i + 1, 2).value)
+                 peakCount = peakCount + 1
+             End If
+         End If
+         
+         If Not IsEmpty(wsPrice.Cells(i + 1, 3).value) Then  ' 高峰
+             hasType = False
+             
+             For j = 0 To 23
+                 If Not IsEmpty(wsSingle.Cells(i + 16, j + 2).value) Then
+                     If wsSingle.Cells(i + 16, j + 2).value = HIGH Then
+                         hasType = True
+                         Exit For
+                     End If
+                 End If
+             Next j
+             
+             If hasType Then
+                 highSum = highSum + CDbl(wsPrice.Cells(i + 1, 3).value)
+                 highCount = highCount + 1
+             End If
+         End If
+         
+         If Not IsEmpty(wsPrice.Cells(i + 1, 4).value) Then  ' 平段
+             hasType = False
+             
+             For j = 0 To 23
+                 If Not IsEmpty(wsSingle.Cells(i + 16, j + 2).value) Then
+                     If wsSingle.Cells(i + 16, j + 2).value = NORMAL Then
+                         hasType = True
+                         Exit For
+                     End If
+                 End If
+             Next j
+             
+             If hasType Then
+                 normalSum = normalSum + CDbl(wsPrice.Cells(i + 1, 4).value)
+                 normalCount = normalCount + 1
+             End If
+         End If
+         
+         If Not IsEmpty(wsPrice.Cells(i + 1, 5).value) Then  ' 低谷
+             hasType = False
+             
+             For j = 0 To 23
+                 If Not IsEmpty(wsSingle.Cells(i + 16, j + 2).value) Then
+                     If wsSingle.Cells(i + 16, j + 2).value = LOW Then
+                         hasType = True
+                         Exit For
+                     End If
+                 End If
+             Next j
+             
+             If hasType Then
+                 lowSum = lowSum + CDbl(wsPrice.Cells(i + 1, 5).value)
+                 lowCount = lowCount + 1
+             End If
+         End If
+         
+         If Not IsEmpty(wsPrice.Cells(i + 1, 6).value) Then  ' 深谷
+             hasType = False
+             
+             For j = 0 To 23
+                 If Not IsEmpty(wsSingle.Cells(i + 16, j + 2).value) Then
+                     If wsSingle.Cells(i + 16, j + 2).value = DEEP_LOW Then
+                         hasType = True
+                         Exit For
+                     End If
+                 End If
+             Next j
+             
+             If hasType Then
+                 deepLowSum = deepLowSum + CDbl(wsPrice.Cells(i + 1, 6).value)
+                 deepLowCount = deepLowCount + 1
+             End If
+         End If
+     Next i
+     
+     ' 清除之前的计算结果
+     If wsPrice.Cells(wsPrice.Rows.Count, "H").End(xlUp).row > 15 Then
+         wsPrice.Range("H15:K30").Clear
+     End If
+     
+     ' 设置平均电价标题
+     wsPrice.Cells(15, 8).value = "全年各时段平均电价："
+     wsPrice.Cells(15, 8).Font.Bold = True
+     
+     ' 设置各时段标题
+     wsPrice.Cells(16, 8).value = "时段类型"
+     wsPrice.Cells(16, 9).value = "平均电价"
+     wsPrice.Cells(16, 10).value = "出现月份数"
+     
+     ' 设置标题行格式
+     With wsPrice.Range("H16:J16")
+         .Font.Bold = True
+         .HorizontalAlignment = xlCenter
+         .VerticalAlignment = xlCenter
+         .Interior.color = RGB(217, 217, 217)  ' 浅灰色背景
+     End With
+     
+     ' 设置表格边框
+     With wsPrice.Range("H16:J21")
+         .Borders.LineStyle = xlContinuous
+         .Borders(xlEdgeLeft).LineStyle = xlContinuous
+         .Borders(xlEdgeTop).LineStyle = xlContinuous
+         .Borders(xlEdgeBottom).LineStyle = xlContinuous
+         .Borders(xlEdgeRight).LineStyle = xlContinuous
+         .Borders(xlInsideVertical).LineStyle = xlContinuous
+         .Borders(xlInsideHorizontal).LineStyle = xlContinuous
+     End With
+     
+     ' 设置列宽
+     wsPrice.Columns("H").ColumnWidth = 12
+     wsPrice.Columns("I:J").ColumnWidth = 10
+     
+     ' 填写各时段平均电价
+     wsPrice.Cells(17, 8).value = "尖峰时段"
+     wsPrice.Cells(18, 8).value = "高峰时段"
+     wsPrice.Cells(19, 8).value = "平时段"
+     wsPrice.Cells(20, 8).value = "低谷时段"
+     wsPrice.Cells(21, 8).value = "深谷时段"
+     
+     ' 计算并填写平均值
+     If peakCount > 0 Then
+         wsPrice.Cells(17, 9).value = Round(peakSum / peakCount, 2)
+         wsPrice.Cells(17, 10).value = peakCount
+     Else
+         wsPrice.Cells(17, 9).value = "-"
+         wsPrice.Cells(17, 10).value = 0
+     End If
+     
+     If highCount > 0 Then
+         wsPrice.Cells(18, 9).value = Round(highSum / highCount, 2)
+         wsPrice.Cells(18, 10).value = highCount
+     Else
+         wsPrice.Cells(18, 9).value = "-"
+         wsPrice.Cells(18, 10).value = 0
+     End If
+     
+     If normalCount > 0 Then
+         wsPrice.Cells(19, 9).value = Round(normalSum / normalCount, 2)
+         wsPrice.Cells(19, 10).value = normalCount
+     Else
+         wsPrice.Cells(19, 9).value = "-"
+         wsPrice.Cells(19, 10).value = 0
+     End If
+     
+     If lowCount > 0 Then
+         wsPrice.Cells(20, 9).value = Round(lowSum / lowCount, 2)
+         wsPrice.Cells(20, 10).value = lowCount
+     Else
+         wsPrice.Cells(20, 9).value = "-"
+         wsPrice.Cells(20, 10).value = 0
+     End If
+     
+     If deepLowCount > 0 Then
+         wsPrice.Cells(21, 9).value = Round(deepLowSum / deepLowCount, 2)
+         wsPrice.Cells(21, 10).value = deepLowCount
+     Else
+         wsPrice.Cells(21, 9).value = "-"
+         wsPrice.Cells(21, 10).value = 0
+     End If
+     
+     ' 激活分时电价工作表并显示成功消息
+     wsPrice.Activate
+     wsPrice.Range("H15").Select
+     
+     MsgBox "全年各时段平均电价计算成功！", vbInformation
+ End Sub
+ 
+ ' 计算固定时间段平均电价函数
+ Sub CalculateFixedTimeAveragePrices()
+     Dim wsPrice As Worksheet
+     Dim startHour As Integer, endHour As Integer
+     Dim inputStr As String, timeRange As String
+     Dim i As Integer, j As Integer
+     Dim monthSum() As Double
+     Dim monthCount() As Integer
+     Dim yearSum As Double, yearCount As Integer
+     
+     ' 获取工作表
+     On Error Resume Next
+     Set wsPrice = ThisWorkbook.Worksheets("单个地区最近一年的分时电价")
+     
+     If wsPrice Is Nothing Then
+         MsgBox "未找到所需工作表！", vbExclamation
+         Exit Sub
+     End If
+     
+     ' 检查是否已生成分时电价时段表
+     If IsEmpty(wsPrice.Cells(15, 1).value) Or wsPrice.Cells(15, 1).value <> "分时电价时段表：" Then
+         MsgBox "请先生成分时电价时段表！", vbExclamation
+         Exit Sub
+     End If
+     
+     ' 获取用户输入的时间段
+     inputStr = InputBox("请输入要计算平均电价的时间段，格式为：开始时间-结束时间" & vbCrLf & _
+                        "例如：6-18 表示 6:00-18:00" & vbCrLf & _
+                        "如不输入，将使用默认时间段 6:00-18:00", "输入时间段")
+     
+     ' 处理输入
+     If inputStr = "" Then
+         startHour = 6
+         endHour = 18
+         timeRange = "6:00-18:00"
+     Else
+         ' 解析输入的时间段
+         Dim timeParts() As String
+         timeParts = Split(inputStr, "-")
+         
+         If UBound(timeParts) <> 1 Then
+             MsgBox "时间段格式错误！将使用默认时间段 6:00-18:00", vbExclamation
+             startHour = 6
+             endHour = 18
+             timeRange = "6:00-18:00"
+         Else
+             On Error Resume Next
+             startHour = CInt(Trim(timeParts(0)))
+             endHour = CInt(Trim(timeParts(1)))
+             
+             If Err.Number <> 0 Or startHour < 0 Or startHour > 23 Or endHour < 1 Or endHour > 24 Then
+                 MsgBox "时间段范围错误！将使用默认时间段 6:00-18:00", vbExclamation
+                 startHour = 6
+                 endHour = 18
+                 timeRange = "6:00-18:00"
+             Else
+                 timeRange = startHour & ":00-" & endHour & ":00"
+             End If
+             On Error GoTo 0
+         End If
+     End If
+     
+     ' 初始化月份数据数组
+     ReDim monthSum(1 To 12)
+     ReDim monthCount(1 To 12)
+     
+     For i = 1 To 12
+         monthSum(i) = 0
+         monthCount(i) = 0
+     Next i
+     
+     ' 计算每个月份指定时间段的平均电价
+     For i = 1 To 12
+         For j = startHour To endHour - 1
+             ' 检查单元格是否有数据
+             If Not IsEmpty(wsPrice.Cells(i + 16, j + 2).value) Then
+                 On Error Resume Next
+                 Dim cellValue As Double
+                 cellValue = CDbl(wsPrice.Cells(i + 16, j + 2).value)
+                 
+                 If Err.Number = 0 Then
+                     monthSum(i) = monthSum(i) + cellValue
+                     monthCount(i) = monthCount(i) + 1
+                 End If
+                 On Error GoTo 0
+             End If
+         Next j
+     Next i
+     
+     ' 计算全年平均值
+     yearSum = 0
+     yearCount = 0
+     
+     For i = 1 To 12
+         If monthCount(i) > 0 Then
+             yearSum = yearSum + (monthSum(i) / monthCount(i))
+             yearCount = yearCount + 1
+         End If
+     Next i
+     
+     ' 清除之前的计算结果
+     If wsPrice.Cells(wsPrice.Rows.Count, "H").End(xlUp).row > 25 Then
+         wsPrice.Range("H25:K40").Clear
+     End If
+     
+     ' 设置固定时间段平均电价标题
+     wsPrice.Cells(25, 8).value = "固定时间段平均电价(" & timeRange & ")："
+     wsPrice.Cells(25, 8).Font.Bold = True
+     
+     ' 设置表头
+     wsPrice.Cells(26, 8).value = "月份"
+     wsPrice.Cells(26, 9).value = "平均电价"
+     wsPrice.Cells(26, 10).value = "时段数量"
+     
+     ' 设置标题行格式
+     With wsPrice.Range("H26:J26")
+         .Font.Bold = True
+         .HorizontalAlignment = xlCenter
+         .VerticalAlignment = xlCenter
+         .Interior.color = RGB(217, 217, 217)  ' 浅灰色背景
+     End With
+     
+     ' 设置表格边框
+     With wsPrice.Range("H26:J39")
+         .Borders.LineStyle = xlContinuous
+         .Borders(xlEdgeLeft).LineStyle = xlContinuous
+         .Borders(xlEdgeTop).LineStyle = xlContinuous
+         .Borders(xlEdgeBottom).LineStyle = xlContinuous
+         .Borders(xlEdgeRight).LineStyle = xlContinuous
+         .Borders(xlInsideVertical).LineStyle = xlContinuous
+         .Borders(xlInsideHorizontal).LineStyle = xlContinuous
+     End With
+     
+     ' 填写各月份平均电价
+     For i = 1 To 12
+         wsPrice.Cells(i + 26, 8).value = i & "月"
+         
+         If monthCount(i) > 0 Then
+             wsPrice.Cells(i + 26, 9).value = Round(monthSum(i) / monthCount(i), 2)
+             wsPrice.Cells(i + 26, 10).value = monthCount(i)
+         Else
+             wsPrice.Cells(i + 26, 9).value = "-"
+             wsPrice.Cells(i + 26, 10).value = 0
+         End If
+     Next i
+     
+     ' 填写年平均值
+     wsPrice.Cells(39, 8).value = "全年平均"
+     
+     If yearCount > 0 Then
+         wsPrice.Cells(39, 9).value = Round(yearSum / yearCount, 2)
+     Else
+         wsPrice.Cells(39, 9).value = "-"
+     End If
+     
+     ' 设置全年平均行格式
+     With wsPrice.Range("H39:J39")
+         .Font.Bold = True
+         .Interior.color = RGB(200, 200, 200)  ' 浅灰色背景
+     End With
+     
+     ' 激活分时电价工作表并显示成功消息
+     wsPrice.Activate
+     wsPrice.Range("H25").Select
+     
+     MsgBox "固定时间段(" & timeRange & ")平均电价计算成功！", vbInformation
+ End Sub
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
+ 
  
  
```

---

已经成功添加了两个电价平均值计算功能：

1. **计算全年各时段平均电价功能**：
   - 计算尖峰、高峰、平段、低谷和深谷时段的平均电价
   - 统计时只考虑出现了该时段的月份
   - 显示每种时段类型的平均电价和出现月份数

2. **计算固定时间段平均电价功能**：
   - 允许用户输入指定时间段，默认为6:00-18:00
   - 分别计算每个月份在该时间段内的平均电价
   - 计算所有月份的年平均值
   - 显示详细的月份数据和全年平均值

这两个功能使得用户可以更全面地分析和比较不同时段的电价情况，有助于优化用电计划和成本控制。

功能已全部实现，用户可以在生成分时电价时段表后，通过点击相应按钮计算不同的电价平均值。

---

_**User**_

如图，确保新生成的平均值表不要占用已有的表格位置，在空白位置生成

---

_**Assistant**_

我来修改代码，确保平均值表生成在空白位置，避免占用已有表格。

---

```diff
      Next i
      
-     ' 清除之前的计算结果
-     If wsPrice.Cells(wsPrice.Rows.Count, "H").End(xlUp).row > 15 Then
-         wsPrice.Range("H15:K30").Clear
-     End If
+     ' 清除之前的计算结果（确保位置不会覆盖已有内容）
+     wsPrice.Range("M2:P8").Clear
      
      ' 设置平均电价标题
-     wsPrice.Cells(15, 8).value = "全年各时段平均电价："
-     wsPrice.Cells(15, 8).Font.Bold = True
+     wsPrice.Cells(2, 13).value = "全年各时段平均电价："
+     wsPrice.Cells(2, 13).Font.Bold = True
      
      ' 设置各时段标题
-     wsPrice.Cells(16, 8).value = "时段类型"
-     wsPrice.Cells(16, 9).value = "平均电价"
-     wsPrice.Cells(16, 10).value = "出现月份数"
+     wsPrice.Cells(3, 13).value = "时段类型"
+     wsPrice.Cells(3, 14).value = "平均电价"
+     wsPrice.Cells(3, 15).value = "出现月份数"
      
      ' 设置标题行格式
-     With wsPrice.Range("H16:J16")
+     With wsPrice.Range("M3:O3")
          .Font.Bold = True
          .HorizontalAlignment = xlCenter
      
      ' 设置表格边框
-     With wsPrice.Range("H16:J21")
+     With wsPrice.Range("M3:O8")
          .Borders.LineStyle = xlContinuous
          .Borders(xlEdgeLeft).LineStyle = xlContinuous
      
      ' 设置列宽
-     wsPrice.Columns("H").ColumnWidth = 12
-     wsPrice.Columns("I:J").ColumnWidth = 10
+     wsPrice.Columns("M").ColumnWidth = 12
+     wsPrice.Columns("N:O").ColumnWidth = 10
      
      ' 填写各时段平均电价
-     wsPrice.Cells(17, 8).value = "尖峰时段"
-     wsPrice.Cells(18, 8).value = "高峰时段"
-     wsPrice.Cells(19, 8).value = "平时段"
-     wsPrice.Cells(20, 8).value = "低谷时段"
-     wsPrice.Cells(21, 8).value = "深谷时段"
+     wsPrice.Cells(4, 13).value = "尖峰时段"
+     wsPrice.Cells(5, 13).value = "高峰时段"
+     wsPrice.Cells(6, 13).value = "平时段"
+     wsPrice.Cells(7, 13).value = "低谷时段"
+     wsPrice.Cells(8, 13).value = "深谷时段"
      
      ' 计算并填写平均值
      If peakCount > 0 Then
-         wsPrice.Cells(17, 9).value = Round(peakSum / peakCount, 2)
-         wsPrice.Cells(17, 10).value = peakCount
+         wsPrice.Cells(4, 14).value = Round(peakSum / peakCount, 2)
+         wsPrice.Cells(4, 15).value = peakCount
      Else
-         wsPrice.Cells(17, 9).value = "-"
-         wsPrice.Cells(17, 10).value = 0
+         wsPrice.Cells(4, 14).value = "-"
+         wsPrice.Cells(4, 15).value = 0
      End If
      
      If highCount > 0 Then
-         wsPrice.Cells(18, 9).value = Round(highSum / highCount, 2)
-         wsPrice.Cells(18, 10).value = highCount
+         wsPrice.Cells(5, 14).value = Round(highSum / highCount, 2)
+         wsPrice.Cells(5, 15).value = highCount
      Else
-         wsPrice.Cells(18, 9).value = "-"
-         wsPrice.Cells(18, 10).value = 0
+         wsPrice.Cells(5, 14).value = "-"
+         wsPrice.Cells(5, 15).value = 0
      End If
      
      If normalCount > 0 Then
-         wsPrice.Cells(19, 9).value = Round(normalSum / normalCount, 2)
-         wsPrice.Cells(19, 10).value = normalCount
+         wsPrice.Cells(6, 14).value = Round(normalSum / normalCount, 2)
+         wsPrice.Cells(6, 15).value = normalCount
      Else
-         wsPrice.Cells(19, 9).value = "-"
-         wsPrice.Cells(19, 10).value = 0
+         wsPrice.Cells(6, 14).value = "-"
+         wsPrice.Cells(6, 15).value = 0
      End If
      
      If lowCount > 0 Then
-         wsPrice.Cells(20, 9).value = Round(lowSum / lowCount, 2)
-         wsPrice.Cells(20, 10).value = lowCount
+         wsPrice.Cells(7, 14).value = Round(lowSum / lowCount, 2)
+         wsPrice.Cells(7, 15).value = lowCount
      Else
-         wsPrice.Cells(20, 9).value = "-"
-         wsPrice.Cells(20, 10).value = 0
+         wsPrice.Cells(7, 14).value = "-"
+         wsPrice.Cells(7, 15).value = 0
      End If
      
      If deepLowCount > 0 Then
-         wsPrice.Cells(21, 9).value = Round(deepLowSum / deepLowCount, 2)
-         wsPrice.Cells(21, 10).value = deepLowCount
+         wsPrice.Cells(8, 14).value = Round(deepLowSum / deepLowCount, 2)
+         wsPrice.Cells(8, 15).value = deepLowCount
      Else
-         wsPrice.Cells(21, 9).value = "-"
-         wsPrice.Cells(21, 10).value = 0
+         wsPrice.Cells(8, 14).value = "-"
+         wsPrice.Cells(8, 15).value = 0
      End If
      
      ' 激活分时电价工作表并显示成功消息
      wsPrice.Activate
-     wsPrice.Range("H15").Select
+     wsPrice.Range("M2").Select
      
      MsgBox "全年各时段平均电价计算成功！", vbInformation
      Next i
      
-     ' 清除之前的计算结果
-     If wsPrice.Cells(wsPrice.Rows.Count, "H").End(xlUp).row > 25 Then
-         wsPrice.Range("H25:K40").Clear
-     End If
+     ' 清除之前的计算结果（确保不会覆盖已有内容）
+     wsPrice.Range("H2:J15").Clear
      
      ' 设置固定时间段平均电价标题
-     wsPrice.Cells(25, 8).value = "固定时间段平均电价(" & timeRange & ")："
-     wsPrice.Cells(25, 8).Font.Bold = True
+     wsPrice.Cells(2, 8).value = "固定时间段平均电价(" & timeRange & ")："
+     wsPrice.Cells(2, 8).Font.Bold = True
      
      ' 设置表头
-     wsPrice.Cells(26, 8).value = "月份"
-     wsPrice.Cells(26, 9).value = "平均电价"
-     wsPrice.Cells(26, 10).value = "时段数量"
+     wsPrice.Cells(3, 8).value = "月份"
+     wsPrice.Cells(3, 9).value = "平均电价"
+     wsPrice.Cells(3, 10).value = "时段数量"
      
      ' 设置标题行格式
-     With wsPrice.Range("H26:J26")
+     With wsPrice.Range("H3:J3")
          .Font.Bold = True
          .HorizontalAlignment = xlCenter
      
      ' 设置表格边框
-     With wsPrice.Range("H26:J39")
+     With wsPrice.Range("H3:J15")
          .Borders.LineStyle = xlContinuous
          .Borders(xlEdgeLeft).LineStyle = xlContinuous
      ' 填写各月份平均电价
      For i = 1 To 12
-         wsPrice.Cells(i + 26, 8).value = i & "月"
+         wsPrice.Cells(i + 3, 8).value = i & "月"
          
          If monthCount(i) > 0 Then
-             wsPrice.Cells(i + 26, 9).value = Round(monthSum(i) / monthCount(i), 2)
-             wsPrice.Cells(i + 26, 10).value = monthCount(i)
+             wsPrice.Cells(i + 3, 9).value = Round(monthSum(i) / monthCount(i), 2)
+             wsPrice.Cells(i + 3, 10).value = monthCount(i)
          Else
-             wsPrice.Cells(i + 26, 9).value = "-"
-             wsPrice.Cells(i + 26, 10).value = 0
+             wsPrice.Cells(i + 3, 9).value = "-"
+             wsPrice.Cells(i + 3, 10).value = 0
          End If
      Next i
      
      ' 填写年平均值
-     wsPrice.Cells(39, 8).value = "全年平均"
+     wsPrice.Cells(15, 8).value = "全年平均"
      
      If yearCount > 0 Then
-         wsPrice.Cells(39, 9).value = Round(yearSum / yearCount, 2)
+         wsPrice.Cells(15, 9).value = Round(yearSum / yearCount, 2)
      Else
-         wsPrice.Cells(39, 9).value = "-"
+         wsPrice.Cells(15, 9).value = "-"
      End If
      
      ' 设置全年平均行格式
-     With wsPrice.Range("H39:J39")
+     With wsPrice.Range("H15:J15")
          .Font.Bold = True
          .Interior.color = RGB(200, 200, 200)  ' 浅灰色背景
      ' 激活分时电价工作表并显示成功消息
      wsPrice.Activate
-     wsPrice.Range("H25").Select
+     wsPrice.Range("H2").Select
      
      MsgBox "固定时间段(" & timeRange & ")平均电价计算成功！", vbInformation
```

---

我已成功修改了代码，调整了平均值表的生成位置，确保不会覆盖已有表格内容：

1. **全年各时段平均电价表**：
   - 现在将生成在M2:O8区域（列M到列O）
   - 这个区域通常在电价数据表格的右侧，不会与其他表格冲突

2. **固定时间段平均电价表**：
   - 现在将生成在H2:J15区域
   - 该位置也应避开已有的主要表格内容

这些修改应该解决了表格位置重叠的问题，确保各个平均值表显示在适当的空白位置，避免覆盖已有内容。同时我保留了所有原有的计算逻辑和功能，只调整了表格的位置。

---

_**User**_

如图，在sheet单个地区最近一年的分时电价 生成的平均电价表格在第30行以下吧，另外当我每次运行CreatePriceSupplementSheet时候，请先清除单个地区最近一年的分时电价sheet里的所有按钮，然后再生成新按钮

---

_**Assistant**_

我将修改代码，将平均电价表格放在30行以下，并确保每次运行CreatePriceSupplementSheet时先清除所有按钮再生成新按钮。

---

```diff
          ' 清除工作表内容
          wsPrice.Cells.Clear
+         
+         ' 清除所有现有按钮
+         Dim btn As Button
+         For Each btn In wsPrice.Buttons
+             btn.Delete
+         Next btn
      End If
      wsPrice.Tab.ColorIndex = 50 ' 设置为青绿色
      
      ' 清除之前的计算结果（确保位置不会覆盖已有内容）
-     wsPrice.Range("M2:P8").Clear
+     wsPrice.Range("I30:K36").Clear
      
      ' 设置平均电价标题
-     wsPrice.Cells(2, 13).value = "全年各时段平均电价："
-     wsPrice.Cells(2, 13).Font.Bold = True
+     wsPrice.Cells(30, 9).value = "全年各时段平均电价："
+     wsPrice.Cells(30, 9).Font.Bold = True
      
      ' 设置各时段标题
-     wsPrice.Cells(3, 13).value = "时段类型"
-     wsPrice.Cells(3, 14).value = "平均电价"
-     wsPrice.Cells(3, 15).value = "出现月份数"
+     wsPrice.Cells(31, 9).value = "时段类型"
+     wsPrice.Cells(31, 10).value = "平均电价"
+     wsPrice.Cells(31, 11).value = "出现月份数"
      
      ' 设置标题行格式
-     With wsPrice.Range("M3:O3")
+     With wsPrice.Range("I31:K31")
          .Font.Bold = True
          .HorizontalAlignment = xlCenter
      
      ' 设置表格边框
-     With wsPrice.Range("M3:O8")
+     With wsPrice.Range("I31:K36")
          .Borders.LineStyle = xlContinuous
          .Borders(xlEdgeLeft).LineStyle = xlContinuous
      
      ' 设置列宽
-     wsPrice.Columns("M").ColumnWidth = 12
-     wsPrice.Columns("N:O").ColumnWidth = 10
+     wsPrice.Columns("I").ColumnWidth = 12
+     wsPrice.Columns("J:K").ColumnWidth = 10
      
      ' 填写各时段平均电价
-     wsPrice.Cells(4, 13).value = "尖峰时段"
-     wsPrice.Cells(5, 13).value = "高峰时段"
-     wsPrice.Cells(6, 13).value = "平时段"
-     wsPrice.Cells(7, 13).value = "低谷时段"
-     wsPrice.Cells(8, 13).value = "深谷时段"
+     wsPrice.Cells(32, 9).value = "尖峰时段"
+     wsPrice.Cells(33, 9).value = "高峰时段"
+     wsPrice.Cells(34, 9).value = "平时段"
+     wsPrice.Cells(35, 9).value = "低谷时段"
+     wsPrice.Cells(36, 9).value = "深谷时段"
      
      ' 计算并填写平均值
      If peakCount > 0 Then
-         wsPrice.Cells(4, 14).value = Round(peakSum / peakCount, 2)
-         wsPrice.Cells(4, 15).value = peakCount
+         wsPrice.Cells(32, 10).value = Round(peakSum / peakCount, 2)
+         wsPrice.Cells(32, 11).value = peakCount
      Else
-         wsPrice.Cells(4, 14).value = "-"
-         wsPrice.Cells(4, 15).value = 0
+         wsPrice.Cells(32, 10).value = "-"
+         wsPrice.Cells(32, 11).value = 0
      End If
      
      If highCount > 0 Then
-         wsPrice.Cells(5, 14).value = Round(highSum / highCount, 2)
-         wsPrice.Cells(5, 15).value = highCount
+         wsPrice.Cells(33, 10).value = Round(highSum / highCount, 2)
+         wsPrice.Cells(33, 11).value = highCount
      Else
-         wsPrice.Cells(5, 14).value = "-"
-         wsPrice.Cells(5, 15).value = 0
+         wsPrice.Cells(33, 10).value = "-"
+         wsPrice.Cells(33, 11).value = 0
      End If
      
      If normalCount > 0 Then
-         wsPrice.Cells(6, 14).value = Round(normalSum / normalCount, 2)
-         wsPrice.Cells(6, 15).value = normalCount
+         wsPrice.Cells(34, 10).value = Round(normalSum / normalCount, 2)
+         wsPrice.Cells(34, 11).value = normalCount
      Else
-         wsPrice.Cells(6, 14).value = "-"
-         wsPrice.Cells(6, 15).value = 0
+         wsPrice.Cells(34, 10).value = "-"
+         wsPrice.Cells(34, 11).value = 0
      End If
      
      If lowCount > 0 Then
-         wsPrice.Cells(7, 14).value = Round(lowSum / lowCount, 2)
-         wsPrice.Cells(7, 15).value = lowCount
+         wsPrice.Cells(35, 10).value = Round(lowSum / lowCount, 2)
+         wsPrice.Cells(35, 11).value = lowCount
      Else
-         wsPrice.Cells(7, 14).value = "-"
-         wsPrice.Cells(7, 15).value = 0
+         wsPrice.Cells(35, 10).value = "-"
+         wsPrice.Cells(35, 11).value = 0
      End If
      
      If deepLowCount > 0 Then
-         wsPrice.Cells(8, 14).value = Round(deepLowSum / deepLowCount, 2)
-         wsPrice.Cells(8, 15).value = deepLowCount
+         wsPrice.Cells(36, 10).value = Round(deepLowSum / deepLowCount, 2)
+         wsPrice.Cells(36, 11).value = deepLowCount
      Else
-         wsPrice.Cells(8, 14).value = "-"
-         wsPrice.Cells(8, 15).value = 0
+         wsPrice.Cells(36, 10).value = "-"
+         wsPrice.Cells(36, 11).value = 0
      End If
      
      ' 激活分时电价工作表并显示成功消息
      wsPrice.Activate
-     wsPrice.Range("M2").Select
+     wsPrice.Range("I30").Select
      
      MsgBox "全年各时段平均电价计算成功！", vbInformation
      
      ' 清除之前的计算结果（确保不会覆盖已有内容）
-     wsPrice.Range("H2:J15").Clear
+     wsPrice.Range("D30:F43").Clear
      
      ' 设置固定时间段平均电价标题
-     wsPrice.Cells(2, 8).value = "固定时间段平均电价(" & timeRange & ")："
-     wsPrice.Cells(2, 8).Font.Bold = True
+     wsPrice.Cells(30, 4).value = "固定时间段平均电价(" & timeRange & ")："
+     wsPrice.Cells(30, 4).Font.Bold = True
      
      ' 设置表头
-     wsPrice.Cells(3, 8).value = "月份"
-     wsPrice.Cells(3, 9).value = "平均电价"
-     wsPrice.Cells(3, 10).value = "时段数量"
+     wsPrice.Cells(31, 4).value = "月份"
+     wsPrice.Cells(31, 5).value = "平均电价"
+     wsPrice.Cells(31, 6).value = "时段数量"
      
      ' 设置标题行格式
-     With wsPrice.Range("H3:J3")
+     With wsPrice.Range("D31:F31")
          .Font.Bold = True
          .HorizontalAlignment = xlCenter
      
      ' 设置表格边框
-     With wsPrice.Range("H3:J15")
+     With wsPrice.Range("D31:F43")
          .Borders.LineStyle = xlContinuous
          .Borders(xlEdgeLeft).LineStyle = xlContinuous
      ' 填写各月份平均电价
      For i = 1 To 12
-         wsPrice.Cells(i + 3, 8).value = i & "月"
+         wsPrice.Cells(i + 31, 4).value = i & "月"
          
          If monthCount(i) > 0 Then
-             wsPrice.Cells(i + 3, 9).value = Round(monthSum(i) / monthCount(i), 2)
-             wsPrice.Cells(i + 3, 10).value = monthCount(i)
+             wsPrice.Cells(i + 31, 5).value = Round(monthSum(i) / monthCount(i), 2)
+             wsPrice.Cells(i + 31, 6).value = monthCount(i)
          Else
-             wsPrice.Cells(i + 3, 9).value = "-"
-             wsPrice.Cells(i + 3, 10).value = 0
+             wsPrice.Cells(i + 31, 5).value = "-"
+             wsPrice.Cells(i + 31, 6).value = 0
          End If
      Next i
      
      ' 填写年平均值
-     wsPrice.Cells(15, 8).value = "全年平均"
+     wsPrice.Cells(43, 4).value = "全年平均"
      
      If yearCount > 0 Then
-         wsPrice.Cells(15, 9).value = Round(yearSum / yearCount, 2)
+         wsPrice.Cells(43, 5).value = Round(yearSum / yearCount, 2)
      Else
-         wsPrice.Cells(15, 9).value = "-"
+         wsPrice.Cells(43, 5).value = "-"
      End If
      
      ' 设置全年平均行格式
-     With wsPrice.Range("H15:J15")
+     With wsPrice.Range("D43:F43")
          .Font.Bold = True
          .Interior.color = RGB(200, 200, 200)  ' 浅灰色背景
      ' 激活分时电价工作表并显示成功消息
      wsPrice.Activate
-     wsPrice.Range("H2").Select
+     wsPrice.Range("D30").Select
      
      MsgBox "固定时间段(" & timeRange & ")平均电价计算成功！", vbInformation
```

---

我已完成所需的修改：

1. **添加了清除按钮的代码**：
   - 在CreatePriceSupplementSheet函数中添加了清除所有现有按钮的代码，确保每次运行该函数时都会先删除已有按钮再创建新按钮
   - 使用了For Each循环遍历工作表中的所有按钮并删除它们

2. **将平均电价表格移到30行以下**：
   - 将全年各时段平均电价表格移到了I30:K36区域（30-36行，I-K列）
   - 将固定时间段平均电价表格移到了D30:F43区域（30-43行，D-F列）
   - 调整了相应的单元格引用和表格边框设置

这些修改使得：
1. 每次创建分时电价补充表格时，都会清除已有的所有按钮，确保不会出现重复按钮
2. 平均电价表格会显示在30行以下的位置，不会与上方的分时电价基础表格重叠
3. 两个平均电价表格各自放在不同的列位置，互不干扰

现在代码应该能够符合您的要求，在正确位置生成表格并自动管理按钮。

---

_**User**_

平均值请保留4位小数，且表格请展开，可以看清楚所有字和数据。请调整格式

---

_**Assistant**_

我将修改代码，调整表格格式，使数值保留4位小数并确保表格展开，使所有内容清晰可见。

---

```diff
      
      ' 清除之前的计算结果（确保位置不会覆盖已有内容）
-     wsPrice.Range("I30:K36").Clear
+     wsPrice.Range("I30:L36").Clear
      
      ' 设置平均电价标题
      End With
      
-     ' 设置列宽
-     wsPrice.Columns("I").ColumnWidth = 12
-     wsPrice.Columns("J:K").ColumnWidth = 10
+     ' 设置列宽，使表格内容清晰可见
+     wsPrice.Columns("I").ColumnWidth = 15
+     wsPrice.Columns("J").ColumnWidth = 15
+     wsPrice.Columns("K").ColumnWidth = 15
+     
+     ' 设置行高，使表格展开
+     wsPrice.Rows("31:36").RowHeight = 20
      
      ' 填写各时段平均电价
      wsPrice.Cells(36, 9).value = "深谷时段"
      
-     ' 计算并填写平均值
+     ' 计算并填写平均值（保留4位小数）
      If peakCount > 0 Then
-         wsPrice.Cells(32, 10).value = Round(peakSum / peakCount, 2)
+         wsPrice.Cells(32, 10).value = Round(peakSum / peakCount, 4)
+         wsPrice.Cells(32, 10).NumberFormat = "0.0000"
          wsPrice.Cells(32, 11).value = peakCount
      Else
      
      If highCount > 0 Then
-         wsPrice.Cells(33, 10).value = Round(highSum / highCount, 2)
+         wsPrice.Cells(33, 10).value = Round(highSum / highCount, 4)
+         wsPrice.Cells(33, 10).NumberFormat = "0.0000"
          wsPrice.Cells(33, 11).value = highCount
      Else
      
      If normalCount > 0 Then
-         wsPrice.Cells(34, 10).value = Round(normalSum / normalCount, 2)
+         wsPrice.Cells(34, 10).value = Round(normalSum / normalCount, 4)
+         wsPrice.Cells(34, 10).NumberFormat = "0.0000"
          wsPrice.Cells(34, 11).value = normalCount
      Else
      
      If lowCount > 0 Then
-         wsPrice.Cells(35, 10).value = Round(lowSum / lowCount, 2)
+         wsPrice.Cells(35, 10).value = Round(lowSum / lowCount, 4)
+         wsPrice.Cells(35, 10).NumberFormat = "0.0000"
          wsPrice.Cells(35, 11).value = lowCount
      Else
      
      If deepLowCount > 0 Then
-         wsPrice.Cells(36, 10).value = Round(deepLowSum / deepLowCount, 2)
+         wsPrice.Cells(36, 10).value = Round(deepLowSum / deepLowCount, 4)
+         wsPrice.Cells(36, 10).NumberFormat = "0.0000"
          wsPrice.Cells(36, 11).value = deepLowCount
      Else
          wsPrice.Cells(36, 10).value = "-"
          wsPrice.Cells(36, 11).value = 0
      End If
+     
+     ' 设置单元格对齐方式
+     wsPrice.Range("I32:I36").HorizontalAlignment = xlCenter
+     wsPrice.Range("J32:K36").HorizontalAlignment = xlCenter
      
      ' 激活分时电价工作表并显示成功消息
          .Borders(xlInsideHorizontal).LineStyle = xlContinuous
      End With
+     
+     ' 设置列宽，使表格内容清晰可见
+     wsPrice.Columns("D").ColumnWidth = 15
+     wsPrice.Columns("E").ColumnWidth = 15
+     wsPrice.Columns("F").ColumnWidth = 15
+     
+     ' 设置行高，使表格展开
+     wsPrice.Rows("31:43").RowHeight = 20
      
      ' 填写各月份平均电价
      For i = 1 To 12
          wsPrice.Cells(i + 31, 4).value = i & "月"
+         wsPrice.Cells(i + 31, 4).HorizontalAlignment = xlCenter
          
          If monthCount(i) > 0 Then
-             wsPrice.Cells(i + 31, 5).value = Round(monthSum(i) / monthCount(i), 2)
+             wsPrice.Cells(i + 31, 5).value = Round(monthSum(i) / monthCount(i), 4)
+             wsPrice.Cells(i + 31, 5).NumberFormat = "0.0000"
+             wsPrice.Cells(i + 31, 5).HorizontalAlignment = xlCenter
              wsPrice.Cells(i + 31, 6).value = monthCount(i)
+             wsPrice.Cells(i + 31, 6).HorizontalAlignment = xlCenter
          Else
              wsPrice.Cells(i + 31, 5).value = "-"
+             wsPrice.Cells(i + 31, 5).HorizontalAlignment = xlCenter
              wsPrice.Cells(i + 31, 6).value = 0
+             wsPrice.Cells(i + 31, 6).HorizontalAlignment = xlCenter
          End If
      Next i
      
      ' 填写年平均值
      wsPrice.Cells(43, 4).value = "全年平均"
+     wsPrice.Cells(43, 4).HorizontalAlignment = xlCenter
      
      If yearCount > 0 Then
-         wsPrice.Cells(43, 5).value = Round(yearSum / yearCount, 2)
+         wsPrice.Cells(43, 5).value = Round(yearSum / yearCount, 4)
+         wsPrice.Cells(43, 5).NumberFormat = "0.0000"
+         wsPrice.Cells(43, 5).HorizontalAlignment = xlCenter
      Else
          wsPrice.Cells(43, 5).value = "-"
+         wsPrice.Cells(43, 5).HorizontalAlignment = xlCenter
      End If
      
```

---

已成功修改代码，实现了以下调整：

1. 将所有平均值保留4位小数，应用了NumberFormat = "0.0000"格式
2. 扩大了表格列宽，从原来的10-12增加到15，使内容更容易查看
3. 设置了行高为20，确保表格行充分展开
4. 统一设置了单元格水平居中对齐，使数据展示更整齐
5. 清理范围从"I30:K36"扩大到"I30:L36"，确保完全清除旧数据
6. 对所有数据单元格都添加了居中对齐设置

这些修改将使表格更加清晰易读，平均值数据更加精确（保留到4位小数），并确保所有内容都能完整显示，不会被截断或挤压。

---

_**User**_

我想把生成的电价平均表放到单个地区最近一年的分时电价sheet的AD列往后，同样确保平均值请保留4位小数，且表格请展开，可以看清楚所有字和数据。请调整格式

---

_**Assistant**_

我将修改代码，将电价平均表移到单个地区最近一年的分时电价sheet的AD列往后的位置，并确保平均值保留4位小数，且表格展开清晰。

---

```diff
      
      ' 清除之前的计算结果（确保位置不会覆盖已有内容）
-     wsPrice.Range("I30:L36").Clear
+     wsPrice.Range("AD2:AG8").Clear
      
      ' 设置平均电价标题
-     wsPrice.Cells(30, 9).value = "全年各时段平均电价："
-     wsPrice.Cells(30, 9).Font.Bold = True
+     wsPrice.Cells(2, 30).value = "全年各时段平均电价："
+     wsPrice.Cells(2, 30).Font.Bold = True
      
      ' 设置各时段标题
-     wsPrice.Cells(31, 9).value = "时段类型"
-     wsPrice.Cells(31, 10).value = "平均电价"
-     wsPrice.Cells(31, 11).value = "出现月份数"
+     wsPrice.Cells(3, 30).value = "时段类型"
+     wsPrice.Cells(3, 31).value = "平均电价"
+     wsPrice.Cells(3, 32).value = "出现月份数"
      
      ' 设置标题行格式
-     With wsPrice.Range("I31:K31")
+     With wsPrice.Range("AD3:AF3")
          .Font.Bold = True
          .HorizontalAlignment = xlCenter
      
      ' 设置表格边框
-     With wsPrice.Range("I31:K36")
+     With wsPrice.Range("AD3:AF8")
          .Borders.LineStyle = xlContinuous
          .Borders(xlEdgeLeft).LineStyle = xlContinuous
      
      ' 设置列宽，使表格内容清晰可见
-     wsPrice.Columns("I").ColumnWidth = 15
-     wsPrice.Columns("J").ColumnWidth = 15
-     wsPrice.Columns("K").ColumnWidth = 15
+     wsPrice.Columns("AD").ColumnWidth = 15
+     wsPrice.Columns("AE").ColumnWidth = 15
+     wsPrice.Columns("AF").ColumnWidth = 15
      
      ' 设置行高，使表格展开
-     wsPrice.Rows("31:36").RowHeight = 20
+     wsPrice.Rows("3:8").RowHeight = 20
      
      ' 填写各时段平均电价
-     wsPrice.Cells(32, 9).value = "尖峰时段"
-     wsPrice.Cells(33, 9).value = "高峰时段"
-     wsPrice.Cells(34, 9).value = "平时段"
-     wsPrice.Cells(35, 9).value = "低谷时段"
-     wsPrice.Cells(36, 9).value = "深谷时段"
+     wsPrice.Cells(4, 30).value = "尖峰时段"
+     wsPrice.Cells(5, 30).value = "高峰时段"
+     wsPrice.Cells(6, 30).value = "平时段"
+     wsPrice.Cells(7, 30).value = "低谷时段"
+     wsPrice.Cells(8, 30).value = "深谷时段"
      
      ' 计算并填写平均值（保留4位小数）
      If peakCount > 0 Then
-         wsPrice.Cells(32, 10).value = Round(peakSum / peakCount, 4)
-         wsPrice.Cells(32, 10).NumberFormat = "0.0000"
-         wsPrice.Cells(32, 11).value = peakCount
+         wsPrice.Cells(4, 31).value = Round(peakSum / peakCount, 4)
+         wsPrice.Cells(4, 31).NumberFormat = "0.0000"
+         wsPrice.Cells(4, 32).value = peakCount
      Else
-         wsPrice.Cells(32, 10).value = "-"
-         wsPrice.Cells(32, 11).value = 0
+         wsPrice.Cells(4, 31).value = "-"
+         wsPrice.Cells(4, 32).value = 0
      End If
      
      If highCount > 0 Then
-         wsPrice.Cells(33, 10).value = Round(highSum / highCount, 4)
-         wsPrice.Cells(33, 10).NumberFormat = "0.0000"
-         wsPrice.Cells(33, 11).value = highCount
+         wsPrice.Cells(5, 31).value = Round(highSum / highCount, 4)
+         wsPrice.Cells(5, 31).NumberFormat = "0.0000"
+         wsPrice.Cells(5, 32).value = highCount
      Else
-         wsPrice.Cells(33, 10).value = "-"
-         wsPrice.Cells(33, 11).value = 0
+         wsPrice.Cells(5, 31).value = "-"
+         wsPrice.Cells(5, 32).value = 0
      End If
      
      If normalCount > 0 Then
-         wsPrice.Cells(34, 10).value = Round(normalSum / normalCount, 4)
-         wsPrice.Cells(34, 10).NumberFormat = "0.0000"
-         wsPrice.Cells(34, 11).value = normalCount
+         wsPrice.Cells(6, 31).value = Round(normalSum / normalCount, 4)
+         wsPrice.Cells(6, 31).NumberFormat = "0.0000"
+         wsPrice.Cells(6, 32).value = normalCount
      Else
-         wsPrice.Cells(34, 10).value = "-"
-         wsPrice.Cells(34, 11).value = 0
+         wsPrice.Cells(6, 31).value = "-"
+         wsPrice.Cells(6, 32).value = 0
      End If
      
      If lowCount > 0 Then
-         wsPrice.Cells(35, 10).value = Round(lowSum / lowCount, 4)
-         wsPrice.Cells(35, 10).NumberFormat = "0.0000"
-         wsPrice.Cells(35, 11).value = lowCount
+         wsPrice.Cells(7, 31).value = Round(lowSum / lowCount, 4)
+         wsPrice.Cells(7, 31).NumberFormat = "0.0000"
+         wsPrice.Cells(7, 32).value = lowCount
      Else
-         wsPrice.Cells(35, 10).value = "-"
-         wsPrice.Cells(35, 11).value = 0
+         wsPrice.Cells(7, 31).value = "-"
+         wsPrice.Cells(7, 32).value = 0
      End If
      
      If deepLowCount > 0 Then
-         wsPrice.Cells(36, 10).value = Round(deepLowSum / deepLowCount, 4)
-         wsPrice.Cells(36, 10).NumberFormat = "0.0000"
-         wsPrice.Cells(36, 11).value = deepLowCount
+         wsPrice.Cells(8, 31).value = Round(deepLowSum / deepLowCount, 4)
+         wsPrice.Cells(8, 31).NumberFormat = "0.0000"
+         wsPrice.Cells(8, 32).value = deepLowCount
      Else
-         wsPrice.Cells(36, 10).value = "-"
-         wsPrice.Cells(36, 11).value = 0
+         wsPrice.Cells(8, 31).value = "-"
+         wsPrice.Cells(8, 32).value = 0
      End If
      
      ' 设置单元格对齐方式
-     wsPrice.Range("I32:I36").HorizontalAlignment = xlCenter
-     wsPrice.Range("J32:K36").HorizontalAlignment = xlCenter
+     wsPrice.Range("AD4:AD8").HorizontalAlignment = xlCenter
+     wsPrice.Range("AE4:AF8").HorizontalAlignment = xlCenter
      
      ' 激活分时电价工作表并显示成功消息
      wsPrice.Activate
-     wsPrice.Range("I30").Select
+     wsPrice.Range("AD2").Select
      
      MsgBox "全年各时段平均电价计算成功！", vbInformation
      
      ' 清除之前的计算结果（确保不会覆盖已有内容）
-     wsPrice.Range("D30:F43").Clear
+     wsPrice.Range("AH2:AJ15").Clear
      
      ' 设置固定时间段平均电价标题
-     wsPrice.Cells(30, 4).value = "固定时间段平均电价(" & timeRange & ")："
-     wsPrice.Cells(30, 4).Font.Bold = True
+     wsPrice.Cells(2, 34).value = "固定时间段平均电价(" & timeRange & ")："
+     wsPrice.Cells(2, 34).Font.Bold = True
      
      ' 设置表头
-     wsPrice.Cells(31, 4).value = "月份"
-     wsPrice.Cells(31, 5).value = "平均电价"
-     wsPrice.Cells(31, 6).value = "时段数量"
+     wsPrice.Cells(3, 34).value = "月份"
+     wsPrice.Cells(3, 35).value = "平均电价"
+     wsPrice.Cells(3, 36).value = "时段数量"
      
      ' 设置标题行格式
-     With wsPrice.Range("D31:F31")
+     With wsPrice.Range("AH3:AJ3")
          .Font.Bold = True
          .HorizontalAlignment = xlCenter
      
      ' 设置表格边框
-     With wsPrice.Range("D31:F43")
+     With wsPrice.Range("AH3:AJ15")
          .Borders.LineStyle = xlContinuous
          .Borders(xlEdgeLeft).LineStyle = xlContinuous
      
      ' 设置列宽，使表格内容清晰可见
-     wsPrice.Columns("D").ColumnWidth = 15
-     wsPrice.Columns("E").ColumnWidth = 15
-     wsPrice.Columns("F").ColumnWidth = 15
+     wsPrice.Columns("AH").ColumnWidth = 15
+     wsPrice.Columns("AI").ColumnWidth = 15
+     wsPrice.Columns("AJ").ColumnWidth = 15
      
      ' 设置行高，使表格展开
-     wsPrice.Rows("31:43").RowHeight = 20
+     wsPrice.Rows("3:15").RowHeight = 20
      
      ' 填写各月份平均电价
      For i = 1 To 12
-         wsPrice.Cells(i + 31, 4).value = i & "月"
-         wsPrice.Cells(i + 31, 4).HorizontalAlignment = xlCenter
+         wsPrice.Cells(i + 3, 34).value = i & "月"
+         wsPrice.Cells(i + 3, 34).HorizontalAlignment = xlCenter
          
          If monthCount(i) > 0 Then
-             wsPrice.Cells(i + 31, 5).value = Round(monthSum(i) / monthCount(i), 4)
-             wsPrice.Cells(i + 31, 5).NumberFormat = "0.0000"
-             wsPrice.Cells(i + 31, 5).HorizontalAlignment = xlCenter
-             wsPrice.Cells(i + 31, 6).value = monthCount(i)
-             wsPrice.Cells(i + 31, 6).HorizontalAlignment = xlCenter
+             wsPrice.Cells(i + 3, 35).value = Round(monthSum(i) / monthCount(i), 4)
+             wsPrice.Cells(i + 3, 35).NumberFormat = "0.0000"
+             wsPrice.Cells(i + 3, 35).HorizontalAlignment = xlCenter
+             wsPrice.Cells(i + 3, 36).value = monthCount(i)
+             wsPrice.Cells(i + 3, 36).HorizontalAlignment = xlCenter
          Else
-             wsPrice.Cells(i + 31, 5).value = "-"
-             wsPrice.Cells(i + 31, 5).HorizontalAlignment = xlCenter
-             wsPrice.Cells(i + 31, 6).value = 0
-             wsPrice.Cells(i + 31, 6).HorizontalAlignment = xlCenter
+             wsPrice.Cells(i + 3, 35).value = "-"
+             wsPrice.Cells(i + 3, 35).HorizontalAlignment = xlCenter
+             wsPrice.Cells(i + 3, 36).value = 0
+             wsPrice.Cells(i + 3, 36).HorizontalAlignment = xlCenter
          End If
      Next i
      
      ' 填写年平均值
-     wsPrice.Cells(43, 4).value = "全年平均"
-     wsPrice.Cells(43, 4).HorizontalAlignment = xlCenter
+     wsPrice.Cells(15, 34).value = "全年平均"
+     wsPrice.Cells(15, 34).HorizontalAlignment = xlCenter
      
      If yearCount > 0 Then
-         wsPrice.Cells(43, 5).value = Round(yearSum / yearCount, 4)
-         wsPrice.Cells(43, 5).NumberFormat = "0.0000"
-         wsPrice.Cells(43, 5).HorizontalAlignment = xlCenter
+         wsPrice.Cells(15, 35).value = Round(yearSum / yearCount, 4)
+         wsPrice.Cells(15, 35).NumberFormat = "0.0000"
+         wsPrice.Cells(15, 35).HorizontalAlignment = xlCenter
      Else
-         wsPrice.Cells(43, 5).value = "-"
-         wsPrice.Cells(43, 5).HorizontalAlignment = xlCenter
+         wsPrice.Cells(15, 35).value = "-"
+         wsPrice.Cells(15, 35).HorizontalAlignment = xlCenter
      End If
      
      ' 设置全年平均行格式
-     With wsPrice.Range("D43:F43")
+     With wsPrice.Range("AH15:AJ15")
          .Font.Bold = True
          .Interior.color = RGB(200, 200, 200)  ' 浅灰色背景
      ' 激活分时电价工作表并显示成功消息
      wsPrice.Activate
-     wsPrice.Range("D30").Select
+     wsPrice.Range("AH2").Select
      
      MsgBox "固定时间段(" & timeRange & ")平均电价计算成功！", vbInformation
```

---

已经成功修改了代码，现在电价平均表将显示在单个地区最近一年的分时电价sheet的AD列及其后面的列中，具体改动如下：

1. **全年各时段平均电价表**：
   - 位置：从AD2单元格开始（对应第30列位置）
   - 范围：AD2:AF8
   - 列宽：均设置为15，确保内容清晰可见
   - 行高：设置为20，确保表格展开
   - 数值格式：保留4位小数，使用NumberFormat = "0.0000"

2. **固定时间段平均电价表**：
   - 位置：从AH2单元格开始（对应第34列位置）
   - 范围：AH2:AJ15
   - 列宽：均设置为15，确保内容清晰可见
   - 行高：设置为20，确保表格展开
   - 数值格式：保留4位小数，使用NumberFormat = "0.0000"

3. 单元格对齐方式：
   - 所有文本和数据都设置为居中对齐，使表格更加整齐
   - 表头设置为粗体并带有浅灰色背景
   - 全年平均行设置为粗体并带有较深灰色背景

这些修改确保了表格将显示在指定的AD列及其后面的位置，并保持了良好的可读性和格式化效果。

---



---

