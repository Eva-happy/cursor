<!-- Generated by SpecStory -->

# 云南省Excel模板修改讨论 (2025-02-06 13:23:46)

_**User**_

在这个文件基础上，针对云南省是有特殊处理的步骤，现在请针对云南省的excel格式模版生成做出修改

---

_**Assistant**_

我来帮你修改云南省的Excel格式模板生成部分。我会修改 `write_to_excel` 函数，添加针对云南省的特殊处理。我们需要确保云南省的电价表格式符合要求。

让我先查看一下当前的代码，然后进行修改：

---



---



让我重新尝试编辑，将内容分成几个部分：

---



---



让我继续修改write_to_excel函数：

---



---



让我再尝试一次，这次我们将修改check_and_process_content函数，以支持云南省的特殊处理：

---



---



让我们再试一次，这次我们将所有修改合并到一个编辑中：

---

Cancelled

---



---



我看到问题了。让我们尝试一个不同的方法。首先，让我们确认文件内容：

---

Read file: 电网云南省excel更改.py

---



我明白了。让我们先创建一个新的文件来存放云南省特有的函数：

---

```diff
- 
+ import pandas as pd
+ import openpyxl
+ from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
+ 
+ def adjust_yunnan_table_format(data):
+     """调整云南省表格格式"""
+     try:
+         # 检查是否是DataFrame
+         if not isinstance(data, pd.DataFrame):
+             return data
+             
+         # 重命名列（如果需要）
+         column_mapping = {
+             '用户类别': '电压等级',
+             '基本电价': '基本电费',
+             '电度电价': '电度电费'
+         }
+         data = data.rename(columns=lambda x: column_mapping.get(x, x))
+         
+         # 调整列顺序（根据云南省的要求）
+         desired_columns = ['电压等级', '基本电费', '电度电费']
+         existing_columns = [col for col in desired_columns if col in data.columns]
+         other_columns = [col for col in data.columns if col not in desired_columns]
+         data = data[existing_columns + other_columns]
+         
+         return data
+     except Exception as e:
+         print(f"调整云南省表格格式失败: {str(e)}")
+         return data
+ 
+ def apply_yunnan_styles(worksheet):
+     """应用云南省特有的样式"""
+     try:
+         # 设置标题样式
+         title_font = Font(name='宋体', size=16, bold=True)
+         title_alignment = Alignment(horizontal='center', vertical='center')
+         
+         for row in range(1, 4):
+             cell = worksheet.cell(row=row, column=1)
+             cell.font = title_font
+             cell.alignment = title_alignment
+         
+         # 设置表头样式
+         header_font = Font(name='宋体', size=12, bold=True)
+         header_fill = PatternFill(start_color='E0E0E0', end_color='E0E0E0', fill_type='solid')
+         
+         for cell in worksheet[4]:  # 第4行是表头
+             cell.font = header_font
+             cell.fill = header_fill
+             cell.alignment = Alignment(horizontal='center', vertical='center', wrap_text=True)
+         
+         # 设置数据行样式
+         data_font = Font(name='宋体', size=11)
+         data_alignment = Alignment(horizontal='center', vertical='center', wrap_text=True)
+         
+         for row in worksheet.iter_rows(min_row=5):
+             for cell in row:
+                 cell.font = data_font
+                 cell.alignment = data_alignment
+         
+         # 设置列宽
+         for column in worksheet.columns:
+             max_length = 0
+             column_letter = openpyxl.utils.get_column_letter(column[0].column)
+             
+             for cell in column:
+                 try:
+                     if cell.value:
+                         cell_length = len(str(cell.value))
+                         max_length = max(max_length, cell_length)
+                 except:
+                     pass
+             
+             adjusted_width = min(max_length + 4, 30)  # 限制最大宽度为30
+             worksheet.column_dimensions[column_letter].width = adjusted_width
+         
+         # 设置行高
+         worksheet.row_dimensions[1].height = 30  # 标题行
+         worksheet.row_dimensions[2].height = 25  # 副标题行
+         worksheet.row_dimensions[3].height = 25  # 单位行
+         worksheet.row_dimensions[4].height = 40  # 表头行
+         
+         # 设置默认数据行高
+         for i in range(5, worksheet.max_row + 1):
+             worksheet.row_dimensions[i].height = 30
+             
+     except Exception as e:
+         print(f"应用云南省样式失败: {str(e)}")
+ 
+ def merge_yunnan_empty_cells(worksheet, start_row, end_row, start_col, end_col, header_row=None):
+     """云南省特有的单元格合并逻辑"""
+     try:
+         # 设置边框样式
+         thin_side = Side(style='thin')
+         thin_border = Border(
+             left=thin_side,
+             right=thin_side,
+             top=thin_side,
+             bottom=thin_side
+         )
+         
+         # 获取特殊列的索引
+         special_merge_columns = ['电压等级', '基本电费', '电度电费']
+         special_col_indices = []
+         
+         if header_row:
+             for col in range(1, worksheet.max_column + 1):
+                 header_cell = worksheet.cell(row=header_row, column=col)
+                 if header_cell.value in special_merge_columns:
+                     special_col_indices.append(col)
+         
+         # 对特殊列应用合并规则
+         for col in special_col_indices:
+             current_value = None
+             merge_start = None
+             
+             for row in range(start_row, end_row + 1):
+                 cell = worksheet.cell(row=row, column=col)
+                 cell_value = cell.value
+                 
+                 if cell_value == current_value and cell_value is not None:
+                     continue
+                 elif merge_start and merge_start < row - 1:
+                     # 合并前面的相同值单元格
+                     worksheet.merge_cells(
+                         start_row=merge_start,
+                         end_row=row - 1,
+                         start_column=col,
+                         end_column=col
+                     )
+                     # 应用边框
+                     for r in range(merge_start, row):
+                         worksheet.cell(row=r, column=col).border = thin_border
+                 
+                 current_value = cell_value
+                 merge_start = row if cell_value is not None else None
+             
+             # 处理最后一组相同值
+             if merge_start and merge_start < end_row:
+                 worksheet.merge_cells(
+                     start_row=merge_start,
+                     end_row=end_row,
+                     start_column=col,
+                     end_column=col
+                 )
+                 # 应用边框
+                 for r in range(merge_start, end_row + 1):
+                     worksheet.cell(row=r, column=col).border = thin_border
+                 
+     except Exception as e:
+         print(f"云南省单元格合并失败: {str(e)}")
+ 
+ def add_yunnan_notes_with_title(worksheet, notes, start_row, max_col):
+     """添加云南省特有的注释格式"""
+     try:
+         if not notes:
+             return
+             
+         # 添加"注释内容"标题行
+         title_row = start_row + 1
+         title_cell = worksheet.cell(row=title_row, column=1, value="注释说明")
+         
+         # 合并标题行
+         title_range = f'A{title_row}:{openpyxl.utils.get_column_letter(max_col)}{title_row}'
+         worksheet.merge_cells(title_range)
+         
+         # 设置标题样式
+         title_font = Font(name='宋体', size=12, bold=True)
+         title_fill = PatternFill(start_color='E0E0E0', end_color='E0E0E0', fill_type='solid')
+         title_alignment = Alignment(horizontal='left', vertical='center', wrap_text=True)
+         
+         # 应用标题样式
+         title_cell.font = title_font
+         title_cell.fill = title_fill
+         title_cell.alignment = title_alignment
+         
+         # 设置注释样式
+         note_font = Font(name='宋体', size=11)
+         note_alignment = Alignment(horizontal='left', vertical='center', wrap_text=True)
+         
+         # 写入注释内容
+         for i, note in enumerate(notes, 1):
+             note_row = title_row + i
+             note_cell = worksheet.cell(row=note_row, column=1, value=note)
+             
+             # 合并注释行
+             note_range = f'A{note_row}:{openpyxl.utils.get_column_letter(max_col)}{note_row}'
+             worksheet.merge_cells(note_range)
+             
+             # 应用注释样式
+             note_cell.font = note_font
+             note_cell.alignment = note_alignment
+             
+             # 设置行高
+             worksheet.row_dimensions[note_row].height = 30
+             
+     except Exception as e:
+         print(f"添加云南省注释失败: {str(e)}")
+ 
+ def apply_yunnan_cell_format(worksheet):
+     """应用云南省特有的单元格格式"""
+     try:
+         # 设置边框样式
+         thin_border = Border(
+             left=Side(style='thin'),
+             right=Side(style='thin'),
+             top=Side(style='thin'),
+             bottom=Side(style='thin')
+         )
+         
+         # 设置对齐方式
+         center_alignment = Alignment(
+             horizontal='center',
+             vertical='center',
+             wrap_text=True
+         )
+         
+         # 设置字体
+         regular_font = Font(name='宋体', size=11)
+         
+         # 应用格式到所有单元格
+         for row in worksheet.iter_rows():
+             for cell in row:
+                 cell.border = thin_border
+                 cell.alignment = center_alignment
+                 cell.font = regular_font
+         
+         # 设置标题行特殊格式
+         title_font = Font(name='宋体', size=16, bold=True)
+         subtitle_font = Font(name='宋体', size=14, bold=True)
+         
+         for cell in worksheet[1]:
+             cell.font = title_font
+         for cell in worksheet[2:4]:
+             for c in cell:
+                 c.font = subtitle_font
+         
+         # 设置表头行特殊格式
+         header_font = Font(name='宋体', size=12, bold=True)
+         header_fill = PatternFill(start_color='E0E0E0', end_color='E0E0E0', fill_type='solid')
+         
+         for cell in worksheet[4]:
+             cell.font = header_font
+             cell.fill = header_fill
+             
+     except Exception as e:
+         print(f"应用云南省单元格格式失败: {str(e)}") 
```

---



现在让我们修改主文件中的write_to_excel函数，使其支持云南省的特殊处理：

---

```diff
  import urllib3
  import openpyxl
+ from yunnan_excel_utils import (
+     adjust_yunnan_table_format,
+     apply_yunnan_styles,
+     merge_yunnan_empty_cells,
+     add_yunnan_notes_with_title,
+     apply_yunnan_cell_format
+ )
  # 禁用SSL警告
  urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
  warnings.filterwarnings('ignore')
- def write_to_excel(all_pages_data, project_name=None):
+ def write_to_excel(all_pages_data, project_name=None, is_yunnan=False):
      """将数据写入Excel文件"""
      try:
```

---







现在让我们修改check_and_process_content函数，使其支持云南省的特殊处理：

---

```diff
              if all_pages_data:
                  print("成功提取PDF数据，开始生成Excel文件...")
-                 excel_file = write_to_excel(all_pages_data, project_name)
+                 # 传入is_yunnan=True参数，启用云南省特殊处理
+                 excel_file = write_to_excel(all_pages_data, project_name, is_yunnan=True)
                  return excel_file
              else:
```

---







现在让我们修改write_to_excel函数的主体部分，使其使用云南省特有的函数：

---

```diff
              # 如果有表格数据，写入主表数据
              if data is not None:
+                 if is_yunnan:
+                     # 云南省特殊处理：调整表格格式
+                     data = adjust_yunnan_table_format(data)
                  data.to_excel(writer, sheet_name=sheet_name, index=False, startrow=3)
              
              worksheet.merge_cells(f'A3:{openpyxl.utils.get_column_letter(worksheet.max_column)}3')
              
+             # 设置云南省特有的样式
+             if is_yunnan:
+                 apply_yunnan_styles(worksheet)
+             
              # 处理图片
              if 'images' in all_pages_data[page_index]:
              if data is not None:
                  header_row = 4
+                 if is_yunnan:
+                     merge_yunnan_empty_cells(worksheet, header_row + 1, worksheet.max_row, 1, worksheet.max_column, header_row=header_row)
+                 else:
                  merge_empty_cells(worksheet, header_row + 1, worksheet.max_row, 1, worksheet.max_column, header_row=header_row)
              
              # 写入注释
              if notes:
+                 if is_yunnan:
+                     add_yunnan_notes_with_title(worksheet, notes, worksheet.max_row, worksheet.max_column)
+                 else:
                  add_notes_with_title(worksheet, notes, worksheet.max_row, worksheet.max_column)
              
              # 应用单元格格式
+             if is_yunnan:
+                 apply_yunnan_cell_format(worksheet)
+             else:
              apply_cell_format(worksheet)
          
                  # 合并空白单元格，标题行（第4行）不合并
                  header_row = 4
+                 if is_yunnan:
+                     merge_yunnan_empty_cells(calc_sheet, header_row + 1, calc_sheet.max_row, 1, max_col, header_row=header_row)
+                 else:
                  merge_empty_cells(calc_sheet, header_row + 1, calc_sheet.max_row, 1, max_col, header_row=header_row)
              
                  notes = last_page['notes']
                  if notes:
+                     if is_yunnan:
+                         add_yunnan_notes_with_title(calc_sheet, notes, calc_sheet.max_row, calc_sheet.max_column)
+                     else:
                      add_notes_with_title(calc_sheet, notes, calc_sheet.max_row, calc_sheet.max_column)
              
              # 应用单元格格式
+             if is_yunnan:
+                 apply_yunnan_cell_format(calc_sheet)
+             else:
              apply_cell_format(calc_sheet)
          
```

---







让我修复缩进错误：

---

```diff
                          EC.element_to_be_clickable((By.XPATH, "//li[@role='menuitem']//span[text()='营商环境']"))
                      )
+                     )
  
                      if not wait_and_click_element(driver, business_env):
```

---







让我们再试一次，这次我们将分步骤进行修改。首先，让我们修复导入语句：

---



---







让我们尝试修改write_to_excel函数的签名：

---

```diff
  warnings.filterwarnings('ignore')
  def write_to_excel(all_pages_data, project_name=None, is_yunnan=False):
-     """将数据写入Excel文件"""
+     """将数据写入Excel文件
+     
+     Args:
+         all_pages_data: 所有页面的数据
+         project_name: 项目名称，用于文件命名
+         is_yunnan: 是否使用云南省特殊处理
+     """
      try:
          if not all_pages_data:
```

---











让我们尝试修复语法错误。我们需要查看完整的文件内容：

---

Read file: 电网云南省excel更改.py

---







我看到了问题所在。让我们修复缩进错误：

---

```diff
                          EC.element_to_be_clickable((By.XPATH, "//li[@role='menuitem']//span[text()='营商环境']"))
                      )
-                     )
  
                      if not wait_and_click_element(driver, business_env):
```

---











让我们尝试一个不同的方法。我们将创建一个新的文件，然后将其内容复制到原始文件中：

---

```diff
- 
+ def write_to_excel(all_pages_data, project_name=None, is_yunnan=False):
+     """将数据写入Excel文件
+     
+     Args:
+         all_pages_data: 所有页面的数据
+         project_name: 项目名称，用于文件命名
+         is_yunnan: 是否使用云南省特殊处理
+     """
+     try:
+         if not all_pages_data:
+             print("没有数据需要保存")
+             return None
+             
+         print(f"共有 {len(all_pages_data)} 页数据需要处理")
+         
+         # 创建downloads目录（如果不存在）
+         if not os.path.exists('downloads'):
+             os.makedirs('downloads')
+         
+         # 生成基础文件名
+         base_filename = project_name if project_name else f'电价表_{datetime.now().strftime("%Y%m%d_%H%M%S")}'
+         
+         # 检查是否存在同名文件，并添加版本号
+         version = 1
+         while True:
+             excel_file = os.path.join('downloads', f'{base_filename}V{version}.xlsx')
+             if not os.path.exists(excel_file):
+                 break
+             version += 1
+         
+         # 创建Excel写入器
+         writer = pd.ExcelWriter(excel_file, engine='openpyxl')
+         
+         # 处理所有电价表页面（除最后一页）
+         print("处理电价表页面...")
+         for page_index in range(len(all_pages_data) - 1):
+             data, notes, calc_df = process_first_page(all_pages_data[page_index])
+             
+             # 为每个电价表页面创建不同的sheet名
+             sheet_name = f'电价表{page_index + 1}' if page_index > 0 else '电价表'
+             
+             # 如果有表格数据，写入主表数据
+             if data is not None:
+                 if is_yunnan:
+                     # 云南省特殊处理：调整表格格式
+                     data = adjust_yunnan_table_format(data)
+                 data.to_excel(writer, sheet_name=sheet_name, index=False, startrow=3)
+             
+             # 获取工作表对象
+             worksheet = writer.sheets[sheet_name]
+             
+             # 设置标题
+             title = all_pages_data[page_index].get('title', '')
+             subtitle = all_pages_data[page_index].get('subtitle', '')
+             unit = all_pages_data[page_index].get('unit', '')
+             
+             # 写入标题并合并单元格
+             worksheet['A1'] = title
+             worksheet.merge_cells(f'A1:{openpyxl.utils.get_column_letter(worksheet.max_column)}1')
+             worksheet['A2'] = subtitle
+             worksheet.merge_cells(f'A2:{openpyxl.utils.get_column_letter(worksheet.max_column)}2')
+             worksheet['A3'] = unit
+             worksheet.merge_cells(f'A3:{openpyxl.utils.get_column_letter(worksheet.max_column)}3')
+             
+             # 设置云南省特有的样式
+             if is_yunnan:
+                 apply_yunnan_styles(worksheet)
+             
+             # 处理图片
+             if 'images' in all_pages_data[page_index]:
+                 print(f"正在处理第 {page_index + 1} 页的图片...")
+                 images = all_pages_data[page_index]['images']
+                 
+                 # 计算图片插入的起始行
+                 start_row = worksheet.max_row + 2  # 在表格数据后留两行空白
+                 
+                 for i, img_info in enumerate(images):
+                     try:
+                         # 添加图片标题
+                         title_row = start_row + i * 20  # 每张图片预留20行空间
+                         worksheet.cell(row=title_row, column=1, value=f"图片 {i+1}")
+                         
+                         # 插入图片
+                         img = openpyxl.drawing.image.Image(img_info['path'])
+                         
+                         # 设置图片大小（根据原始尺寸等比例缩放）
+                         max_width = 800  # 最大宽度（像素）
+                         max_height = 600  # 最大高度（像素）
+                         width = img_info['width']
+                         height = img_info['height']
+                         
+                         # 计算缩放比例
+                         width_ratio = max_width / width if width > max_width else 1
+                         height_ratio = max_height / height if height > max_height else 1
+                         scale_ratio = min(width_ratio, height_ratio)
+                         
+                         # 应用缩放
+                         img.width = width * scale_ratio
+                         img.height = height * scale_ratio
+                         
+                         # 设置图片位置
+                         img.anchor = f'A{title_row + 1}'
+                         
+                         # 添加图片到工作表
+                         worksheet.add_image(img)
+                         print(f"已插入图片 {i+1}")
+                         
+                     except Exception as e:
+                         print(f"插入图片 {i+1} 失败: {str(e)}")
+                         continue
+             
+             # 合并空白单元格，标题行（第4行）不合并
+             if data is not None:
+                 header_row = 4
+                 if is_yunnan:
+                     merge_yunnan_empty_cells(worksheet, header_row + 1, worksheet.max_row, 1, worksheet.max_column, header_row=header_row)
+                 else:
+                     merge_empty_cells(worksheet, header_row + 1, worksheet.max_row, 1, worksheet.max_column, header_row=header_row)
+             
+             # 写入注释
+             if notes:
+                 if is_yunnan:
+                     add_yunnan_notes_with_title(worksheet, notes, worksheet.max_row, worksheet.max_column)
+                 else:
+                     add_notes_with_title(worksheet, notes, worksheet.max_row, worksheet.max_column)
+             
+             # 应用单元格格式
+             if is_yunnan:
+                 apply_yunnan_cell_format(worksheet)
+             else:
+                 apply_cell_format(worksheet)
+         
+         # 处理最后一页（计算说明）
+         print("处理计算说明页面...")
+         if len(all_pages_data) > 0:
+             last_page = all_pages_data[-1]
+             # 创建计算说明工作表
+             calc_sheet = writer.book.create_sheet('计算说明')
+             
+             # 设置标题
+             title = last_page.get('title', '')
+             subtitle = last_page.get('subtitle', '')
+             unit = last_page.get('unit', '')
+             
+             # 写入标题
+             calc_sheet['A1'] = title
+             calc_sheet['A2'] = subtitle
+             calc_sheet['A3'] = unit
+             
+             # 获取表格数据
+             if 'table' in last_page:
+                 table_data = last_page['table']
+                 # 写入表格数据
+                 for i, row in enumerate(table_data, start=4):
+                     for j, value in enumerate(row, start=1):
+                         calc_sheet.cell(row=i, column=j, value=value)
+                 
+                 # 合并标题行
+                 max_col = max(len(row) for row in table_data)
+                 for row in range(1, 4):
+                     calc_sheet.merge_cells(f'A{row}:{openpyxl.utils.get_column_letter(max_col)}{row}')
+                 
+                 # 合并空白单元格，标题行（第4行）不合并
+                 header_row = 4
+                 if is_yunnan:
+                     merge_yunnan_empty_cells(calc_sheet, header_row + 1, calc_sheet.max_row, 1, max_col, header_row=header_row)
+                 else:
+                     merge_empty_cells(calc_sheet, header_row + 1, calc_sheet.max_row, 1, max_col, header_row=header_row)
+             
+             # 处理图片
+             if 'images' in last_page:
+                 print("正在处理计算说明页面的图片...")
+                 images = last_page['images']
+                 
+                 # 计算图片插入的起始行
+                 start_row = calc_sheet.max_row + 2  # 在表格数据后留两行空白
+                 
+                 for i, img_info in enumerate(images):
+                     try:
+                         # 添加图片标题
+                         title_row = start_row + i * 20  # 每张图片预留20行空间
+                         calc_sheet.cell(row=title_row, column=1, value=f"图片 {i+1}")
+                         
+                         # 插入图片
+                         img = openpyxl.drawing.image.Image(img_info['path'])
+                         
+                         # 设置图片大小（根据原始尺寸等比例缩放）
+                         max_width = 800  # 最大宽度（像素）
+                         max_height = 600  # 最大高度（像素）
+                         width = img_info['width']
+                         height = img_info['height']
+                         
+                         # 计算缩放比例
+                         width_ratio = max_width / width if width > max_width else 1
+                         height_ratio = max_height / height if height > max_height else 1
+                         scale_ratio = min(width_ratio, height_ratio)
+                         
+                         # 应用缩放
+                         img.width = width * scale_ratio
+                         img.height = height * scale_ratio
+                         
+                         # 设置图片位置
+                         img.anchor = f'A{title_row + 1}'
+                         
+                         # 添加图片到工作表
+                         calc_sheet.add_image(img)
+                         print(f"已插入图片 {i+1}")
+                         
+                     except Exception as e:
+                         print(f"插入图片 {i+1} 失败: {str(e)}")
+                         continue
+             
+             # 写入注释
+             if 'notes' in last_page:
+                 notes = last_page['notes']
+                 if notes:
+                     if is_yunnan:
+                         add_yunnan_notes_with_title(calc_sheet, notes, calc_sheet.max_row, calc_sheet.max_column)
+                     else:
+                         add_notes_with_title(calc_sheet, notes, calc_sheet.max_row, calc_sheet.max_column)
+             
+             # 应用单元格格式
+             if is_yunnan:
+                 apply_yunnan_cell_format(calc_sheet)
+             else:
+                 apply_cell_format(calc_sheet)
+         
+         # 保存Excel文件
+         writer.close()
+         
+         print(f"Excel文件已保存到: {excel_file}")
+         return excel_file
+         
+     except Exception as e:
+         print(f"保存Excel文件时出错: {str(e)}")
+         import traceback
+         traceback.print_exc()
+         return None 
```

---







现在让我们修改原始文件中的write_to_excel函数：

---



---











让我们尝试一个不同的方法。我们将创建一个新的文件，然后将所有内容复制过去：

---

Cancelled

---



---

_**User**_

报错

---

_**Assistant**_

我看到了问题所在。在原始文件中有几处缩进错误，让我来修复它们：

---



---



让我尝试另一种方式：

---



---







让我们尝试一个不同的方法。我们将创建一个新的文件，然后将其内容复制到原始文件中：

---

Cancelled

---



---



---

