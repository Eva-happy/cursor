<!-- Generated by SpecStory -->

# 增加参数的敏感性分析代码修改 (2025-02-16 16:36:42)

_**User**_

@完整敏感性分析.bas @SensitivityAnalysis.bas @倒推IRR宏 请问我以后在进行敏感性分析的时候，要增加参数，应该怎么修改代码，才可以确保计算4个目标值(全投IRR,资本金IRR,全投回收期，资本金回收期)以及敏感性系数?请帮我列出方法和步骤即可

---

_**Assistant**_

我来帮你整理增加新参数需要修改的步骤：

1. 在 `SensitivityAnalysis.bas` 中需要修改以下位置：

```vb
1. CalculateSingleParameterAnalysis 函数中的 Select Case 语句：
   - 添加新的 Case 分支
   - 设置新参数的基准值获取位置
   - 设置新参数的公式引用

2. CalculateParameterValue 函数中的 Select Case 语句：
   - 添加新的 Case 分支
   - 设置参数的取值和恢复逻辑
```

2. 在 `完整敏感性分析.bas` 中需要修改以下位置：

```vb
1. CreateSensitivityTable 函数中：
   - 在参数名称列表中添加新参数
   - 添加新参数的基准值公式引用

2. CalculateNewValue 函数中的 Select Case 语句：
   - 添加新的 Case 分支
   - 设置新参数的取值和恢复逻辑

3. paramTypes 数组（在 CalculateOverallSensitivity 函数中）：
   - 添加新参数的完整名称
```

3. 在 `倒推IRR宏` 中需要修改：

```vb
1. ReverseCalculateParameter 函数中的 Select Case 语句：
   - 添加新的 Case 分支
   - 设置新参数的基准值获取位置

2. ShowReverseCalculationForm 函数中：
   - 在参数选择提示中添加新参数
   - 在参数类型转换的 Select Case 中添加新的 Case
```

具体操作步骤：

1. 确定新参数的以下信息：
   - 参数完整名称（包括单位）
   - 参数在基础参数表中的位置（单元格引用）
   - 参数与IRR的相关性（正相关还是负相关）

2. 按照上述列表，在各个文件的相应位置添加新参数的处理逻辑

3. 测试验证：
   - 生成单一参数敏感性分析表，检查新参数是否可以正确计算
   - 生成总体敏感性分析表，检查新参数是否包含在内
   - 测试倒推计算，确认新参数可以正确倒推

注意事项：
1. 保持参数名称的一致性，在所有地方使用相同的参数名称
2. 确保正确设置数值格式（百分比、小数点位数等）
3. 注意参数与IRR的相关性，这会影响倒推计算的逻辑
4. 添加新参数时要同时考虑其在四个目标值（全投IRR、资本金IRR、全投回收期、资本金回收期）中的影响

这样修改后，新增的参数就可以参与所有的敏感性分析计算，包括单一参数分析、总体敏感性分析和倒推计算。

---

_**User**_

我还是不太懂步骤，请问可以再详细点吗

---

_**Assistant**_

好的，我来更详细地说明如何添加一个新参数的具体步骤。假设我们要添加一个新参数"运维管理费（元/W）"，它在基础参数表中的位置是F24单元格。

详细步骤如下：

1. 首先修改 `SensitivityAnalysis.bas`：

```vb
1. 在 CalculateSingleParameterAnalysis 函数的 Select Case 中添加：
   Case "运维管理费（元/W）"
       baseValue = baseSheet.Range("F24").Value
       ws.Range("E4").Formula = "=基础参数及输出结果表!$F$24"

2. 在 CalculateParameterValue 函数的 Select Case 中添加：
   Case "运维管理费（元/W）"
       baseValue = baseSheet.Range("F24").Value
       baseSheet.Range("F24").Value = newValue
   
   // 在恢复原始值的 Select Case 中也要添加：
   Case "运维管理费（元/W）"
       baseSheet.Range("F24").Value = baseValue
```

2. 然后修改 `完整敏感性分析.bas`：

```vb
1. 在 CreateSensitivityTable 函数中找到设置参数名称的部分，添加：
   .Cells(9, startCol).Value = "运维管理费（元/W）"
   
2. 在同一函数中找到设置基准值的部分，添加：
   .Cells(9, startCol + 1).Formula = "=基础参数及输出结果表!$F$24"

3. 在 CalculateNewValue 函数的 Select Case 中添加：
   Case "运维管理费", "运维管理费（元/W）"
       With baseSheet.Range("F24")
           oldValue = .Value
           oldFormula = .Formula
           .Value = newValue
       End With
   
   // 在恢复原始值的 Select Case 中也要添加：
   Case "运维管理费", "运维管理费（元/W）"
       With baseSheet.Range("F24")
           If oldFormula <> "" Then
               .Formula = oldFormula
           Else
               .Value = oldValue
           End If
       End With

4. 在 CalculateOverallSensitivity 函数中找到 paramTypes 数组，添加新参数：
   paramTypes = Array( _
       "发电小时数（单位：小时）", _
       "电价（单位：元/kWh）", _
       "消纳率（比率）", _
       "初始总投资（万元）", _
       "消交流侧装机容量（备案容量）", _
       "运维管理费（元/W）", _  ' 添加新参数
       ...
   )
```

3. 最后修改 `倒推IRR宏`：

```vb
1. 在 ReverseCalculateParameter 函数的 Select Case 中添加：
   Case "运维管理费", "运维管理费（元/W）"
       baseValue = baseSheet.Range("F24").Value

2. 在 ShowReverseCalculationForm 函数中修改参数选择提示：
   paramType = InputBox("请输入要倒推的参数类型：" & vbNewLine & _
                       "1. 发电小时数" & vbNewLine & _
                       "2. 电价" & vbNewLine & _
                       "3. 消纳率" & vbNewLine & _
                       "4. 单位总成本" & vbNewLine & _
                       "5. 消交流侧装机容量" & vbNewLine & _
                       "6. 技改费" & vbNewLine & _
                       "7. 股权资本金占比" & vbNewLine & _
                       "8. 还款年限" & vbNewLine & _
                       "9. 利率" & vbNewLine & _
                       "10. 运维管理费" & vbNewLine & _  ' 添加新选项
                       "请输入数字(1-10)：")

3. 在同函数的 Select Case 中添加：
   Case "10": paramType = "运维管理费"
```

测试步骤：

1. 保存所有修改的代码
2. 在Excel中测试：
   - 点击"生成单一参数敏感性分析表"按钮，选择新参数，检查是否可以正确计算
   - 点击"生成总体敏感性分析表"按钮，检查新参数是否出现在表格中并能正确计算
   - 测试倒推计算功能，选择新参数进行倒推计算

注意事项：
1. 确保参数名称在所有地方都保持一致
2. 注意参数的单位和格式设置
3. 如果参数与IRR是负相关的（如成本类参数），需要在倒推计算中特别处理
4. 添加新参数后要全面测试所有功能
5. 建议先在测试环境中进行修改和测试，确认无误后再应用到生产环境

这样就完成了新参数的添加。每个新参数都需要按照这些步骤进行添加，确保它能在所有敏感性分析功能中正常工作。

---

_**User**_

请问这个筛选功能是在excel怎么设置的，在贷款方式中

---

_**Assistant**_

在Excel中设置单元格的下拉筛选功能，可以通过数据验证(Data Validation)来实现。具体步骤如下：

1. 选中要设置下拉列表的单元格（在这个例子中是"贷款方式"右侧的单元格）

2. 点击Excel菜单栏中的"数据"(Data)选项卡

3. 在"数据工具"组中，点击"数据验证"(Data Validation)

4. 在弹出的"数据验证"对话框中：
   - "设置"选项卡下，"允许"选择"序列"
   - "来源"框中输入你想要的选项，用逗号分隔，例如：
     ```
     新机制基金,传统贷款
     ```
   或者
   - 如果选项较多，可以在另一个工作表中列出所有选项，然后在"来源"中引用那个范围

5. 点击"确定"完成设置

这样设置后：
- 该单元格会出现一个下拉箭头
- 用户只能从下拉列表中选择预设的选项
- 可以防止输入错误的数据

如果你想让下拉列表更美观，还可以：
1. 设置单元格的背景色（如图中的浅橙色）
2. 设置单元格的边框样式
3. 调整字体和对齐方式

这样可以让界面更专业和易用。

---



---

