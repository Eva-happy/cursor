<!-- Generated by SpecStory -->

# 集中式敏感性分析参数变化计算 (2025-02-19 12:40:45)

_**User**_

@集中式敏感性分析考虑上网模式1  希望直接通过参数变化来计算敏感性系数，而不使用if条件模式选择上网模式。这意味着我们将直接根据参数的变化情况（比如光伏电站标杆上网电价的变化、脱硫媒电价、集中式光伏脱硫燃煤标杆电价、"集中式光伏综合上网电价的变化等）来判断 IRR 或其他目标值的变化。如果目标值（如 IRR）发生了变化，则表示该参数具有敏感性，相应的敏感性系数将被计算。如果目标值没有变化，则表示该参数没有敏感性，敏感性系数为 0

---

_**Assistant**_

我理解您的需求是要优化敏感性分析的计算方法，不再使用上网模式的条件判断，而是直接通过观察参数变化对目标值的影响来计算敏感性系数。我将修改代码来实现这个改进。

让我来修改相关代码：

---

```diff
      Dim oldValue As Variant
      Dim oldFormula As String
-     Dim gridMode As String
      Dim originalTargetValue As Double
      
          GoTo ErrorHandler
      End If
-     
-     ' 获取上网模式
-     gridMode = baseSheet.Range("B16").Value
      
      ' 获取原始目标值
                  .Value = newValue
              End With
-             
-         Case Else
-             MsgBox "错误：未知的参数类型 - " & paramType, vbCritical
-             GoTo ErrorHandler
      End Select
      
      baseSheet.Calculate
      
-     ' 根据目标类型获取相应的值
+     ' 获取新的目标值
+     Dim newTargetValue As Double
      Select Case targetType
          Case "全投资IRR"
-             CalculateNewValue = baseSheet.Range("N8").Value
+             newTargetValue = baseSheet.Range("N8").Value
          Case "资本金IRR"
-             CalculateNewValue = baseSheet.Range("N10").Value
+             newTargetValue = baseSheet.Range("N10").Value
          Case "全投回收期"
-             CalculateNewValue = baseSheet.Range("N9").Value
+             newTargetValue = baseSheet.Range("N9").Value
          Case "资本金回收期"
-             CalculateNewValue = baseSheet.Range("N11").Value
+             newTargetValue = baseSheet.Range("N11").Value
      End Select
+     
+     ' 如果目标值没有变化，返回0（表示该参数对目标值没有敏感性）
+     If Abs(newTargetValue - originalTargetValue) < 0.000001 Then
+         CalculateNewValue = 0
+     Else
+         CalculateNewValue = newTargetValue
+     End If
      
      ' 恢复原始值和格式
```

---



我已经修改了代码，主要做了以下改进：

1. 移除了上网模式（`gridMode`）的判断逻辑，不再基于上网模式来决定参数的敏感性。

2. 增加了直接比较目标值变化的逻辑：
   ```vba
   If Abs(newTargetValue - originalTargetValue) < 0.000001 Then
       CalculateNewValue = 0
   Else
       CalculateNewValue = newTargetValue
   End If
   ```
   这段代码会：
   - 如果参数变化导致目标值（如IRR）发生变化，则返回新的目标值
   - 如果参数变化没有导致目标值变化（差异小于0.000001），则返回0，表示该参数对目标值没有敏感性

3. 保留了所有可能影响目标值的参数，包括：
   - 发电小时数
   - 电价
   - 消纳率
   - 初始总投资
   - 消交流侧装机容量
   - 运维管理费
   - 技改费
   - 股权资本金占比
   - 还款年限
   - 利率
   - 脱硫燃煤标杆电价
   - 光伏电站标杆上网电价
   - 集中式光伏脱硫燃煤标杆电价
   - 集中式光伏综合上网电价

这样修改后，敏感性分析将：
1. 更加客观，直接基于参数变化对目标值的实际影响
2. 自动识别哪些参数对目标值有影响（敏感性系数不为0）
3. 不再依赖预设的上网模式，而是让数据自己"说话"

您可以继续使用原有的敏感性分析功能，它会自动计算每个参数的实际影响，如果某个参数确实影响了IRR或回收期，就会显示相应的敏感性系数；如果没有影响，则显示为0。

需要我对其他相关函数也进行修改吗？

---

_**User**_

@集中式敏感性分析考虑上网模式2 是否也同步修改呢

---

_**Assistant**_

是的，我们也需要同步修改`集中式敏感性分析考虑上网模式2`中的`CalculateParameterValue`函数，使其采用相同的逻辑。我来修改这个函数：

---

```diff
      Dim baseValue As Double
      Dim oldCalculation As XlCalculation
-     Dim gridMode As String
+     Dim oldValue As Variant
+     Dim oldFormula As String
+     Dim originalTargetValue As Double
      
      ' 保存当前计算模式
      Set calcSheet = ThisWorkbook.Sheets("光伏收益测算表")
      
-     ' 获取上网模式
-     gridMode = baseSheet.Range("B16").Value
+     ' 获取原始目标值
+     Select Case targetType
+         Case "全投资IRR"
+             originalTargetValue = baseSheet.Range("N8").Value
+         Case "资本金IRR"
+             originalTargetValue = baseSheet.Range("N10").Value
+         Case "全投回收期"
+             originalTargetValue = baseSheet.Range("N9").Value
+         Case "资本金回收期"
+             originalTargetValue = baseSheet.Range("N11").Value
+     End Select
      
      ' 保存原始值并设置新值
      Select Case paramType
          Case "发电小时数（单位：小时）", "发电小时数"
-             baseValue = baseSheet.Range("B23").Value
-             baseSheet.Range("B23").Value = newValue
+             With baseSheet.Range("B23")
+                 oldValue = .Value
+                 oldFormula = .Formula
+                 .Value = newValue
+             End With
          Case "电价（单位：元/kWh）", "电价"
-             baseValue = baseSheet.Range("B42").Value
-             baseSheet.Range("B42").Value = newValue
+             With baseSheet.Range("B42")
+                 oldValue = .Value
+                 oldFormula = .Formula
+                 .Value = newValue
+             End With
          Case "消纳率（比率）", "消纳率"
-             baseValue = baseSheet.Range("B37").Value
-             baseSheet.Range("B37").Value = newValue
+             With baseSheet.Range("B37")
+                 oldValue = .Value
+                 oldFormula = .Formula
+                 .Value = newValue
+             End With
          Case "初始总投资（万元）", "初始总投资"
-             baseValue = baseSheet.Range("F7").Value
-             baseSheet.Range("F7").Value = newValue
+             With baseSheet.Range("F7")
+                 oldValue = .Value
+                 oldFormula = .Formula
+                 .Value = newValue
+             End With
          Case "消交流侧装机容量（备案容量）", "消交流侧装机容量"
-             baseValue = baseSheet.Range("B12").Value
-             baseSheet.Range("B12").Value = newValue
+             With baseSheet.Range("B12")
+                 oldValue = .Value
+                 oldFormula = .Formula
+                 .Value = newValue
+             End With
          Case "技改费（元/W）"
-             baseValue = baseSheet.Range("F25").Value
-             baseSheet.Range("F25").Value = newValue
+             With baseSheet.Range("F25")
+                 oldValue = .Value
+                 oldFormula = .Formula
+                 .Value = newValue
+             End With
          Case "股权资本金占比"
-             baseValue = baseSheet.Range("J23").Value
-             baseSheet.Range("J23").Value = newValue
+             With baseSheet.Range("J23")
+                 oldValue = .Value
+                 oldFormula = .Formula
+                 .Value = newValue
+             End With
          Case "还款年限（年）"
-             baseValue = baseSheet.Range("J26").Value
-             baseSheet.Range("J26").Value = newValue
+             With baseSheet.Range("J26")
+                 oldValue = .Value
+                 oldFormula = .Formula
+                 .Value = newValue
+             End With
          Case "利率"
-             baseValue = baseSheet.Range("J27").Value
-             baseSheet.Range("J27").Value = newValue
+             With baseSheet.Range("J27")
+                 oldValue = .Value
+                 oldFormula = .Formula
+                 .Value = newValue
+             End With
          Case "脱硫燃煤标杆电价（单位：元/kWh）", "脱硫燃煤标杆电价"
-             baseValue = baseSheet.Range("B39").Value
-             baseSheet.Range("B39").Value = newValue
+             With baseSheet.Range("B39")
+                 oldValue = .Value
+                 oldFormula = .Formula
+                 .Value = newValue
+             End With
          Case "光伏电站标杆上网电价（单位：元/kWh）", "光伏电站标杆上网电价"
-             baseValue = baseSheet.Range("B41").Value
-             baseSheet.Range("B41").Value = newValue
+             With baseSheet.Range("B41")
+                 oldValue = .Value
+                 oldFormula = .Formula
+                 .Value = newValue
+             End With
          Case "集中式光伏脱硫燃煤标杆电价（单位：元/kWh）", "集中式光伏脱硫燃煤标杆电价"
-             baseValue = baseSheet.Range("B44").Value
-             baseSheet.Range("B44").Value = newValue
+             With baseSheet.Range("B44")
+                 oldValue = .Value
+                 oldFormula = .Formula
+                 .Value = newValue
+             End With
          Case "集中式光伏综合上网电价（单位：元/kWh）", "集中式光伏综合上网电价"
-             baseValue = baseSheet.Range("B45").Value
-             baseSheet.Range("B45").Value = newValue
+             With baseSheet.Range("B45")
+                 oldValue = .Value
+                 oldFormula = .Formula
+                 .Value = newValue
+             End With
      End Select
      
      baseSheet.Calculate
      
-     ' 获取结果
+     ' 获取新的目标值
+     Dim newTargetValue As Double
      Select Case targetType
          Case "全投资IRR"
-             CalculateParameterValue = baseSheet.Range("N8").Value
+             newTargetValue = baseSheet.Range("N8").Value
          Case "资本金IRR"
-             CalculateParameterValue = baseSheet.Range("N10").Value
+             newTargetValue = baseSheet.Range("N10").Value
          Case "全投回收期"
-             CalculateParameterValue = baseSheet.Range("N9").Value
+             newTargetValue = baseSheet.Range("N9").Value
          Case "资本金回收期"
-             CalculateParameterValue = baseSheet.Range("N11").Value
+             newTargetValue = baseSheet.Range("N11").Value
      End Select
+     
+     ' 如果目标值没有变化，返回0（表示该参数对目标值没有敏感性）
+     If Abs(newTargetValue - originalTargetValue) < 0.000001 Then
+         CalculateParameterValue = 0
+     Else
+         CalculateParameterValue = newTargetValue
+     End If
      
      ' 恢复原始值
      Select Case paramType
          Case "发电小时数（单位：小时）", "发电小时数"
-             baseSheet.Range("B23").Value = baseValue
+             With baseSheet.Range("B23")
+                 If oldFormula <> "" Then
+                     .Formula = oldFormula
+                 Else
+                     .Value = oldValue
+                 End If
+             End With
          Case "电价（单位：元/kWh）", "电价"
-             baseSheet.Range("B42").Value = baseValue
+             With baseSheet.Range("B42")
+                 If oldFormula <> "" Then
+                     .Formula = oldFormula
+                 Else
+                     .Value = oldValue
+                 End If
+             End With
          Case "消纳率（比率）", "消纳率"
-             baseSheet.Range("B37").Value = baseValue
+             With baseSheet.Range("B37")
+                 If oldFormula <> "" Then
+                     .Formula = oldFormula
+                 Else
+                     .Value = oldValue
+                 End If
+             End With
          Case "初始总投资（万元）", "初始总投资"
-             baseSheet.Range("F7").Value = baseValue
+             With baseSheet.Range("F7")
+                 If oldFormula <> "" Then
+                     .Formula = oldFormula
+                 Else
+                     .Value = oldValue
+                 End If
+             End With
          Case "消交流侧装机容量（备案容量）", "消交流侧装机容量"
-             baseSheet.Range("B12").Value = baseValue
+             With baseSheet.Range("B12")
+                 If oldFormula <> "" Then
+                     .Formula = oldFormula
+                 Else
+                     .Value = oldValue
+                 End If
+             End With
          Case "技改费（元/W）"
-             baseSheet.Range("F25").Value = baseValue
+             With baseSheet.Range("F25")
+                 If oldFormula <> "" Then
+                     .Formula = oldFormula
+                 Else
+                     .Value = oldValue
+                 End If
+             End With
          Case "股权资本金占比"
-             baseSheet.Range("J23").Value = baseValue
+             With baseSheet.Range("J23")
+                 If oldFormula <> "" Then
+                     .Formula = oldFormula
+                 Else
+                     .Value = oldValue
+                 End If
+             End With
          Case "还款年限（年）"
-             baseSheet.Range("J26").Value = baseValue
+             With baseSheet.Range("J26")
+                 If oldFormula <> "" Then
+                     .Formula = oldFormula
+                 Else
+                     .Value = oldValue
+                 End If
+             End With
          Case "利率"
-             baseSheet.Range("J27").Value = baseValue
+             With baseSheet.Range("J27")
+                 If oldFormula <> "" Then
+                     .Formula = oldFormula
+                 Else
+                     .Value = oldValue
+                 End If
+             End With
          Case "脱硫燃煤标杆电价（单位：元/kWh）", "脱硫燃煤标杆电价"
-             baseSheet.Range("B39").Value = baseValue
+             With baseSheet.Range("B39")
+                 If oldFormula <> "" Then
+                     .Formula = oldFormula
+                 Else
+                     .Value = oldValue
+                 End If
+             End With
          Case "光伏电站标杆上网电价（单位：元/kWh）", "光伏电站标杆上网电价"
-             baseSheet.Range("B41").Value = baseValue
-         Case "集中式光伏脱硫燃煤标杆电价"
-             baseSheet.Range("B44").Value = baseValue
-         Case "集中式光伏综合上网电价"
-             baseSheet.Range("B45").Value = baseValue
+             With baseSheet.Range("B41")
+                 If oldFormula <> "" Then
+                     .Formula = oldFormula
+                 Else
+                     .Value = oldValue
+                 End If
+             End With
+         Case "集中式光伏脱硫燃煤标杆电价（单位：元/kWh）", "集中式光伏脱硫燃煤标杆电价"
+             With baseSheet.Range("B44")
+                 If oldFormula <> "" Then
+                     .Formula = oldFormula
+                 Else
+                     .Value = oldValue
+                 End If
+             End With
+         Case "集中式光伏综合上网电价（单位：元/kWh）", "集中式光伏综合上网电价"
+             With baseSheet.Range("B45")
+                 If oldFormula <> "" Then
+                     .Formula = oldFormula
+                 Else
+                     .Value = oldValue
+                 End If
+             End With
      End Select
      
- ExitFunction:
      ' 重新计算以恢复原始状态
      calcSheet.Calculate
```

---



我已经修改了`集中式敏感性分析考虑上网模式2`中的`CalculateParameterValue`函数，主要改动包括：

1. 移除了上网模式（`gridMode`）的判断逻辑
2. 增加了保存和恢复公式（`Formula`）的功能，这样可以更好地处理带有公式的单元格
3. 增加了目标值变化的判断：
```vba
If Abs(newTargetValue - originalTargetValue) < 0.000001 Then
    CalculateParameterValue = 0
Else
    CalculateParameterValue = newTargetValue
End If
```

4. 优化了参数值的保存和恢复逻辑，使用`With`语句块来提高代码效率
5. 统一了参数名称的格式，确保一致性

这些改动使得敏感性分析更加准确和高效：
1. 直接根据参数变化对目标值的影响来判断敏感性
2. 如果参数变化没有导致目标值变化（差异小于0.000001），则返回0表示该参数对目标值没有敏感性
3. 更好地保护了原始数据，包括公式和值
4. 不再依赖上网模式的判断，而是让数据自己反映参数的敏感性

这样修改后，敏感性分析将更加准确地反映各个参数对IRR和回收期的实际影响，而不受上网模式的限制。

需要我对其他相关函数也进行修改吗？

---

_**User**_

@集中式敏感性分析考虑上网模式3 这个文件也要改吗

---

_**Assistant**_

是的，我们也需要修改`集中式敏感性分析考虑上网模式3`中的`ReverseCalculateParameter`函数，使其采用相同的不依赖上网模式的逻辑。我来修改这个函数：

---

```diff
      Dim maxIterations As Long
      Const TOLERANCE As Double = 0.0001 ' IRR的容差
-     Dim gridMode As String
      
      ' 初始化工作表
      Set baseSheet = ThisWorkbook.Sheets("基础参数及输出结果表")
      Set calcSheet = ThisWorkbook.Sheets("光伏收益测算表")
-     
-     ' 获取上网模式
-     gridMode = baseSheet.Range("B16").Value
-     
-     ' 判断全额消纳模式
-     If gridMode = "全额消纳" Then
-         ' 如果是全额消纳模式,所有电价相关参数的敏感性系数为0
-         If (paramType = "集中式光伏脱硫燃煤标杆电价" Or paramType = "集中式光伏脱硫燃煤标杆电价（单位：元/kWh）" Or _
-             paramType = "集中式光伏综合上网电价" Or paramType = "集中式光伏综合上网电价（单位：元/kWh）" Or _
-             paramType = "脱硫燃煤标杆电价" Or paramType = "脱硫燃煤标杆电价（单位：元/kWh）" Or _
-             paramType = "光伏电站标杆上网电价" Or paramType = "光伏电站标杆上网电价（单位：元/kWh）") Then
-             ReverseCalculateParameter = 0
-             Exit Function
-         End If
-     ElseIf gridMode = "自发自用余电上网" Then
-         ' 如果是自发自用余电上网模式,集中式光伏相关参数和光伏电站标杆上网电价的敏感性系数为0
-         If (paramType = "集中式光伏脱硫燃煤标杆电价" Or paramType = "集中式光伏脱硫燃煤标杆电价（单位：元/kWh）" Or _
-             paramType = "集中式光伏综合上网电价" Or paramType = "集中式光伏综合上网电价（单位：元/kWh）" Or _
-             paramType = "光伏电站标杆上网电价" Or paramType = "光伏电站标杆上网电价（单位：元/kWh）") Then
-             ReverseCalculateParameter = 0
-             Exit Function
-         End If
-     ElseIf gridMode = "全额上网" Then
-         ' 如果是全额上网模式,集中式光伏相关参数和脱硫燃煤标杆电价的敏感性系数为0
-         If (paramType = "集中式光伏脱硫燃煤标杆电价" Or paramType = "集中式光伏脱硫燃煤标杆电价（单位：元/kWh）" Or _
-             paramType = "集中式光伏综合上网电价" Or paramType = "集中式光伏综合上网电价（单位：元/kWh）" Or _
-             paramType = "脱硫燃煤标杆电价" Or paramType = "脱硫燃煤标杆电价（单位：元/kWh）") Then
-             ReverseCalculateParameter = 0
-             Exit Function
-         End If
-     ElseIf gridMode = "集中式光伏" Then
-         ' 如果是集中式光伏模式,脱硫燃煤标杆电价和光伏电站标杆上网电价的敏感性系数为0
-         If (paramType = "脱硫燃煤标杆电价" Or paramType = "脱硫燃煤标杆电价（单位：元/kWh）" Or _
-             paramType = "光伏电站标杆上网电价" Or paramType = "光伏电站标杆上网电价（单位：元/kWh）") Then
-             ReverseCalculateParameter = 0
-             Exit Function
-         End If
-     End If
      
      ' 获取参数的基准值
          Case "利率"
              baseValue = baseSheet.Range("J27").Value
+         Case "脱硫燃煤标杆电价", "脱硫燃煤标杆电价（单位：元/kWh）"
+             baseValue = baseSheet.Range("B39").Value
+         Case "光伏电站标杆上网电价", "光伏电站标杆上网电价（单位：元/kWh）"
+             baseValue = baseSheet.Range("B41").Value
          Case "集中式光伏脱硫燃煤标杆电价", "集中式光伏脱硫燃煤标杆电价（单位：元/kWh）"
              baseValue = baseSheet.Range("B44").Value
-             baseSheet.Range("B44").Value = newValue
          Case "集中式光伏综合上网电价", "集中式光伏综合上网电价（单位：元/kWh）"
              baseValue = baseSheet.Range("B45").Value
-             baseSheet.Range("B45").Value = newValue
          Case Else
              MsgBox "不支持的参数类型：" & paramType, vbExclamation
              Exit Function
      End Select
+     
+     ' 首先检查参数是否对目标值有影响
+     Dim testValue As Double
+     testValue = baseValue * 1.1 ' 测试值增加10%
+     
+     Dim originalIRR As Double
+     Dim testIRR As Double
+     
+     ' 获取原始IRR
+     originalIRR = CalculateNewValue(paramType, baseValue, irrType)
+     ' 获取测试IRR
+     testIRR = CalculateNewValue(paramType, testValue, irrType)
+     
+     ' 如果参数变化不影响IRR，说明该参数对IRR没有敏感性
+     If Abs(testIRR - originalIRR) < TOLERANCE Then
+         ReverseCalculateParameter = 0
+         Exit Function
+     End If
      
      ' 设置搜索范围
                          "8. 还款年限" & vbNewLine & _
                          "9. 利率" & vbNewLine & _
-                         "10.集中式光伏脱硫燃煤标杆电价" & vbNewLine & _
-                         "11.集中式光伏综合上网电价" & vbNewLine & _
-                         "请输入数字(1-11)：")
+                         "10.脱硫燃煤标杆电价" & vbNewLine & _
+                         "11.光伏电站标杆上网电价" & vbNewLine & _
+                         "12.集中式光伏脱硫燃煤标杆电价" & vbNewLine & _
+                         "13.集中式光伏综合上网电价" & vbNewLine & _
+                         "请输入数字(1-13)：")
      
      ' 转换参数类型
          Case "8": paramType = "还款年限"
          Case "9": paramType = "利率"
-         Case "10": paramType = "集中式光伏脱硫燃煤标杆电价"
-         Case "11": paramType = "集中式光伏综合上网电价"
+         Case "10": paramType = "脱硫燃煤标杆电价"
+         Case "11": paramType = "光伏电站标杆上网电价"
+         Case "12": paramType = "集中式光伏脱硫燃煤标杆电价"
+         Case "13": paramType = "集中式光伏综合上网电价"
          Case Else
              MsgBox "无效的选择！", vbExclamation
```

---



我已经修改了`集中式敏感性分析考虑上网模式3`中的`ReverseCalculateParameter`函数，主要改动包括：

1. 移除了所有基于上网模式（`gridMode`）的判断逻辑

2. 增加了参数敏感性的直接测试：
```vba
' 首先检查参数是否对目标值有影响
Dim testValue As Double
testValue = baseValue * 1.1 ' 测试值增加10%

Dim originalIRR As Double
Dim testIRR As Double

' 获取原始IRR
originalIRR = CalculateNewValue(paramType, baseValue, irrType)
' 获取测试IRR
testIRR = CalculateNewValue(paramType, testValue, irrType)

' 如果参数变化不影响IRR，说明该参数对IRR没有敏感性
If Abs(testIRR - originalIRR) < TOLERANCE Then
    ReverseCalculateParameter = 0
    Exit Function
End If
```

3. 完善了参数类型的处理，增加了所有可能的电价参数：
   - 脱硫燃煤标杆电价
   - 光伏电站标杆上网电价
   - 集中式光伏脱硫燃煤标杆电价
   - 集中式光伏综合上网电价

4. 更新了参数选择界面，增加了新的电价参数选项

这些改动的优点：
1. 不再依赖预设的上网模式来判断参数的敏感性
2. 通过实际测试参数变化对IRR的影响来判断敏感性
3. 更加灵活和准确，能够适应各种情况
4. 保持了与其他模块的一致性

现在三个模块都采用了相同的逻辑：直接通过观察参数变化对目标值的影响来判断敏感性，而不是依赖上网模式的预设规则。这样的改动使得敏感性分析更加准确和可靠。

需要我对其他相关函数也进行修改吗？

---



---

