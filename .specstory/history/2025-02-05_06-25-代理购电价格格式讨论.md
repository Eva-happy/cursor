<!-- Generated by SpecStory -->

# 代理购电价格格式讨论 (2025-02-05 14:25:02)

_**User**_

第一页的“其中
代理购电价格”，应该是两行，其中在第四行，代理购电价格在第五行；分时电量电价（分/千瓦时）
尖峰时段”，应该是两行，上下两行，而不是放在同一行；电量输配电价，系统运行费用折价，政府性基金及附加，应该在第五行

---

_**Assistant**_

我明白您的需求。您想要调整表格的格式，让表头的布局更加合理。我会修改代码来实现这些要求。让我来编辑文件。

我将修改 `process_first_page` 函数中处理表头的部分，以确保正确的行列布局。

---

```diff
- 
  import os
  import time
          headers = df.iloc[header_row:header_row+2]
          
+         # 调整表头布局
+         # 1. 处理"其中\n代理购电价格"
+         for col in range(len(headers.columns)):
+             if '其中' in str(headers.iloc[0, col]):
+                 headers.iloc[0, col] = '其中'
+                 headers.iloc[1, col] = '代理购电价格'
+         
+         # 2. 处理"分时电量电价（分/千瓦时）\n尖峰时段"
+         for col in range(len(headers.columns)):
+             if '分时电量电价' in str(headers.iloc[0, col]) and '尖峰时段' in str(headers.iloc[0, col]):
+                 headers.iloc[0, col] = '分时电量电价（分/千瓦时）'
+                 headers.iloc[1, col] = '尖峰时段'
+         
+         # 3. 将"电量输配电价"、"系统运行费用折价"、"政府性基金及附加"移到第二行
+         for col in range(len(headers.columns)):
+             cell_value = str(headers.iloc[0, col])
+             if any(term in cell_value for term in ['电量输配电价', '系统运行费用折价', '政府性基金及附加']):
+                 headers.iloc[1, col] = cell_value
+                 headers.iloc[0, col] = ''
+         
          # 合并表头（处理多行表头的情况）
          final_columns = []
              sub_name = headers.iloc[1, col] if len(headers) > 1 else None
              
-             if pd.isna(col_name) and not pd.isna(sub_name):
+             if pd.isna(col_name) or col_name == '':
+                 if not pd.isna(sub_name) and sub_name != '':
                      final_columns.append(sub_name)
-             elif not pd.isna(col_name):
-                 if not pd.isna(sub_name) and col_name != sub_name:
+                 else:
+                     final_columns.append(f"Column_{col+1}")
+             else:
+                 if not pd.isna(sub_name) and sub_name != '' and col_name != sub_name:
                      final_columns.append(f"{col_name}\n{sub_name}")
                  else:
                      final_columns.append(col_name)
-             else:
-                 final_columns.append(f"Column_{col+1}")
          
          # 提取数据部分
```

---



我已经修改了代码，主要做了以下调整：

1. 对于"其中\n代理购电价格"：
   - 将"其中"放在第一行
   - 将"代理购电价格"放在第二行

2. 对于"分时电量电价（分/千瓦时）\n尖峰时段"：
   - 将"分时电量电价（分/千瓦时）"放在第一行
   - 将"尖峰时段"放在第二行

3. 对于"电量输配电价"、"系统运行费用折价"、"政府性基金及附加"：
   - 将这些项目从第一行移到第二行
   - 第一行对应的单元格设置为空

4. 改进了表头合并逻辑：
   - 更好地处理空值和空字符串的情况
   - 确保只有当两行都有内容且内容不同时才进行合并
   - 优化了列名的生成逻辑

这些修改应该能够使表头的布局更加合理，符合您的要求。现在表头将会：
- 正确显示"其中"和"代理购电价格"在两行
- 正确分开显示"分时电量电价（分/千瓦时）"和"尖峰时段"
- 将"电量输配电价"、"系统运行费用折价"、"政府性基金及附加"显示在第二行

您可以运行修改后的程序来查看效果。如果还需要进一步调整，请告诉我。

---

_**User**_

为什么还是没有正确显示"其中"和"代理购电价格"在两行
正确分开显示"分时电量电价（分/千瓦时）"和"尖峰时段"
将"电量输配电价"、"系统运行费用折价"、"政府性基金及附加"显示在第二行

---

_**Assistant**_

问题可能出在表头的处理逻辑上。我注意到我们需要修改两个地方：

1. 在处理表头时，我们需要确保正确设置两行表头的内容，而不是直接合并它们
2. 在写入Excel时，我们需要确保这些表头正确地写入到两行中

让我修改代码：

---



---



让我重新尝试，只修改关键部分：

---



---



让我再试一次，这次只修改最关键的部分：

---



---



我注意到apply model没有成功应用更改。让我们尝试一个不同的方法：

---



---



我发现apply model似乎无法正确应用更改。让我们尝试另一种方式：

---

```diff
          
          # 调整表头布局
-         # 1. 处理"其中\n代理购电价格"
          for col in range(len(headers.columns)):
-             if '其中' in str(headers.iloc[0, col]):
+             cell_value = str(headers.iloc[0, col])
+             next_cell_value = str(headers.iloc[1, col]) if len(headers) > 1 else ''
+             
+             # 处理特殊情况
+             if '其中' in cell_value:
                  headers.iloc[0, col] = '其中'
                  headers.iloc[1, col] = '代理购电价格'
-         
-         # 2. 处理"分时电量电价（分/千瓦时）\n尖峰时段"
-         for col in range(len(headers.columns)):
-             if '分时电量电价' in str(headers.iloc[0, col]) and '尖峰时段' in str(headers.iloc[0, col]):
+             elif '分时电量电价' in cell_value:
+                 if '尖峰时段' in cell_value:
                      headers.iloc[0, col] = '分时电量电价（分/千瓦时）'
                      headers.iloc[1, col] = '尖峰时段'
-         
-         # 3. 将"电量输配电价"、"系统运行费用折价"、"政府性基金及附加"移到第二行
-         for col in range(len(headers.columns)):
-             cell_value = str(headers.iloc[0, col])
-             if any(term in cell_value for term in ['电量输配电价', '系统运行费用折价', '政府性基金及附加']):
+                 elif '高峰时段' in cell_value:
+                     headers.iloc[0, col] = '分时电量电价（分/千瓦时）'
+                     headers.iloc[1, col] = '高峰时段'
+                 elif '平时段' in cell_value:
+                     headers.iloc[0, col] = '分时电量电价（分/千瓦时）'
+                     headers.iloc[1, col] = '平时段'
+                 elif '低谷时段' in cell_value:
+                     headers.iloc[0, col] = '分时电量电价（分/千瓦时）'
+                     headers.iloc[1, col] = '低谷时段'
+             elif any(term in cell_value for term in ['电量输配电价', '系统运行费用折价', '政府性基金及附加']):
                  headers.iloc[1, col] = cell_value
                  headers.iloc[0, col] = ''
          data = df.iloc[header_row+2:]
          data.columns = final_columns[:len(data.columns)]
+         
+         # 将处理后的表头保存到data的属性中
+         data.attrs['headers'] = headers
          
          # 清理数据
```

---



---

_**User**_

其实我第二页的表头行和第一页的表头行应该是一样的，能不能参考第二页的表头行来设置第一页的表头行呢

---

_**Assistant**_

我明白了。我们可以先从第二页获取正确的表头布局，然后用它来设置第一页的表头。让我修改代码：

---



---



我注意到apply model没有成功应用更改。让我们尝试修改调用process_first_page的地方：

---

```diff
          print("处理第一页数据...")
          if len(all_pages_data) > 0:
-             data, notes, calc_df = process_first_page(all_pages_data[0])
+             # 获取第二页数据（如果存在）
+             second_page_data = all_pages_data[1] if len(all_pages_data) > 1 else None
+             data, notes, _ = process_first_page(all_pages_data[0], second_page_data)
              if data is not None:
-                 # 写入主表数据
-                 data.to_excel(writer, sheet_name='电价表', index=False, startrow=3)
+                 # 写入主表数据（从第6行开始，为表头预留空间）
+                 data.to_excel(writer, sheet_name='电价表', index=False, startrow=5)
                  
                  # 获取工作表对象
```

---



现在让我们修改process_first_page函数：

---

```diff
          traceback.print_exc()
          return None
- def process_first_page(page_data):
-     """处理第一页数据（主电价表）"""
+ def process_first_page(page_data, second_page_data=None):
+     """处理第一页数据（主电价表）
+     Args:
+         page_data: 第一页的数据
+         second_page_data: 第二页的数据（可选），用于参考表头布局
+     """
      try:
          if not page_data or 'table' not in page_data:
```

---







现在让我们修改process_first_page函数的主要逻辑：

---



---







让我们尝试一个不同的方法。我们将创建一个新的函数来处理表头：

---



---







我注意到apply model一直无法应用更改。让我们尝试一个不同的方法：

---

```diff
          
          # 提取表头
-         headers = df.iloc[header_row:header_row+2]
+         headers = df.iloc[header_row:header_row+2].copy()
+ 
+         # 获取第二页表头（如果可用）
+         reference_headers = None
+         if second_page_data and 'table' in second_page_data:
+             second_df = pd.DataFrame(second_page_data['table'])
+             for i in range(len(second_df)):
+                 if any('用电分类' in str(cell) for cell in second_df.iloc[i]) or any('用电类别' in str(cell) for cell in second_df.iloc[i]):
+                     reference_headers = second_df.iloc[i:i+2].copy()
+                     break
+ 
+         # 处理表头
+         if reference_headers is not None:
+             print("使用第二页表头布局")
+             # 创建映射关系（基于列的内容）
+             header_mapping = {}
+             for col1 in range(len(headers.columns)):
+                 col1_value = str(headers.iloc[0, col1])
+                 for col2 in range(len(reference_headers.columns)):
+                     col2_value = str(reference_headers.iloc[0, col2])
+                     # 如果找到匹配的列
+                     if (col1_value in col2_value or col2_value in col1_value or 
+                         any(term in col1_value and term in col2_value for term in 
+                             ['电量输配电价', '系统运行费用折价', '政府性基金及附加', '其中', '分时电量电价'])):
+                         header_mapping[col1] = col2
+                         break
+             
+             # 应用第二页的表头布局
+             for col1, col2 in header_mapping.items():
+                 headers.iloc[0, col1] = reference_headers.iloc[0, col2]
+                 headers.iloc[1, col1] = reference_headers.iloc[1, col2]
+         else:
+             print("使用默认表头处理逻辑")
+             # 调整表头布局
+             for col in range(len(headers.columns)):
+                 cell_value = str(headers.iloc[0, col])
+                 next_cell_value = str(headers.iloc[1, col]) if len(headers) > 1 else ''
+                 
+                 # 处理特殊情况
+                 if '其中' in cell_value:
+                     headers.iloc[0, col] = '其中'
+                     headers.iloc[1, col] = '代理购电价格'
+                 elif '分时电量电价' in cell_value:
+                     if '尖峰时段' in cell_value:
+                         headers.iloc[0, col] = '分时电量电价（分/千瓦时）'
+                         headers.iloc[1, col] = '尖峰时段'
+                     elif '高峰时段' in cell_value:
+                         headers.iloc[0, col] = '分时电量电价（分/千瓦时）'
+                         headers.iloc[1, col] = '高峰时段'
+                     elif '平时段' in cell_value:
+                         headers.iloc[0, col] = '分时电量电价（分/千瓦时）'
+                         headers.iloc[1, col] = '平时段'
+                     elif '低谷时段' in cell_value:
+                         headers.iloc[0, col] = '分时电量电价（分/千瓦时）'
+                         headers.iloc[1, col] = '低谷时段'
+                 elif any(term in cell_value for term in ['电量输配电价', '系统运行费用折价', '政府性基金及附加']):
+                     headers.iloc[1, col] = cell_value
+                     headers.iloc[0, col] = ''
          
          # 调整表头布局
```

---







很好！现在代码已经更新，它会：

1. 首先尝试从第二页获取表头布局
2. 如果找到第二页的表头，就使用它作为参考来设置第一页的表头
3. 如果没有找到第二页的表头，就使用默认的处理逻辑

这样应该能够正确地：
- 显示"其中"和"代理购电价格"在两行
- 分开显示"分时电量电价（分/千瓦时）"和"尖峰时段"
- 将"电量输配电价"、"系统运行费用折价"、"政府性基金及附加"显示在第二行

你可以运行程序来测试效果。如果还有任何问题，请告诉我。我看到了问题所在。错误发生在处理数值列的部分，这导致第一页的数据处理失败。让我修复这个问题：

---

```diff
              if col in data.columns:
                  # 清理数值数据（移除换行符和空格）
-                 data[col] = data[col].astype(str).apply(lambda x: x.replace('\n', '').strip() if pd.notnull(x) else x)
+                 data[col] = data[col].apply(lambda x: str(x).replace('\n', '').strip() if isinstance(x, str) else str(x) if pd.notnull(x) else '')
                  # 转换为数值并保持6位小数
                  data[col] = pd.to_numeric(data[col], errors='coerce').round(6)
                  calc_df['数值'] = pd.to_numeric(calc_df['数值'], errors='coerce')
          
+         # 将处理后的表头保存到data的属性中
+         data.attrs['headers'] = headers
+         
          return data, notes, calc_df
      except Exception as e:
              data, notes, _ = process_first_page(all_pages_data[0], second_page_data)
              if data is not None:
-                 # 创建工作表（如果不存在）
-                 if '电价表' not in writer.sheets:
-                     writer.book.create_sheet('电价表')
+                 # 写入主表数据（从第6行开始，为表头预留空间）
+                 data.to_excel(writer, sheet_name='电价表', index=False, startrow=5)
+                 
+                 # 获取工作表对象
                  worksheet = writer.sheets['电价表']
                  
                  
                  # 写入标题并合并单元格
-                 max_col = len(data.columns)
-                 max_col_letter = openpyxl.utils.get_column_letter(max_col)
-                 
                  worksheet['A1'] = title
-                 worksheet.merge_cells(f'A1:{max_col_letter}1')
+                 worksheet.merge_cells(f'A1:N1')
                  worksheet['A2'] = subtitle
-                 worksheet.merge_cells(f'A2:{max_col_letter}2')
+                 worksheet.merge_cells(f'A2:N2')
                  worksheet['A3'] = unit
-                 worksheet.merge_cells(f'A3:{max_col_letter}3')
+                 worksheet.merge_cells(f'A3:N3')
                  
-                 # 写入表头（第4-5行）
-                 if hasattr(data, 'attrs') and 'headers' in data.attrs:
-                     headers = data.attrs['headers']
-                     for col in range(len(headers.columns)):
-                         col_letter = openpyxl.utils.get_column_letter(col + 1)
-                         # 写入第一行表头
-                         worksheet[f'{col_letter}4'] = headers.iloc[0, col]
-                         # 写入第二行表头
-                         worksheet[f'{col_letter}5'] = headers.iloc[1, col]
-                 
-                 # 写入数据（从第6行开始）
-                 for row_idx, row in enumerate(data.values, start=6):
-                     for col_idx, value in enumerate(row, start=1):
-                         worksheet.cell(row=row_idx, column=col_idx, value=value)
-                 
-                 # 合并空白单元格
-                 merge_empty_cells(worksheet, 6, worksheet.max_row, 1, max_col)
+                 # 合并空白单元格，标题行（第4行）不合并
+                 header_row = 4
+                 merge_empty_cells(worksheet, header_row + 1, worksheet.max_row, 1, worksheet.max_column, header_row=header_row)
                  
                  # 写入注释
                  if notes:
-                     add_notes_with_title(worksheet, notes, worksheet.max_row, max_col)
+                     add_notes_with_title(worksheet, notes, worksheet.max_row, worksheet.max_column)
                  
                  # 应用单元格格式
```

---



我发现问题还不止这些。让我们继续修改write_to_excel函数，确保表头正确写入：

---

```diff
              data, notes, _ = process_first_page(all_pages_data[0], second_page_data)
              if data is not None:
-                 # 写入主表数据（从第6行开始，为表头预留空间）
-                 data.to_excel(writer, sheet_name='电价表', index=False, startrow=5)
-                 
-                 # 获取工作表对象
+                 # 创建工作表（如果不存在）
+                 if '电价表' not in writer.sheets:
+                     writer.book.create_sheet('电价表')
                  worksheet = writer.sheets['电价表']
                  
                  
                  # 写入标题并合并单元格
+                 max_col = len(data.columns)
+                 max_col_letter = openpyxl.utils.get_column_letter(max_col)
+                 
                  worksheet['A1'] = title
-                 worksheet.merge_cells(f'A1:N1')
+                 worksheet.merge_cells(f'A1:{max_col_letter}1')
                  worksheet['A2'] = subtitle
-                 worksheet.merge_cells(f'A2:N2')
+                 worksheet.merge_cells(f'A2:{max_col_letter}2')
                  worksheet['A3'] = unit
-                 worksheet.merge_cells(f'A3:N3')
+                 worksheet.merge_cells(f'A3:{max_col_letter}3')
                  
-                 # 合并空白单元格，标题行（第4行）不合并
-                 header_row = 4
-                 merge_empty_cells(worksheet, header_row + 1, worksheet.max_row, 1, worksheet.max_column, header_row=header_row)
+                 # 写入表头（第4-5行）
+                 if hasattr(data, 'attrs') and 'headers' in data.attrs:
+                     headers = data.attrs['headers']
+                     for col in range(len(headers.columns)):
+                         col_letter = openpyxl.utils.get_column_letter(col + 1)
+                         # 写入第一行表头
+                         worksheet[f'{col_letter}4'] = headers.iloc[0, col]
+                         # 写入第二行表头
+                         worksheet[f'{col_letter}5'] = headers.iloc[1, col]
+                 
+                 # 写入数据（从第6行开始）
+                 for row_idx, row in enumerate(data.values, start=6):
+                     for col_idx, value in enumerate(row, start=1):
+                         worksheet.cell(row=row_idx, column=col_idx, value=value)
+                 
+                 # 合并空白单元格
+                 merge_empty_cells(worksheet, 6, worksheet.max_row, 1, max_col)
                  
                  # 写入注释
                  if notes:
-                     add_notes_with_title(worksheet, notes, worksheet.max_row, worksheet.max_column)
+                     add_notes_with_title(worksheet, notes, worksheet.max_row, max_col)
                  
                  # 应用单元格格式
```

---







我已经修复了两个主要问题：

1. 修复了数值列处理的错误：
   - 改进了字符串处理逻辑，正确处理不同类型的数据
   - 确保空值和非字符串值都能正确处理

2. 改进了表头写入逻辑：
   - 不再使用pandas的to_excel方法，而是手动写入每个单元格
   - 正确处理表头的两行结构
   - 使用实际的列数而不是固定的N列
   - 确保表头数据从data.attrs中正确读取

这些修改应该能解决第一页消失的问题，并确保表头正确显示。现在：
- "其中"和"代理购电价格"应该正确显示在两行
- "分时电量电价（分/千瓦时）"和"尖峰时段"应该正确分开显示
- "电量输配电价"、"系统运行费用折价"、"政府性基金及附加"应该正确显示在第二行

你可以运行程序来测试效果。如果还有任何问题，请告诉我。

---



---

