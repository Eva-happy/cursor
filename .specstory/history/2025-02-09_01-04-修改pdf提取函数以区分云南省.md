<!-- Generated by SpecStory -->

# 修改PDF提取函数以区分云南省 (2025-02-09 09:04:42)

_**User**_

请问以上代码，怎么修改，才可以达到以下效果：def extract_text_from_pdf(pdf_path):"""使用PyMuPDF从本地PDF提取文本和图片"""只适用于云南，而其他省份是没有这个函数代码。extract_table_from_pdf(pdf_path, is_yunnan=False)就要区分云南省和其他省份处理：如果是云南省，则返回extract_text_from_pdf(pdf_path)，如果是其他省份，则是 @电网单元格合并之云南V4.py 第1359行至1486行

---

_**Assistant**_

我来帮你修改代码。我们需要将 `extract_text_from_pdf` 函数专门用于云南省，并修改 `extract_table_from_pdf` 函数来区分处理不同省份。

首先，我会搜索相关代码：

---

<details>
            <summary>Searched codebase "def extract_table_from_pdf(pdf_path, is_yunnan=False)" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `电网单元格合并之云南V3.py` | L1496-1541 |
| `电网单元格合并之云南V4.py` | L1352-1392 |
| `电网单元格合并之云南V3.py` | L1541-1585 |
| `电网单元格合并之云南V4.py` | L1392-1421 |
| `电网单元格合并之云南V3.py` | L1394-1424 |
| `电网单元格合并之云南V4.py` | L1447-1490 |
| `电网单元格合并之云南V3.py` | L1424-1457 |
| `电网单元格合并之云南V3.py` | L1351-1394 |
| `电网单元格合并之云南V3.py` | L1457-1496 |
| `电网单元格合并之云南V4.py` | L1490-1504 |
| `电网单元格合并之云南V3.py` | L845-876 |
| `电网单元格合并之云南V4.py` | L647-678 |
| `电网单元格合并之云南V4.py` | L1421-1447 |
| `电网.py` | L125-172 |
| `电价信息提取/南网电价信息提取2.py` | L32-47 |
| `电网单元格合并之云南V4.py` | L1302-1343 |
| `电网单元格合并之云南V4.py` | L1259-1302 |
| `电网单元格合并之云南V4.py` | L1196-1232 |
| `电网单元格合并.py` | L818-855 |
| `南网提取电价信息(pdf转excel).py` | L126-161 |
| `电网云南省excel更改.py` | L1260-1290 |
| `电网云南省excel更改.py` | L1290-1326 |
| `电网单元格合并之广州深圳贵州V3.py` | L950-986 |
| `电网单元格合并之广州深圳贵州V3.py` | L950-986 |
| `电网单元格进一步合并.py` | L961-998 |

</details>

---



根据搜索结果，我会修改代码来实现你的要求。我们需要：
1. 将 `extract_text_from_pdf` 函数专门用于云南省
2. 修改 `extract_table_from_pdf` 函数来区分处理不同省份

让我们开始修改：

---

```diff
  
  def extract_text_from_pdf(pdf_path):
-     """使用PyMuPDF从本地PDF提取文本和图片"""
+     """使用PyMuPDF从本地PDF提取文本和图片，专门用于云南省"""
      try:
          all_pages_data = []
                      if paragraphs:
                              page_data['table'] = paragraphs
-                     
-                 # 提取注释
-                 notes = []
-                 for line in lines:
-                     if any(line.startswith(prefix) for prefix in ['注：', '注:', '备注：', '备注:', '注释说明：']):
-                             notes.append(line)
-                     
-                 if notes:
-                     page_data['notes'] = notes
-                     
-                 # 提取单位信息
-                 for line in lines:
-                     if '单位' in line:
-                         page_data['unit'] = line
-                         break
-                     
-                 all_pages_data.append(page_data)
-                 print(f"第 {page_num + 1} 页处理完成")
-                     
-             except Exception as e:
-                     print(f"处理第 {page_num + 1} 页时出错: {str(e)}")
-                     continue
-                     
-         return all_pages_data
-         
-     except Exception as e:
-             print(f"提取文本失败: {str(e)}")
-             import traceback
-             traceback.print_exc()
-             return None
-     finally:
-         if 'doc' in locals():
-             doc.close()
-         else:
-             # 其他省份的处理逻辑
-             try:
-                 all_pages_data = []
-                 doc = fitz.open(pdf_path)
-                 total_pages = doc.page_count
-                 print(f"PDF共有 {total_pages} 页")
-                 
-                 for page_num in range(total_pages):
-                     try:
-                         print(f"\n处理第 {page_num + 1} 页...")
-                         page = doc[page_num]
-                         page_data = {}
-                         
-                         # 提取文本
-                         text = page.get_text()
-                         if not text:
-                             print(f"第 {page_num + 1} 页文本为空")
-                             continue
-                         
-                         # 分行处理文本
-                         lines = text.split('\n')
-                         lines = [line.strip() for line in lines if line.strip()]
-                         
-                         if not lines:
-                             print(f"第 {page_num + 1} 页没有文本行")
-                             continue
-                         
-                         # 提取标题（第一行）
-                         page_data['title'] = lines[0]
-                         
-                         # 提取执行时间（如果有）
-                         for line in lines[1:3]:
-                             if '执行时间' in line:
-                                 page_data['subtitle'] = line
-                                 break
-                         
-                         # 提取表格数据
-                         table_data = []
-                         current_row = []
-                         
-                         for line in lines[1:]:  # 跳过标题
-                             line = line.strip()
-                             if line:
-                                 # 如果行以数字开头，可能是新的一行
-                                 if re.match(r'^\d+', line):
-                                     if current_row:
-                                         table_data.append(current_row)
-                                     current_row = [line]
-                                 else:
-                                     current_row.append(line)
-                         
-                         if current_row:  # 添加最后一行
-                             table_data.append(current_row)
-                         
-                         if table_data:
-                             page_data['table'] = table_data
                      
                  # 提取注释
```

---

```diff
      try:
          if is_yunnan:
+             # 云南省特殊处理
              return extract_text_from_pdf(pdf_path)
          else:
+             # 其他省份的处理逻辑
              try:
                  all_pages_data = []
          traceback.print_exc()
          return None
-     
  def merge_empty_cells(worksheet, start_row, end_row, start_col, end_col, header_row=None):
      """合并空白单元格与相邻的有内容单元格"""
```

---



我已经完成了代码修改，主要做了以下更改：

1. 修改了 `extract_text_from_pdf` 函数，使其专门用于云南省的处理，并移除了其中的非云南省处理逻辑。

2. 修改了 `extract_table_from_pdf` 函数，使其区分云南省和其他省份的处理：
   - 当 `is_yunnan=True` 时，调用 `extract_text_from_pdf` 函数进行处理
   - 当 `is_yunnan=False` 时，使用 pdfplumber 进行其他省份的处理

这样的修改使得：
1. 云南省的PDF处理使用 PyMuPDF (fitz) 库，可以处理图片和特殊格式
2. 其他省份的PDF处理使用 pdfplumber 库，专注于表格提取
3. 代码结构更清晰，职责分明

现在代码应该可以正确处理不同省份的PDF文件了。是否还有其他需要修改的地方？

---

_**User**_

怎么看出def extract_images_from_pdf只是针对于云南省使用呢，

---

_**Assistant**_

从代码结构和调用关系来看，`extract_images_from_pdf` 函数确实是专门用于云南省的，原因如下：

1. 函数注释明确说明：
```python
def extract_images_from_pdf(pdf_path, page_num):
    """使用PyMuPDF从本地PDF提取图片,专门用于云南省"""
```

2. 调用关系：
- 这个函数只在 `extract_text_from_pdf` 函数中被调用：
```python
def extract_text_from_pdf(pdf_path):
    # ...
    if page_num < 3:
        image_data = extract_images_from_pdf(pdf_path, page_num + 1)
        if image_data:
            page_data['images'] = image_data
```

3. 处理流程：
- `extract_table_from_pdf` 是主入口函数，它根据 `is_yunnan` 参数来决定使用哪种处理方式：
```python
def extract_table_from_pdf(pdf_path, is_yunnan=False):
    try:
        if is_yunnan:
            # 云南省特殊处理
            return extract_text_from_pdf(pdf_path)
        else:
            # 其他省份的处理逻辑
            # ...使用 pdfplumber 处理，不涉及图片提取
```

4. 功能特点：
- 云南省的PDF处理需要提取前三页的图片（`if page_num < 3`）
- 其他省份的处理逻辑中完全没有调用 `extract_images_from_pdf` 函数
- 其他省份使用 pdfplumber 库只提取表格数据，不处理图片

5. 写入Excel时的区别：
```python
def write_to_excel(all_pages_data, project_name=None, is_yunnan=False):
    # ...
    if is_yunnan:
        # 云南省特殊处理
        if page_index <= 3:  # 前三页
            # ... 处理包含图片的页面
```

所以，虽然函数名称本身没有包含"云南"，但从整个代码的结构和调用关系来看，它确实是专门为处理云南省的PDF文件而设计的。如果你想让这一点更明确，可以考虑将函数名改为 `extract_images_from_yunnan_pdf` 或类似的更具描述性的名称。

---

_**User**_

怎么看出def extract_text_from_pdf只是针对于云南省使用呢，

---

_**Assistant**_

从代码中可以看出 `extract_text_from_pdf` 是专门用于云南省的，主要有以下几点证据：

1. 函数注释明确说明：
```python
def extract_text_from_pdf(pdf_path):
    """使用PyMuPDF从本地PDF提取文本和图片，专门用于云南省"""
```

2. 调用关系：
在 `extract_table_from_pdf` 函数中，只有当 `is_yunnan=True` 时才会调用 `extract_text_from_pdf`：
```python
def extract_table_from_pdf(pdf_path, is_yunnan=False):
    try:
        if is_yunnan:
            # 云南省特殊处理
            return extract_text_from_pdf(pdf_path)
        else:
            # 其他省份的处理逻辑...
```

3. 处理逻辑特点：
- 前三页和后三页有不同的处理逻辑：
```python
if page_num < 3:  # 前三页：保留表格结构
    # ... 前三页的特殊处理
else:  # 后三页：按段落分割
    # ... 后三页的特殊处理
```

4. 图片处理：
- 只处理前三页的图片，这是云南省PDF的特殊要求：
```python
# 提取图片（前三页）
if page_num < 3:
    image_data = extract_images_from_pdf(pdf_path, page_num + 1)
    if image_data:
         page_data['images'] = image_data
```

5. 与其他省份处理方式的区别：
- 云南省使用 PyMuPDF (fitz) 库处理
- 其他省份使用 pdfplumber 库处理
- 云南省需要处理图片，其他省份不需要
- 云南省有特殊的页面结构（前三页和后三页不同）

6. 与写入Excel的关联：
在 `write_to_excel` 函数中，对云南省数据有特殊处理：
```python
if is_yunnan:
    # 云南省特殊处理
    if page_index <= 3:  # 前三页
        # ... 云南省特有的处理逻辑
```

所以，虽然函数名本身没有包含"云南"，但从代码结构、注释和处理逻辑来看，它确实是专门为处理云南省的PDF文件而设计的。如果想让这一点更明确，可以考虑将函数名改为 `extract_text_from_yunnan_pdf` 以更好地表达其用途。

---



---

