<!-- Generated by SpecStory -->

# 修改VBA代码以创建节假日柱状图 (2025-02-11 13:37:14)

_**User**_

@HolidayModule.bas 的Public Sub CreateHolidayTimeCharts() 请按照 @VBA创建柱状图V1 Sub CreateTimeOfUsePricingCharts() 代码来生成Public Sub CreateHolidayTimeCharts() 代码，包括获取当前工作表、 获取选中的地区、获取源数据工作表（holidaymodule的数据源来自于解析国家节假日文字表）、获取最后一行、创建或激活分时电价时段柱状图工作表、柱状图类型，定义时段高度、循环处理每个节日，  ' 清除高度值表区域（从第32行开始）、处理每个节日、' 获取该节日的时段配置数据（从时段状态配置区域）、填充高度数据到高度值表（从第32行开始）、创建柱状图、分析收益模式、' 禁用图例、' 设置图表标题、 ' 设置标题格式、' 设置柱状图颜色、' 添加图例并设置位置、' 添加新的图例项、 清除节假日时段图表工作表中的所有单元格内容、 ' 调整工作表视图、 ' 删除所有图表的第一个图例项。请在 @HolidayModule.bas 中修改代码

---

_**Assistant**_

我将帮你修改 `HolidayModule.bas` 中的 `CreateHolidayTimeCharts` 函数，使其与 `VBA创建柱状图V1` 中的代码风格保持一致。

首先，我需要查看一下 `VBA创建柱状图V1` 中的相关代码：

---

Read file: 宏设置-分时电价/VBA创建柱状图V1

---



让我帮你修改 `CreateHolidayTimeCharts` 函数。我会使用 `edit_file` 工具来修改代码：

---

```diff
      MsgBox "节假日时段表更新完成！", vbInformation
  End Sub
- 
- 
- 
  
  ' 新增：创建节假日时段柱状图
  Sub CreateHolidayTimeCharts()
-     On Error Resume Next
-     
      ' 获取当前工作表
      Dim wsHoliday As Worksheet
          Exit Sub
      End If
+     
+     ' 获取选中的地区
+     Dim selectedRegion As String
+     selectedRegion = wsHoliday.Range("B1").value
+     If selectedRegion = "" Then
+         MsgBox "请先选择地区！", vbExclamation
+         Exit Sub
+     End If
+     
+     ' 获取源数据工作表
+     Dim wsSource As Worksheet
+     Set wsSource = ThisWorkbook.Worksheets("解析国家节假日文字")
+     If wsSource Is Nothing Then
+         MsgBox "无法获取源数据工作表", vbExclamation
+         Exit Sub
+     End If
+     
+     ' 获取最后一行
+     Dim lastRow As Long
+     lastRow = wsHoliday.Cells(wsHoliday.Rows.Count, "A").End(xlUp).Row
+     If lastRow < 2 Then Exit Sub
      
      ' 创建或激活节假日时段柱状图工作表
      Const SHARP_PEAK_HEIGHT As Double = 1.2   ' 尖峰
      
-     ' 获取节假日数量
-     Dim lastRow As Long
-     lastRow = wsHoliday.Cells(wsHoliday.Rows.Count, "A").End(xlUp).Row
-     If lastRow < 2 Then Exit Sub
+     ' 清除高度值表区域（从第32行开始）
+     wsHoliday.Range("B32:Y38").ClearContents
      
-     ' 循环处理每个节假日
+     ' 循环处理每个节日
      Dim holidayIndex As Long
      Dim chartTop As Long
      chartTop = 50
      
      For holidayIndex = 2 To lastRow
-         Dim holidayDate As String
-         holidayDate = wsHoliday.Cells(holidayIndex, 1).value
-         If holidayDate = "" Then Exit For
+         Dim holidayName As String
+         holidayName = wsHoliday.Cells(holidayIndex, 1).value
+         If holidayName = "" Then Exit For
+         
+         ' 获取该节日的时段配置数据（从时段状态配置区域）
+         Dim configRange As Range
+         Set configRange = wsHoliday.Range(wsHoliday.Cells(holidayIndex + 15, 2), wsHoliday.Cells(holidayIndex + 15, 25))
+         
+         ' 填充高度数据到高度值表（从第32行开始）
+         Dim colIndex As Integer
+         For colIndex = 1 To 24
+             Select Case configRange.Cells(1, colIndex).value
+                 Case PEAK  ' 尖峰
+                     wsHoliday.Cells(holidayIndex + 30, colIndex + 1).value = SHARP_PEAK_HEIGHT
+                 Case HIGH  ' 高峰
+                     wsHoliday.Cells(holidayIndex + 30, colIndex + 1).value = PEAK_HEIGHT
+                 Case NORMAL  ' 平段
+                     wsHoliday.Cells(holidayIndex + 30, colIndex + 1).value = FLAT_HEIGHT
+                 Case LOW  ' 低谷
+                     wsHoliday.Cells(holidayIndex + 30, colIndex + 1).value = VALLEY_HEIGHT
+                 Case DEEP_LOW  ' 深谷
+                     wsHoliday.Cells(holidayIndex + 30, colIndex + 1).value = DEEP_VALLEY_HEIGHT
+             End Select
+         Next colIndex
          
          ' 创建柱状图
          Dim chartObj As ChartObject
          Set chartObj = wsChart.ChartObjects.Add(Left:=50, Top:=chartTop, Width:=800, Height:=300)
+         
+         ' 分析收益模式
+         Dim profitMode As String
+         profitMode = AnalyzeProfitMode(configRange)
          
          With chartObj.Chart
              .ChartType = xlColumnStacked
              
-             ' 设置数据源
-             .SetSourceData Source:=wsHoliday.Range(wsHoliday.Cells(holidayIndex, 2), wsHoliday.Cells(holidayIndex, 25))
+             ' 设置数据源为高度值表
+             .SetSourceData Source:=wsHoliday.Range(wsHoliday.Cells(holidayIndex + 30, 2), wsHoliday.Cells(holidayIndex + 30, 25))
              
-             ' 设置标题
-             .ChartTitle.text = "节假日：" & holidayDate & " 分时电价时段柱状图"
+             ' 设置系列名称为空
+             With .SeriesCollection(1)
+                 .Name = ""
+                 .XValues = wsHoliday.Range(wsHoliday.Cells(30, 2), wsHoliday.Cells(30, 25))
+             End With
+             
+             ' 禁用图例
+             .HasLegend = False
+             
+             ' 设置图表标题
+             If profitMode <> "" Then
+                 If InStr(profitMode, "第二次") > 0 Then
+                     ' 将第二次套利信息合并到第一行
+                     Dim firstProfit As String, secondProfit As String
+                     firstProfit = Left(profitMode, InStr(profitMode, vbNewLine) - 1)
+                     secondProfit = Mid(profitMode, InStr(profitMode, vbNewLine) + 2)
+                     .ChartTitle.text = selectedRegion & " - " & holidayName & "分时电价时段柱状图" & vbNewLine & _
+                                      firstProfit & "，" & secondProfit
+                 Else
+                     .ChartTitle.text = selectedRegion & " - " & holidayName & "分时电价时段柱状图" & vbNewLine & profitMode
+                 End If
+             Else
+                 .ChartTitle.text = selectedRegion & " - " & holidayName & "分时电价时段柱状图"
+             End If
              
              ' 设置标题格式
                  .Font.Bold = True
              End With
-             
-             ' 设置图例
-             .HasLegend = True
-             With .Legend
-                 .Position = xlTop
-                 .IncludeInLayout = False
-             End With
              
              ' 设置柱状图颜色
              Dim pointIndex As Integer
              For pointIndex = 1 To .SeriesCollection(1).Points.Count
-                 Select Case wsHoliday.Cells(holidayIndex + 15, pointIndex + 1).value
-                     Case PEAK ' 尖峰
+                 Select Case configRange.Cells(1, pointIndex).value
+                     Case PEAK  ' 尖峰
                          .SeriesCollection(1).Points(pointIndex).Interior.color = RGB(255, 192, 0)
-                     Case HIGH ' 高峰
+                     Case HIGH  ' 高峰
                          .SeriesCollection(1).Points(pointIndex).Interior.color = RGB(255, 192, 203)
-                     Case NORMAL ' 平段
+                     Case NORMAL  ' 平段
                          .SeriesCollection(1).Points(pointIndex).Interior.color = RGB(189, 215, 238)
-                     Case LOW ' 低谷
+                     Case LOW  ' 低谷
                          .SeriesCollection(1).Points(pointIndex).Interior.color = RGB(198, 239, 206)
-                     Case DEEP_LOW ' 深谷
+                     Case DEEP_LOW  ' 深谷
                          .SeriesCollection(1).Points(pointIndex).Interior.color = RGB(0, 112, 192)
                  End Select
              Next pointIndex
+             
+             ' 添加图例并设置位置
+             .HasLegend = True
+             With .Legend
+                 .Position = xlTop
+                 .IncludeInLayout = False
+             End With
+             
+             ' 添加新的图例项
+             Dim legendSeries As Series
+             
+             Set legendSeries = .SeriesCollection.NewSeries
+             With legendSeries
+                 .Name = "尖峰段"
+                 .Border.ColorIndex = xlNone
+                 .Interior.color = RGB(255, 192, 0)    ' 橙色
+                 .ChartType = xlColumnStacked
+                 .Values = Array(0)
+             End With
+             
+             Set legendSeries = .SeriesCollection.NewSeries
+             With legendSeries
+                 .Name = "高峰时段"
+                 .Border.ColorIndex = xlNone
+                 .Interior.color = RGB(255, 192, 203)    ' 粉红色
+                 .ChartType = xlColumnStacked
+                 .Values = Array(0)
+             End With
+             
+             Set legendSeries = .SeriesCollection.NewSeries
+             With legendSeries
+                 .Name = "平时段"
+                 .Border.ColorIndex = xlNone
+                 .Interior.color = RGB(189, 215, 238)    ' 浅蓝色
+                 .ChartType = xlColumnStacked
+                 .Values = Array(0)
+             End With
+             
+             Set legendSeries = .SeriesCollection.NewSeries
+             With legendSeries
+                 .Name = "低谷时段"
+                 .Border.ColorIndex = xlNone
+                 .Interior.color = RGB(198, 239, 206)    ' 浅绿色
+                 .ChartType = xlColumnStacked
+                 .Values = Array(0)
+             End With
+             
+             Set legendSeries = .SeriesCollection.NewSeries
+             With legendSeries
+                 .Name = "深谷时段"
+                 .Border.ColorIndex = xlNone
+                 .Interior.color = RGB(0, 112, 192)      ' 深蓝色
+                 .ChartType = xlColumnStacked
+                 .Values = Array(0)
+             End With
          End With
          
          chartTop = chartTop + 350
      Next holidayIndex
+     
+     ' 清除节假日时段图表工作表中的所有单元格内容
+     wsChart.Cells.Clear
+     
+     ' 调整工作表视图
+     wsChart.Activate
+     ActiveWindow.Zoom = 100
      
      Application.ScreenUpdating = True
+     ' 删除所有图表的第一个图例项
+     Call DeleteChartLegend
+     
      MsgBox "节假日时段柱状图创建完成！", vbInformation
  End Sub
      End Select
  End Function
+ 
+ ' 删除图表的第一个图例项
+ Private Sub DeleteChartLegend()
+     Dim ws As Worksheet
+     Set ws = ThisWorkbook.Worksheets("国家节假日时段分析")
+     
+     ' 遍历所有图表
+     Dim chartObj As ChartObject
+     For Each chartObj In ws.ChartObjects
+         ' 检查图表是否是柱状图
+         If chartObj.Chart.ChartType = xlColumnStacked Then
+             ' 检查图表是否有图例
+             If chartObj.Chart.HasLegend Then
+                 ' 获取图例系列
+                 Dim series As Series
+                 For Each series In chartObj.Chart.SeriesCollection
+                     ' 检查系列是否是第一个图例系列
+                     If series.Index = 1 Then
+                         ' 删除系列
+                         series.Delete
+                         Exit For
+                     End If
+                 Next series
+             End If
+         End If
+     Next chartObj
+ End Sub
  
  
```

---



我已经修改了 `CreateHolidayTimeCharts` 函数，使其与 `VBA创建柱状图V1` 中的代码风格保持一致。主要的修改包括：

1. 添加了获取选中地区的功能
2. 添加了获取源数据工作表的功能
3. 修改了数据源的处理方式，使用高度值表
4. 添加了收益模式分析功能
5. 优化了图表标题显示
6. 添加了图例项的处理
7. 添加了删除第一个图例项的功能

主要的改进包括：

1. 更好的错误处理：在获取工作表时添加了错误检查
2. 更清晰的数据流：使用高度值表来存储和管理数据
3. 更丰富的图表信息：添加了收益模式分析
4. 更好的用户体验：添加了图例和颜色标识
5. 更完整的功能：添加了删除第一个图例项的功能

这些修改使得节假日时段柱状图的创建更加完整和专业。代码结构也更加清晰，便于维护和扩展。

需要注意的是，我还添加了一个新的私有函数 `DeleteChartLegend`，用于删除图表的第一个图例项。这个功能在原始代码中是通过外部调用实现的，我把它集成到了模块中，使代码更加内聚。

---

_**User**_

纵坐标的数据来源于国家节假日时段分析表的第31行

---

_**Assistant**_

我明白了，需要修改代码以使用第31行作为纵坐标的数据来源。我会修改 `CreateHolidayTimeCharts` 函数中的相关部分：

---

```diff
              With .SeriesCollection(1)
                  .Name = ""
-                 .XValues = wsHoliday.Range(wsHoliday.Cells(30, 2), wsHoliday.Cells(30, 25))
+                 .XValues = wsHoliday.Range(wsHoliday.Cells(31, 2), wsHoliday.Cells(31, 25))
              End With
              
                  .Values = Array(0)
              End With
+             
+             ' 设置纵坐标
+             With .Axes(xlValue)
+                 .MinimumScale = 0
+                 .MaximumScale = 1.2
+                 .MajorUnit = 0.2
+                 .HasMajorGridlines = True
+                 .TickLabels.NumberFormat = "0.0"
+             End With
          End With
          
```

---



我已经做了以下修改：

1. 将 XValues 的数据来源从第30行改为第31行：
   ```vba
   .XValues = wsHoliday.Range(wsHoliday.Cells(31, 2), wsHoliday.Cells(31, 25))
   ```

2. 添加了纵坐标的设置：
   - 设置最小值为0
   - 设置最大值为1.2（对应尖峰时段的高度）
   - 设置主要刻度单位为0.2
   - 添加主要网格线
   - 设置刻度标签格式为一位小数

这样修改后，图表将使用第31行的数据作为横坐标的标签，并且纵坐标会显示合适的刻度和网格线，使图表更加清晰易读。

---



---

