<!-- Generated by SpecStory -->

# 敏感性分析表创建指导 (2025-02-14 16:54:25)

_**User**_

附件是一个测算表，我想针对发电小时数，电价，消纳率对全投资IRR和资本金IRR做一个敏感性分析，我应该怎么创建一个sheet来引用参数来修改呢？让我输入参数的变化范围值，然后利用现有的公式算出新的IRR，然后计算敏感性系数

---

_**Assistant**_

我来帮您创建一个敏感性分析的方案。首先让我们了解一下当前的文件结构和内容。

---

<details>
            <summary>Listed directory 敏感性分析 • **2** results</summary>
        
| Name |
|-------|
| 📄 `原始数据` |
| 📄 `贵州兴义豫能光伏24MW项目测算表（消纳90%）.xlsx` |

</details>

---



我建议按以下步骤创建敏感性分析：

1. 首先在Excel文件中创建一个新的工作表，命名为"敏感性分析"。

2. 在这个工作表中，我们可以设计如下结构：

```
A. 参数输入区域：
   - 发电小时数变化范围（基准值±10%，步长5%）
   - 电价变化范围（基准值±10%，步长5%）
   - 消纳率变化范围（基准值±10%，步长5%）

B. 计算结果区域：
   - 创建一个表格，显示不同参数变化时的全投资IRR和资本金IRR
   - 计算敏感性系数

C. 公式引用：
   - 从原始测算表中引用基准参数值
   - 设置公式自动计算不同参数变化情况下的IRR
```

具体操作建议：

1. **参数输入区域设置**：
   - A1单元格写入"参数设置"
   - A3:D3分别设置为"参数名称"、"基准值"、"变化幅度(%)"、"步长(%)"
   - A4:A6分别填入"发电小时数"、"电价"、"消纳率"
   - B4:B6引用原始数据中的基准值
   - C4:C6设置为10（表示±10%）
   - D4:D6设置为5（表示5%的步长）

2. **结果表格设置**：
   - 从A8开始创建结果表格
   - 横向设置参数变化率（-10%、-5%、0、+5%、+10%）
   - 纵向列出三个参数
   - 分别计算对应的全投资IRR和资本金IRR

3. **敏感性系数计算**：
   - 敏感性系数 = (IRR变化率) / (参数变化率)
   - 在结果表格下方添加敏感性系数汇总

4. **公式设置**：
   ```excel
   参数变化值 = 基准值 * (1 + 变化率)
   IRR变化率 = (新IRR - 基准IRR) / 基准IRR
   敏感性系数 = IRR变化率 / 参数变化率
   ```

您需要我帮您具体实现这个方案吗？我可以帮您：
1. 创建新的工作表
2. 设置具体的公式和格式
3. 建立与原始数据的引用关系

请告诉我您想从哪一步开始，我会为您提供详细的操作指导。

---

_**User**_

在这个原有的excel里创建新的工作表，设置具体的公式和格式，建立与原始数据的引用关系

---

_**Assistant**_

好的，我来帮您在Excel中创建敏感性分析工作表。首先让我们查看一下原始数据中的关键参数位置。

---

文件似乎是二进制文件，不能作为文本打开

---



我明白了，因为这是Excel文件，我们需要使用Excel VBA来处理。我建议创建一个VBA宏来帮助我们完成这个任务。以下是具体的实现步骤：

1. 首先，我们需要创建一个新的VBA模块来添加我们的代码：

---

```diff
- 
+ Attribute VB_Name = "SensitivityAnalysis"
+ Option Explicit
+ 
+ Sub CreateSensitivityAnalysis()
+     Dim ws As Worksheet
+     Dim baseSheet As Worksheet
+     
+     ' 检查是否已存在敏感性分析表，如果存在则删除
+     On Error Resume Next
+     Application.DisplayAlerts = False
+     ThisWorkbook.Sheets("敏感性分析").Delete
+     Application.DisplayAlerts = True
+     On Error GoTo 0
+     
+     ' 创建新的工作表
+     Set ws = ThisWorkbook.Sheets.Add(After:=ThisWorkbook.Sheets(ThisWorkbook.Sheets.Count))
+     ws.Name = "敏感性分析"
+     
+     ' 设置标题和参数区域
+     With ws
+         .Range("A1").Value = "参数设置"
+         .Range("A1:D1").Merge
+         .Range("A1").Font.Bold = True
+         .Range("A1").HorizontalAlignment = xlCenter
+         
+         ' 设置参数表头
+         .Range("A3:D3") = Array("参数名称", "基准值", "变化幅度(%)", "步长(%)")
+         .Range("A4:A6") = Application.Transpose(Array("发电小时数", "电价", "消纳率"))
+         
+         ' 设置默认值
+         .Range("C4:C6").Value = 10    ' 变化幅度±10%
+         .Range("D4:D6").Value = 5     ' 步长5%
+         
+         ' 设置结果区域标题
+         .Range("A8").Value = "全投资IRR敏感性分析"
+         .Range("A8:G8").Merge
+         .Range("A8").Font.Bold = True
+         .Range("A8").HorizontalAlignment = xlCenter
+         
+         ' 设置变化率表头
+         .Range("B10:F10") = Array("-10%", "-5%", "0%", "5%", "10%")
+         .Range("A11:A13") = Application.Transpose(Array("发电小时数", "电价", "消纳率"))
+         
+         ' 设置资本金IRR分析区域
+         .Range("A15").Value = "资本金IRR敏感性分析"
+         .Range("A15:G15").Merge
+         .Range("A15").Font.Bold = True
+         .Range("A15").HorizontalAlignment = xlCenter
+         
+         .Range("B17:F17") = Array("-10%", "-5%", "0%", "5%", "10%")
+         .Range("A18:A20") = Application.Transpose(Array("发电小时数", "电价", "消纳率"))
+         
+         ' 设置敏感性系数区域
+         .Range("A22").Value = "敏感性系数汇总"
+         .Range("A22:D22").Merge
+         .Range("A22").Font.Bold = True
+         .Range("A22").HorizontalAlignment = xlCenter
+         
+         .Range("A24:A26") = Application.Transpose(Array("发电小时数", "电价", "消纳率"))
+         .Range("B23:C23") = Array("全投资IRR敏感性系数", "资本金IRR敏感性系数")
+     End With
+     
+     ' 设置格式
+     With ws.Range("A1:G26")
+         .Borders.LineStyle = xlContinuous
+         .HorizontalAlignment = xlCenter
+     End With
+     
+     ' 调整列宽
+     ws.Columns("A:G").AutoFit
+     
+     ' 添加公式
+     AddFormulas ws
+ End Sub
+ 
+ Sub AddFormulas()
+     Dim ws As Worksheet
+     Set ws = ThisWorkbook.Sheets("敏感性分析")
+     
+     ' 这里需要根据原始数据表中的实际位置设置引用公式
+     ' 示例：假设原始数据在"计算表"工作表中
+     With ws
+         ' 引用基准值（需要根据实际位置修改）
+         .Range("B4").Formula = "='计算表'!B10"  ' 发电小时数
+         .Range("B5").Formula = "='计算表'!B11"  ' 电价
+         .Range("B6").Formula = "='计算表'!B12"  ' 消纳率
+         
+         ' 设置IRR计算公式（需要根据实际位置修改）
+         ' 全投资IRR计算
+         For i = 11 To 13
+             For j = 2 To 6
+                 .Cells(i, j).Formula = "=计算新IRR()"  ' 需要创建自定义函数
+             Next j
+         Next i
+         
+         ' 资本金IRR计算
+         For i = 18 To 20
+             For j = 2 To 6
+                 .Cells(i, j).Formula = "=计算新IRR()"  ' 需要创建自定义函数
+             Next j
+         Next i
+         
+         ' 敏感性系数计算
+         For i = 24 To 26
+             .Cells(i, 2).Formula = "=(F" & (i - 13) & "-B" & (i - 13) & ")/(0.1*2)"  ' 全投资IRR敏感性系数
+             .Cells(i, 3).Formula = "=(F" & (i - 6) & "-B" & (i - 6) & ")/(0.1*2)"    ' 资本金IRR敏感性系数
+         Next i
+     End With
+ End Sub 
```

---



现在，我们还需要创建一个函数来计算新的IRR值。让我添加计算IRR的函数：

---

```diff
- 
+ Attribute VB_Name = "IRRCalculation"
+ Option Explicit
+ 
+ Function 计算新IRR(ByVal 参数类型 As String, ByVal 变化率 As Double, ByVal IRR类型 As String) As Double
+     Dim ws As Worksheet
+     Dim baseSheet As Worksheet
+     Dim baseValue As Double
+     Dim newValue As Double
+     
+     ' 获取基准值
+     Set baseSheet = ThisWorkbook.Sheets("计算表")  ' 需要根据实际工作表名称修改
+     
+     Select Case 参数类型
+         Case "发电小时数"
+             baseValue = baseSheet.Range("B10").Value  ' 需要根据实际单元格位置修改
+         Case "电价"
+             baseValue = baseSheet.Range("B11").Value  ' 需要根据实际单元格位置修改
+         Case "消纳率"
+             baseValue = baseSheet.Range("B12").Value  ' 需要根据实际单元格位置修改
+     End Select
+     
+     ' 计算新值
+     newValue = baseValue * (1 + 变化率)
+     
+     ' 临时更新参数
+     Select Case 参数类型
+         Case "发电小时数"
+             baseSheet.Range("B10").Value = newValue
+         Case "电价"
+             baseSheet.Range("B11").Value = newValue
+         Case "消纳率"
+             baseSheet.Range("B12").Value = newValue
+     End Select
+     
+     ' 获取IRR值
+     If IRR类型 = "全投资" Then
+         计算新IRR = baseSheet.Range("IRR_CELL").Value  ' 需要替换为实际IRR单元格位置
+     Else
+         计算新IRR = baseSheet.Range("资本金IRR_CELL").Value  ' 需要替换为实际资本金IRR单元格位置
+     End If
+     
+     ' 恢复原始值
+     Select Case 参数类型
+         Case "发电小时数"
+             baseSheet.Range("B10").Value = baseValue
+         Case "电价"
+             baseSheet.Range("B11").Value = baseValue
+         Case "消纳率"
+             baseSheet.Range("B12").Value = baseValue
+     End Select
+ End Function 
```

---



为了使用这些代码，您需要：

1. 打开Excel文件
2. 按Alt + F11打开VBA编辑器
3. 在VBA编辑器中导入这两个.bas文件
4. 在使用之前，您需要修改以下内容：
   - 在`IRRCalculation.bas`中：
     - 修改工作表名称"计算表"为您实际的工作表名称
     - 修改单元格引用（B10、B11、B12）为实际的参数位置
     - 修改IRR_CELL和资本金IRR_CELL为实际的IRR单元格位置

5. 修改完成后，您可以：
   - 运行`CreateSensitivityAnalysis`宏来创建敏感性分析表
   - 在新创建的"敏感性分析"工作表中输入参数变化范围
   - 系统会自动计算不同参数变化情况下的IRR值和敏感性系数

这个方案的优点是：
1. 自动创建格式化的敏感性分析表
2. 自动计算不同参数变化下的IRR值
3. 自动计算敏感性系数
4. 保持原始数据不变
5. 可以随时更新计算结果

您需要我帮您修改具体的单元格引用位置吗？如果需要，请告诉我原始数据表中：
1. 发电小时数
2. 电价
3. 消纳率
4. 全投资IRR
5. 资本金IRR
这些参数的具体单元格位置，我可以帮您更新代码。

---

_**User**_

 ' 获取基准值具体是需要什么值

---

_**Assistant**_

根据您的敏感性分析需求，我们需要从原始数据表中获取以下基准值：

1. **发电小时数**：
   - 通常在项目参数表中，是年发电小时数或等效利用小时数
   - 单位一般是小时(h)

2. **电价**：
   - 项目的上网电价或者售电价格
   - 单位一般是元/kWh

3. **消纳率**：
   - 项目的电力消纳比例
   - 单位是百分比(%)，比如90%就是0.9

4. **IRR值**：
   - 全投资IRR：项目整体的内部收益率
   - 资本金IRR：股东投资的内部收益率
   - 单位都是百分比(%)

请您查看原始测算表中这些参数的具体位置（单元格编号），我需要：
1. 原始测算表的工作表名称（目前代码中用的是"计算表"）
2. 发电小时数的单元格位置（目前代码中用的是B10）
3. 电价的单元格位置（目前代码中用的是B11）
4. 消纳率的单元格位置（目前代码中用的是B12）
5. 全投资IRR的单元格位置（目前代码中用的是IRR_CELL）
6. 资本金IRR的单元格位置（目前代码中用的是资本金IRR_CELL）

有了这些信息后，我可以帮您修改代码中的单元格引用，使其能够正确计算敏感性分析结果。

---

_**User**_

测算表的工作表名称：基础参数及输出结果表；发电小时数的单元格位置：B24,电价的单元格位置：B42，消纳率的单元格位置：B37，全投资IRR的单元格位置：N8；资本金IRR的单元格位置：N10

---

_**Assistant**_

好的，我来帮您修改代码中的单元格引用。我会更新两个模块中的相关位置：

1. 首先修改 `IRRCalculation.bas` 文件：

---

```diff
      
      ' 获取基准值
-     Set baseSheet = ThisWorkbook.Sheets("计算表")  ' 需要根据实际工作表名称修改
+     Set baseSheet = ThisWorkbook.Sheets("基础参数及输出结果表")
      
      Select Case 参数类型
          Case "发电小时数"
-             baseValue = baseSheet.Range("B10").Value  ' 需要根据实际单元格位置修改
+             baseValue = baseSheet.Range("B24").Value
          Case "电价"
-             baseValue = baseSheet.Range("B11").Value  ' 需要根据实际单元格位置修改
+             baseValue = baseSheet.Range("B42").Value
          Case "消纳率"
-             baseValue = baseSheet.Range("B12").Value  ' 需要根据实际单元格位置修改
+             baseValue = baseSheet.Range("B37").Value
      End Select
      
      Select Case 参数类型
          Case "发电小时数"
-             baseSheet.Range("B10").Value = newValue
+             baseSheet.Range("B24").Value = newValue
          Case "电价"
-             baseSheet.Range("B11").Value = newValue
+             baseSheet.Range("B42").Value = newValue
          Case "消纳率"
-             baseSheet.Range("B12").Value = newValue
+             baseSheet.Range("B37").Value = newValue
      End Select
      
      ' 获取IRR值
      If IRR类型 = "全投资" Then
-         计算新IRR = baseSheet.Range("IRR_CELL").Value  ' 需要替换为实际IRR单元格位置
+         计算新IRR = baseSheet.Range("N8").Value
      Else
-         计算新IRR = baseSheet.Range("资本金IRR_CELL").Value  ' 需要替换为实际资本金IRR单元格位置
+         计算新IRR = baseSheet.Range("N10").Value
      End If
      
      ' 恢复原始值
      Select Case 参数类型
          Case "发电小时数"
-             baseSheet.Range("B10").Value = baseValue
+             baseSheet.Range("B24").Value = baseValue
          Case "电价"
-             baseSheet.Range("B11").Value = baseValue
+             baseSheet.Range("B42").Value = baseValue
          Case "消纳率"
-             baseSheet.Range("B12").Value = baseValue
+             baseSheet.Range("B37").Value = baseValue
      End Select
  End Function 
```

---



2. 现在修改 `SensitivityAnalysis.bas` 文件中的引用：

---

```diff
      Set ws = ThisWorkbook.Sheets("敏感性分析")
      
-     ' 这里需要根据原始数据表中的实际位置设置引用公式
-     ' 示例：假设原始数据在"计算表"工作表中
      With ws
-         ' 引用基准值（需要根据实际位置修改）
-         .Range("B4").Formula = "='计算表'!B10"  ' 发电小时数
-         .Range("B5").Formula = "='计算表'!B11"  ' 电价
-         .Range("B6").Formula = "='计算表'!B12"  ' 消纳率
+         ' 引用基准值
+         .Range("B4").Formula = "='基础参数及输出结果表'!B24"  ' 发电小时数
+         .Range("B5").Formula = "='基础参数及输出结果表'!B42"  ' 电价
+         .Range("B6").Formula = "='基础参数及输出结果表'!B37"  ' 消纳率
          
-         ' 设置IRR计算公式（需要根据实际位置修改）
+         ' 设置IRR计算公式
          ' 全投资IRR计算
+         Dim i As Long, j As Long
          For i = 11 To 13
              For j = 2 To 6
-                 .Cells(i, j).Formula = "=计算新IRR()"  ' 需要创建自定义函数
+                 Dim 参数类型 As String
+                 Select Case i
+                     Case 11: 参数类型 = "发电小时数"
+                     Case 12: 参数类型 = "电价"
+                     Case 13: 参数类型 = "消纳率"
+                 End Select
+                 
+                 Dim 变化率 As Double
+                 变化率 = (j - 4) * 0.05  ' -10%, -5%, 0%, 5%, 10%
+                 
+                 .Cells(i, j).Formula = "=计算新IRR(""" & 参数类型 & """," & 变化率 & ",""全投资"")"
              Next j
          Next i
          For i = 18 To 20
              For j = 2 To 6
-                 .Cells(i, j).Formula = "=计算新IRR()"  ' 需要创建自定义函数
+                 Select Case i
+                     Case 18: 参数类型 = "发电小时数"
+                     Case 19: 参数类型 = "电价"
+                     Case 20: 参数类型 = "消纳率"
+                 End Select
+                 
+                 变化率 = (j - 4) * 0.05  ' -10%, -5%, 0%, 5%, 10%
+                 
+                 .Cells(i, j).Formula = "=计算新IRR(""" & 参数类型 & """," & 变化率 & ",""资本金"")"
              Next j
          Next i
```

---



我已经完成了代码的更新，主要修改了以下内容：

1. 更新了工作表名称从"计算表"到"基础参数及输出结果表"
2. 更新了所有单元格引用：
   - 发电小时数：B24
   - 电价：B42
   - 消纳率：B37
   - 全投资IRR：N8
   - 资本金IRR：N10
3. 完善了IRR计算公式的实现，添加了具体的参数传递

现在您可以：

1. 在Excel中按Alt + F11打开VBA编辑器
2. 导入这两个.bas文件（如果是新建的话）
3. 运行`CreateSensitivityAnalysis`宏来创建敏感性分析表

运行后，新创建的"敏感性分析"工作表将：
1. 自动从基础参数表引用基准值
2. 自动计算不同变化率（-10%到+10%）下的IRR值
3. 自动计算敏感性系数

如果您在运行过程中遇到任何问题，请告诉我，我会帮您解决。

---

_**User**_

错误的参数号，无效的属性赋值

---

_**Assistant**_

这个错误通常是因为 VBA 代码中参数传递的格式问题。让我修改一下代码中的公式部分：

---

```diff
      
      ' 添加公式
-     AddFormulas ws
+     Call AddFormulas(ws)
  End Sub
  
- Sub AddFormulas()
-     Dim ws As Worksheet
-     Set ws = ThisWorkbook.Sheets("敏感性分析")
+ Sub AddFormulas(ByVal ws As Worksheet)
+     Dim i As Long, j As Long
+     Dim 参数类型 As String
+     Dim 变化率 As String
      
      With ws
          .Range("B6").Formula = "='基础参数及输出结果表'!B37"  ' 消纳率
          
-         ' 设置IRR计算公式
          ' 全投资IRR计算
-         Dim i As Long, j As Long
          For i = 11 To 13
              For j = 2 To 6
-                 Dim 参数类型 As String
                  Select Case i
                      Case 11: 参数类型 = "发电小时数"
                  End Select
                  
-                 Dim 变化率 As Double
-                 变化率 = (j - 4) * 0.05  ' -10%, -5%, 0%, 5%, 10%
+                 变化率 = Format((j - 4) * 0.05, "0.00")  ' 转换为字符串格式
                  
-                 .Cells(i, j).Formula = "=计算新IRR(""" & 参数类型 & """," & 变化率 & ",""全投资"")"
+                 .Cells(i, j).Formula = "=计算新IRR(""" & 参数类型 & """, " & 变化率 & ", ""全投资"")"
              Next j
          Next i
                  End Select
                  
-                 变化率 = (j - 4) * 0.05  ' -10%, -5%, 0%, 5%, 10%
+                 变化率 = Format((j - 4) * 0.05, "0.00")  ' 转换为字符串格式
                  
-                 .Cells(i, j).Formula = "=计算新IRR(""" & 参数类型 & """," & 变化率 & ",""资本金"")"
+                 .Cells(i, j).Formula = "=计算新IRR(""" & 参数类型 & """, " & 变化率 & ", ""资本金"")"
              Next j
          Next i
          
          ' 敏感性系数计算
          For i = 24 To 26
-             .Cells(i, 2).Formula = "=(F" & (i - 13) & "-B" & (i - 13) & ")/(0.1*2)"  ' 全投资IRR敏感性系数
-             .Cells(i, 3).Formula = "=(F" & (i - 6) & "-B" & (i - 6) & ")/(0.1*2)"    ' 资本金IRR敏感性系数
+             .Cells(i, 2).Formula = "=IF(B" & (i - 13) & "<>0,((F" & (i - 13) & "-B" & (i - 13) & ")/B" & (i - 13) & ")/(0.1*2),0)"  ' 全投资IRR敏感性系数
+             .Cells(i, 3).Formula = "=IF(B" & (i - 6) & "<>0,((F" & (i - 6) & "-B" & (i - 6) & ")/B" & (i - 6) & ")/(0.1*2),0)"    ' 资本金IRR敏感性系数
          Next i
      End With
```

---



我对代码进行了以下主要修改：

1. 修改了 `AddFormulas` 的参数传递方式，使用 `ByVal ws As Worksheet` 作为参数
2. 将变量声明移到过程开始处，避免重复声明
3. 将 `变化率` 改为字符串类型，并使用 `Format` 函数格式化数值
4. 在公式字符串中添加了适当的空格，使参数分隔更清晰
5. 改进了敏感性系数的计算公式，添加了除零保护
6. 使用 `Call` 语句明确调用 `AddFormulas` 过程

现在代码应该可以正常运行了。主要的改进包括：

1. 参数传递更规范
2. 数值格式化更准确
3. 公式构建更清晰
4. 添加了错误处理（除零保护）

您可以尝试重新运行这个宏，看看是否还有其他问题。如果还有任何错误，请告诉我具体的错误信息，我会继续帮您修改。

---



---

